
(function(){var mods=[],version=parseFloat(seajs.version);define(["lib","common","$","main","weixin_css","disk_css","uploadbox_css"],function(require,exports,module){var uri=module.uri||module.id,m=uri.split('?')[0].match(/^(.+\/)([^\/]*?)(?:\.js)?$/i),root=m&&m[1],name=m&&('./'+m[2]),i=0,len=mods.length,curr,args,undefined;for(;i<len;i++){args=mods[i];if(typeof args[0]==='string'){name===args[0]&&(curr=args[2]);args[0]=root+args[0].replace('./','');(version>1.0)&&define.apply(this,args);}}
mods=[];require.get=require;return typeof curr==='function'?curr.apply(this,arguments):require;});define.pack=function(){mods.push(arguments);(version>1.0)||define.apply(null,arguments);};})();define.pack("./disk",["lib","common","$","./tmpl","./ui","./toolbar.toolbar","./file_list.file_list","./file_path.file_path","./view_switch.view_switch","./upload.upload_route"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),events=lib.get('./events'),Module=common.get('./module'),user_log=common.get('./user_log'),global_event=common.get('./global.global_event'),tmpl=require('./tmpl'),slice=[].slice,downloader,undefined;var disk=new Module('disk',{ui:require('./ui'),render_sub:function(sub_module,arg1,arg2){try{var args=slice.call(arguments,1);sub_module.render.apply(sub_module,args);this.add_sub_module(sub_module);}
catch(e){console.error('disk.js:初始化 '+sub_module.module_name+' 模块失败:\n',e.message,'\n',e.stack);}
return this;}});disk.on('render',function(){var
ui=this.ui,toolbar=require('./toolbar.toolbar'),file_list=require('./file_list.file_list'),file_path=require('./file_path.file_path'),view_switch=require('./view_switch.view_switch'),upload_route=require('./upload.upload_route');this.render_sub(toolbar,ui.get_$toolbar()).render_sub(file_list,ui.get_$view(),ui.get_$column_model()).render_sub(file_path,ui.get_$file_path()).render_sub(view_switch,ui.get_$view_switch()).render_sub(upload_route,ui.get_$toolbar().find('[data-action=reload]')).on('activate',function(){if(!downloader){require.async('downloader',function(mod){downloader=mod;});}});this.listenTo(toolbar,'start_download',function(e){if(downloader){var files=file_list.get_selected_files();downloader.down(files,e);user_log('disk_toolbar_download');global_event.trigger('disk_start_down_files');}else{console.log('downloader未初始化');}});});module.exports=disk;});define.pack("./file.article_node",["$","./file.file_node"],function(require,exports,module){var $=require('$'),FileNode=require('./file.file_node'),undef;var ArticleNode=function(options){options.is_dir=false;FileNode.call(this,options);this._title=options.title;this._url=options.url;this._raw_url=options.raw_url;this._thumb=options.thumb;};ArticleNode.prototype=$.extend({},FileNode.prototype,{class_name:'ArticleNode',_title:'',_desc:'',_url:'',_raw_url:'',_thumb:'',get_url:function(){return this._url;},get_raw_url:function(){return this._raw_url;},get_thumb:function(){return this._thumb;},get_title:function(){return this._title},get_desc:function(){return this._desc}});ArticleNode.is_instance=function(obj){return obj&&obj instanceof ArticleNode;};return ArticleNode;});define.pack("./file.file_node",["lib","common","$","./file.utils.all_file_map"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),File=common.get('./file.file_object'),constants=common.get('./constants'),all_file_map=require('./file.utils.all_file_map'),undefined;var FileNode=function(options){var me=this;File.apply(me,arguments);me._parent=me._kid_nodes=me._kid_map=me._kid_files=me._kid_dirs=null;me._is_super=options.is_super===true;me._is_vir_dir=!!options.is_vir_dir;var id_suffix=me.get_id().substr(8);me._is_qq_disk_dir=id_suffix===constants.QQDISK_DIR_ID;me._is_net_fav_dir=id_suffix===constants.NET_FAV_DIR_ID;if(me._is_super||me._is_qq_disk_dir||me._is_net_fav_dir){me._is_movable=false;me._is_removable=false;}
if(me._is_vir_dir){me._is_downable=false;me._is_removable=false;me._is_movable=false;me._is_renamable=false;me._is_draggable=false;me._is_droppable=false;me._is_selectable=false;me.set_modify_time('');me.set_create_time('');}
me._has_image=!!options.has_image;me._has_video=!!options.has_video;me._has_text=!!options.has_text;me._has_voice=!!options.has_voice;me._has_article=!!options.has_article;};FileNode.prototype=$.extend({},File.prototype,{_is_file_node_instance:true,class_name:'FileNode',set_parent:function(parent){this._parent=parent;this._pid=parent?parent.get_id():null;},is_on_tree:function(){return all_file_map.get(this.get_id())===this;},is_super:function(){return this._is_super;},is_vir_dir:function(){return this._is_vir_dir;},is_vir_node:function(){var node=this;do{if(node.is_vir_dir()){return true;}}while(node=node.get_parent());return false;},is_qq_disk_dir:function(){return this._is_qq_disk_dir;},is_net_fav_dir:function(){return this._is_net_fav_dir;},has_image:function(){return this._has_image},has_video:function(){return this._has_video},has_text:function(){return this._has_text},has_voice:function(){return this._has_voice},has_article:function(){return this._has_article},mark_create_success:function(data){var old_id,new_id;if(this.is_tempcreate()){old_id=this.get_id();new_id=data.id;this.set_name(data.name);this.set_create_time(data.create_time);this.set_modify_time(data.modify_time);this._is_tempcreate=false;if(old_id!==new_id){this._id=new_id;var par=this.get_parent(),par_kid_map=this.get_parent().get_kid_map()
this.set_parent(par);delete par_kid_map[old_id];par_kid_map[new_id]=this;all_file_map.remove(old_id);all_file_map.set(new_id,this);return old_id;}}},get_parent:function(){return this._parent;},get_kid_nodes:function(){return this._kid_nodes;},get_kid_map:function(){return this._kid_map;},get_kid_dirs:function(){return this._kid_dirs;},get_kid_files:function(){return this._kid_files;},get_node:function(id){return id?this._kid_map[id]:null;},set_nodes:function(dirs,files){if(!files&&!dirs){return;}
var me=this;me.clear_nodes();this._kid_nodes=[];this._kid_dirs=[];this._kid_files=[];this._kid_map={};$.each([dirs,files],function(i,new_nodes){if(new_nodes&&new_nodes.length){$.each(new_nodes,function(j,node){me.append_node(node);var kid_dirs=node.get_kid_dirs(),kid_files=node.get_kid_files();if((kid_dirs&&kid_dirs.length)||(kid_files&&kid_files.length)){node.set_nodes(kid_files,kid_dirs);}});}});},add_node:function(node,before){var id=node.get_id();var exists_node=all_file_map.get(id);if(exists_node&&exists_node.get_parent()!==this){exists_node.get_parent().remove_nodes([exists_node]);}
all_file_map.set(id,node);node.set_parent(this);var kid_nodes=this._kid_nodes||(this._kid_nodes=[]),kid_dirs=this._kid_dirs||(this._kid_dirs=[]),kid_files=this._kid_files||(this._kid_files=[]),kid_map=this._kid_map||(this._kid_map={});if(kid_map[id]){replace_node(kid_nodes,node)&&replace_node(node.is_dir()?kid_dirs:kid_files,node);}
else{kid_nodes.push(node);var insert_to=node.is_dir()?kid_dirs:kid_files;if(typeof before==='boolean'){before=before?0:insert_to.length;}
if(typeof before==='string'){before=all_file_map.get(before);}
if(FileNode.is_instance(before)){before=$.inArray(before,insert_to);}
before=before>=0&&before<=insert_to.length?before:insert_to.length;insert_to.splice(before,0,node);}
kid_map[id]=node;},prepend_node:function(node){this.add_node(node,true);},append_node:function(node){this.add_node(node,false);},set_dirty:function(dirty){if(typeof dirty!=='boolean'){console.error('无效的参数 dirty=',dirty);}
this._is_dirty=!!dirty;},remove:function(){var parent=this.get_parent();if(parent){parent.remove_nodes(this);}},remove_nodes:function(rem_kid_nodes){if(!rem_kid_nodes)return;var kid_nodes=this._kid_nodes,kid_map=this._kid_map;if(kid_nodes&&kid_nodes.length){var kid_files=this._kid_files,kid_dirs=this._kid_dirs;if(!(rem_kid_nodes instanceof Array)){rem_kid_nodes=[rem_kid_nodes];}
var is_id_arr=typeof rem_kid_nodes[0]==='string',removal_nodes_set=is_id_arr?collections.array_to_set(rem_kid_nodes):collections.array_to_set(rem_kid_nodes,function(node){return node.get_id();});$.each(rem_kid_nodes,function(i,rem_kid_node){rem_kid_node.set_parent(null);rem_kid_node.remove_from_global();});var i;for(i=kid_nodes.length-1;i>=0;i--){var node=kid_nodes[i];if(node.get_id()in removal_nodes_set){kid_nodes.splice(i,1);delete kid_map[node.get_id()];}}
if(kid_files&&kid_files.length){for(i=kid_files.length-1;i>=0;i--){if(kid_files[i].get_id()in removal_nodes_set){kid_files.splice(i,1);}}}
if(kid_dirs&&kid_dirs.length){for(i=kid_dirs.length-1;i>=0;i--){if(kid_dirs[i].get_id()in removal_nodes_set){kid_dirs.splice(i,1);}}}}},clear_nodes:function(){if(this._kid_nodes&&this._kid_nodes.length){$.each(this._kid_nodes,function(i,node){node.set_parent(null);node.remove_from_global();});this._kid_nodes=this._kid_map=this._kid_files=this._kid_dirs=null;}},remove_from_global:function(){all_file_map.remove(this.get_id());var kids=this.get_kid_nodes();if(kids&&kids.length){$.each(kids,function(i,kid){all_file_map.remove(kid.get_id());});}}});FileNode.is_instance=function(obj){if(!obj)
return false;return obj._is_file_node_instance;};var replace_node=function(arr,node){var id=node.get_id();for(var i=0,l=arr.length;i<l;i++){if(id===arr[i].get_id()){arr.splice(i,1,node);return true;}}
return false;};return FileNode;});define.pack("./file.plaintext_node",["$","./file.file_node"],function(require,exports,module){var $=require('$'),FileNode=require('./file.file_node'),undef;var PlaintextNode=function(options){options.is_dir=false;FileNode.call(this,options);this._content=options.content;};PlaintextNode.prototype=$.extend({},FileNode.prototype,{_content:'',class_name:'PlaintextNode',get_content:function(){return this._content;}});PlaintextNode.is_instance=function(obj){return obj&&obj instanceof PlaintextNode;};return PlaintextNode;});define.pack("./file.utils.all_file_map",[],function(require,exports,module){var map={};module.exports={get:function(id){return map[id];},get_all:function(ids){var arr=[];if(ids&&ids.length){for(var i=0,l=ids.length;i<l;i++){var f=this.get(ids[i]);if(f){arr.push(f);}}}
return arr;},set:function(id,f){map[id]=f;return f;},remove:function(id){var f=map[id];delete map[id];return f;}};});define.pack("./file.utils.file_factory",["$","./file.utils.all_file_map","./file.file_node","./file.plaintext_node","./file.voice_node","./file.article_node"],function(require,exports,module){var $=require('$'),all_file_map=require('./file.utils.all_file_map'),FileNode=require('./file.file_node'),PlaintextNode=require('./file.plaintext_node'),VoiceNode=require('./file.voice_node'),ArticleNode=require('./file.article_node'),classes={FileNode:FileNode,PlaintextNode:PlaintextNode,VoiceNode:VoiceNode,ArticleNode:ArticleNode},undef;module.exports={create:function(Class,options){return new classes[Class](options);},create_from_cgi:function(type,data){var Class=typeof type==='string'?classes[type]:type;return Class.from_cgi(data);}};});define.pack("./file.utils.file_node_from_cgi",["lib","common","./file.utils.file_factory"],function(require,exports,module){var lib=require('lib'),common=require('common'),collections=lib.get('./collections'),file_factory=require('./file.utils.file_factory'),parse_file=common.get('./file.parse_file'),parse_int=parseInt,e=[],cgi_file_adapters={ArticleNode:function(obj,p_node){if(p_node.has_article()&&'title'in obj&&'content'in obj&&'thumb'in obj){return file_factory.create('ArticleNode',{id:obj['msgid'],title:obj['title'],desc:obj['abstract'],url:obj['content'],raw_url:obj['raw_url'],thumb:obj['thumb'],create_time:obj['ctime']});}},PlaintextNode:function(obj,p_node){if(p_node.has_text()&&'content'in obj&&obj['type']==1){return file_factory.create('PlaintextNode',{id:obj['msgid'],content:obj['content'],create_time:obj['ctime']});}},VoiceNode:function(obj,p_node){if(p_node.has_voice()&&'tmlong'in obj&&'content'in obj&&obj['type']==2){return file_factory.create('VoiceNode',{id:obj['msgid'],url:obj['content'],duration:obj['tmlong'],create_time:obj['ctime']});}},FileNode:function(obj,p_node){if('file_id'in obj||'dir_key'in obj||'dir_attr'in obj||'file_attr'in obj){var par_is_vir_dir=p_node.is_vir_dir(),is_dir='dir_key'in obj||'dir_attr'in obj;if(par_is_vir_dir&&is_dir){return file_node_from_cgi.vir_dir_from_cgi(obj);}
else if(is_dir){return file_node_from_cgi.dir_from_cgi(obj);}
else{return file_node_from_cgi.file_from_cgi(obj);}}}};var file_node_from_cgi={from_cgi:function(body,p_node){var files=[];for(var p in body){var arr=body[p]||e;if(arr instanceof Array){for(var i=0,l=arr.length;i<l;i++){for(var type in cgi_file_adapters){var file=cgi_file_adapters[type](arr[i],p_node);if(file){files.push(file);break;}}}}}
return files;},vir_dir_from_cgi:function(obj){var options={is_dir:true,is_vir_dir:true,id:obj['dir_key'],name:obj['dir_name'],create_time:obj['dir_ctime'],modify_time:obj['dir_mtime'],icon:obj['dir_icon'],is_sortable:false};var cgi_types=obj['dir_data_type'];if(cgi_types){if(cgi_types.indexOf('picture')>-1){options.has_image=true;}
if(cgi_types.indexOf('video')>-1){options.has_video=true;}
if(cgi_types.indexOf('audio')>-1){options.has_voice=true;}
if(cgi_types.indexOf('text')>-1){options.has_text=true;}
if(cgi_types.indexOf('article')>-1){options.has_article=true;}}
return file_factory.create('FileNode',options);},vir_dirs_from_cgi:function(arr){return map(arr,function(obj){return this.vir_dir_from_cgi(obj);},this);},dir_from_cgi:function(obj){var is_plain=!('dir_attr'in obj||'file_attr'in obj);if(is_plain){obj={is_dir:true,id:obj['dir_key'],name:obj['dir_name'],create_time:obj['dir_ctime'],modify_time:obj['dir_mtime']}}else{var attr=obj['dir_attr'];obj={is_dir:true,id:obj['dir_key'],name:attr['dir_name'],create_time:obj['dir_ctime'],modify_time:attr['dir_mtime']};}
return file_factory.create('FileNode',obj);},dirs_from_cgi:function(arr){return map(arr,function(obj){return this.dir_from_cgi(obj);},this);},file_from_cgi:function(obj){var is_plain=!('dir_attr'in obj||'file_attr'in obj);if(is_plain){obj={is_dir:false,is_vir_dir:false,id:obj['file_id'],name:obj['file_name'],size:parse_int(obj['file_size'])||0,cur_size:parse_int(obj['file_cur_size'])||0,create_time:obj['file_ctime'],modify_time:obj['file_mtime'],file_md5:obj['file_md5'],file_sha:obj['file_sha'],file_ver:obj['file_ver']}}else{var attr=obj['file_attr'];obj={id:obj['file_id'],name:attr['file_name'],size:parse_int(obj['file_size'])||0,cur_size:parse_int(obj['file_cur_size'])||0,create_time:obj['file_ctime'],modify_time:attr['file_mtime'],file_md5:obj['file_md5'],file_sha:obj['file_sha'],file_ver:obj['file_ver']};}
return file_factory.create('FileNode',obj);},files_from_cgi:function(arr){return map(arr,function(obj){return this.file_from_cgi(obj);},this);}};var map=function(arr,fn,context){var ret=[],l;if(arr&&(l=arr.length)){for(var i=0;i<l;i++){var obj=fn.call(context,arr[i]);if(obj!=null){ret[i]=obj;}}}
return ret;};return file_node_from_cgi;});define.pack("./file.voice_node",["$","./file.file_node"],function(require,exports,module){var $=require('$'),FileNode=require('./file.file_node'),undef;var VoiceNode=function(options){options.is_dir=false;FileNode.call(this,options);this._url=options.url;this._duration=options.duration;};VoiceNode.prototype=$.extend({},FileNode.prototype,{_url:'',_duration:0,class_name:'VoiceNode',get_url:function(){return this._url;},get_duration:function(){return this._duration;}});VoiceNode.is_instance=function(obj){return obj&&obj instanceof VoiceNode;};return VoiceNode;});define.pack("./file_list.file_list",["lib","common","$","./file.utils.file_factory","./file.utils.all_file_map","./file.utils.file_node_from_cgi","main","./file_list.ui","./file_list.file_processor.remove.remove","./file_list.file_processor.move.move","./file_list.selection.selection"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),events=lib.get('./events'),security=lib.get('./security'),text=lib.get('./text'),constants=common.get('./constants'),Module=common.get('./module'),query_user=common.get('./query_user'),user_log=common.get('./user_log'),cgi_ret_report=common.get('./cgi_ret_report'),request=common.get('./request'),urls=common.get('./urls'),global_event=common.get('./global.global_event'),disk_event=common.get('./global.global_event').namespace('disk'),global_function=common.get('./global.global_function'),global_variable=common.get('./global.global_variable'),ret_msgs=common.get('./ret_msgs'),m_speed=common.get('./m_speed'),file_factory=require('./file.utils.file_factory'),all_file_map=require('./file.utils.all_file_map'),file_node_from_cgi=require('./file.utils.file_node_from_cgi'),selection,remove,move,space_info=require('main').get('./space_info.space_info'),long_long_ago='2000-01-01 01:01:01',super_node,root_node,dir_QQ,dir_QQ_recv,curr_node,last_node,last_load_req,first_loaded,weixin_node,undefined;var file_list=new Module('disk_file_list',{ui:require('./file_list.ui'),render:function(){remove=require('./file_list.file_processor.remove.remove');move=require('./file_list.file_processor.move.move');selection=require('./file_list.selection.selection');this.add_sub_module(remove);this.add_sub_module(move);this.add_sub_module(selection);this.listenTo(remove,'has_removed',function(file_ids){var nodes=all_file_map.get_all(file_ids);this.remove_nodes(nodes,true,true);}).listenTo(move,'has_moved',function(file_ids,par_id,dir_id){var file_nodes=all_file_map.get_all(file_ids);this.move_nodes(file_nodes,dir_id);});this.on('append_node prepend_node',function(dirs,files){var sum_size=0;files&&files.length&&$.each(files,function(i,node){sum_size+=node.get_size();});if(sum_size>0){space_info.add_used_space_size(sum_size);}});this.on('activate',function(){var me=this,restore_ids=global_variable.del('recycle_restored_ids'),restore_msg=global_variable.del('recycle_restored_msg'),restore_is_ok=global_variable.del('recycle_restored_is_ok'),load_from_cache=!restore_ids||restore_ids.length==0;me.trigger('external_insert_files',restore_ids,restore_msg,restore_is_ok);me.reload(load_from_cache,false,false);space_info.refresh();});},_init_root:function(user){super_node=file_factory.create('FileNode',{id:user.get_root_key(),is_super:true});root_node=file_factory.create('FileNode',{id:user.get_main_key(),name:'微云',create_time:long_long_ago,modify_time:long_long_ago,is_dir:true});curr_node=root_node;last_node=undefined;super_node.set_nodes([root_node],null);},load:function(node,from_cache,reset_ui){if(typeof node==='string'){node=all_file_map.get(node);}
if(node.get_id()===this.get_root_node().get_id()){return this.load_root(from_cache,reset_ui);}
else if(node.is_vir_dir()){return this.load_vir_dir(node,0,400);}
if(!node){console.error('file_list.load()无效的目录节点:',node);return null;}
var data={pdir_key:node.get_pid(),dir_key:node.get_id(),dir_mtime:long_long_ago,only_dir:0};var data_handler=function(body){var dirs=file_node_from_cgi.dirs_from_cgi(body['dirs']),files=file_node_from_cgi.files_from_cgi(body['files']);return[dirs,files];};return this._load_node(null,'get_dir_list',data_handler,data,node,from_cache,reset_ui);},load_root:function(from_cache,reset_ui){var user=query_user.get_cached_user();if(!user){return;}
if(!root_node){this._init_root(user);}
var data_handler=function(body){var _vir_dirs=file_node_from_cgi.vir_dirs_from_cgi(body['virtual_dirs']),_dirs=file_node_from_cgi.dirs_from_cgi(body['dirs']);var dirs=[].concat(_vir_dirs,_dirs),files=file_node_from_cgi.files_from_cgi(body['files']);return[dirs,files]};var def=this._load_node('http://web.cgi.weiyun.com/weiyun_web_root_dir_list_cgi.fcg','root_dir_list',data_handler,null,this.get_root_node(),from_cache,reset_ui);if(def&&!first_loaded){try{m_speed.start('disk','root_list_show');}
catch(e){}}
return def;},_load_node:function(url,cmd,data_handler,data,node,from_cache,reset_ui){reset_ui=reset_ui===true;from_cache=from_cache===true;var me=this,def=$.Deferred();last_node=curr_node;curr_node=node;me.trigger('before_load',node,last_node,reset_ui);if(from_cache&&node.get_kid_nodes()!=null&&!node.is_dirty()){def.resolve(node);me.trigger('load',node,last_node,reset_ui);disk_event.trigger('file_list_load',node);}else{me.trigger('before_async_load');if(last_load_req){last_load_req.destroy();}
last_load_req=request.get({url:url,cmd:cmd,body:data,cavil:true,resend:true}).ok(function(msg,body){node.set_dirty(false);var dirs_files=data_handler.call(body,body,node);node.set_nodes(dirs_files[0],dirs_files[1]);def.resolve(node);me.trigger('load',node,last_node,reset_ui);disk_event.trigger('file_list_load',node);}).fail(function(msg,ret){me.trigger('error',msg,ret);def.reject(msg,ret);}).done(function(){me.trigger('after_async_load');if(!first_loaded){first_loaded=true;me.trigger('first_load_done');}
last_load_req=null;});}
return def;},load_vir_dir:function(node,offset,size){offset=offset||0;if(typeof node==='string'){node=all_file_map.get(node);}
if(!node){console.error('file_list.load_vir_dir()无效的目录节点:',node);return null;}
var data={pdir_key:node.get_pid(),dir_key:node.get_id(),dir_mtime:long_long_ago,sort_type:0,list_type:0,offset:offset,number:size||400};var me=this,def=$.Deferred();last_node=curr_node;curr_node=node;me.trigger('before_load',node,last_node,offset===0);me.trigger('before_async_load',node);if(last_load_req){last_load_req.destroy();}
last_load_req=request.get({url:'http://web.cgi.weiyun.com/weiyun_web_vircgi.fcg',cmd:'get_virtual_dir_list',body:data,cavil:true,resend:true}).ok(function(msg,body){var files=file_node_from_cgi.from_cgi(body,node),total=body['total']||0,is_reload=offset===0,_dirs=[],_files=[];$.each(files,function(i,file){(file.is_dir()?_dirs:_files).push(file);});if(is_reload){node.set_nodes(_dirs,_files);}
else{$.each(files,function(i,file){node.append_node(file);});}
def.resolve(node);me.trigger('load',node,last_node,_dirs,_files,is_reload,total);disk_event.trigger('file_list_load',node);}).fail(function(msg,ret){me.trigger('error',msg,ret);def.reject(msg,ret);}).done(function(){me.trigger('after_async_load');if(!first_loaded){first_loaded=true;me.trigger('first_load_done');}
last_load_req=null;});return def;},reload:function(from_cache,reset_ui,reload_root){var me=this;from_cache=from_cache===true;reload_root=reload_root===true;var node=this.get_cur_node();query_user.get(false,true).ok(function(){if(node&&!reload_root){if(node.is_dirty()){from_cache=false;}
if(node.get_id()===me.get_root_node().get_id()){me.load_root(from_cache,reset_ui);}else{me.load(node,from_cache,reset_ui);}}
else{me.load_root(from_cache,reset_ui);}});},is_first_loaded:function(){return first_loaded;},prepend_node:function(node,cover,target_dir_id){this._add_node(node,cover,target_dir_id,'prepend_node');},append_node:function(node,cover,target_dir_id){this._add_node(node,cover,target_dir_id,'append_node');},add_node:function(node,cover,target_dir_id,index){this._add_node(node,cover,target_dir_id,'add_node',[index]);},_add_node:function(node,cover,target_dir_id,method,method_argus){if(!target_dir_id){if(curr_node){target_dir_id=curr_node.get_id();}else{target_dir_id=root_node.get_id();}}
var cur_node=this.get_cur_node(),target_node=all_file_map.get(target_dir_id);if(target_node){if(cover){var cover_node=this._get_node_by_name(node.get_name(),node.is_dir());if(cover_node){this.remove_nodes([cover_node],false,false);}}
target_node[method].apply(target_node,[node].concat(method_argus));target_node.set_dirty(true);if(cur_node&&cur_node.get_id()===target_node.get_id()){var dirs=[],files=[];(node.is_dir()?dirs:files)[0]=node;this.trigger.apply(this,[method,dirs,files].concat(method_argus));}}},enter_qq_receive:function(refresh,callback){callback=callback||$.noop;var me=this,load_from_cache=!refresh,load_then_callback=function(){var def=me.load(dir_QQ_recv,load_from_cache,false);if(def){def.done(function(node){callback(node,node.get_parent());});}},enter_then_callback=function(){me._get_qq_receive(function(){load_then_callback();});};if(this.is_first_loaded()){if(load_from_cache&&dir_QQ_recv&&dir_QQ_recv.get_id()===this.get_cur_node().get_id()){callback(dir_QQ,dir_QQ_recv);}
else if(dir_QQ&&dir_QQ.is_on_tree()&&dir_QQ_recv&&dir_QQ_recv.is_on_tree()){load_then_callback();}
else{enter_then_callback();}}
else{this.once('load',function(){enter_then_callback();});}},_get_qq_receive:function(ok){var fn=arguments.callee;fn._ok_callbacks||(fn._ok_callbacks=[]);ok&&fn._ok_callbacks.push(ok);if(fn._loading){return;}
fn._loading=true;var me=this,ok_callback=function(dir_QQ,dir_QQ_recive){$.each(fn._ok_callbacks,function(i,cb){cb.call(me,dir_QQ,dir_QQ_recive);});delete fn._ok_callbacks;},cgi_report=function(ret){clearTimeout(timer);cgi_ret_report.report(cgi,'',ret);},cgi='http://api.weiyun.com/get_home_list',timer=setTimeout(function(){fn._loading=false;if(req){req.abort();me.trigger('error',ret_msgs.get(ret_msgs.TIMEOUT_CODE),ret_msgs.TIMEOUT_CODE);cgi_report(ret_msgs.TIMEOUT_CODE);}},5000);var req=$.ajax({url:urls.make_url(cgi,{appid:30207,token:security.getAntiCSRFToken(),real_source:10006,auto_create:1,req_type:'JSONP'}),dataType:'jsonp',just_plain_url:true}).done(function(json){fn._loading=false;var data=json.data,ret=json.ret;if(!json.data||ret!==0){console.error('获取「QQ收到的文件」目录失败:',ret);var msg=ret_msgs.get(ret);me.trigger('error',msg,ret);}
else{var
qq_dir_key=data['parent_dir_key'],qq_dir_name=data['pdir_name'],qq_recv_dir_key=data['dir_key'],qq_recv_dir_name=data['dir_name']||'QQ收到的文件';dir_QQ=all_file_map.get(qq_dir_key);if(!dir_QQ){dir_QQ=file_factory.create('FileNode',{is_dir:true,id:qq_dir_key,name:qq_dir_name,create_time:long_long_ago,modify_time:long_long_ago});me.get_root_node().append_node(dir_QQ);}
dir_QQ_recv=all_file_map.get(qq_recv_dir_key);if(!dir_QQ_recv){dir_QQ_recv=file_factory.create('FileNode',{is_dir:true,id:qq_recv_dir_key,name:qq_recv_dir_name||'QQ收到的文件',create_time:long_long_ago,modify_time:long_long_ago});dir_QQ.append_node(dir_QQ_recv);}
dir_QQ_recv.set_dirty(true);dir_QQ.set_dirty(true);me.get_root_node().set_dirty(true);ok_callback(dir_QQ,dir_QQ_recv);}
cgi_report(ret);});},get_cur_node:function(){return curr_node;},get_last_node:function(){return last_node;},is_cur_node:function(node){if(typeof node==='string'){node=all_file_map.get(node);}
return this.get_cur_node().get_id()===node.get_id();},get_root_node:function(){return root_node;},get_node_by_$item:function($item){var file_id=$($item).attr('data-file-id');return all_file_map.get(file_id);},remove_nodes:function(file_nodes,refresh_space_info,animate){if(file_nodes.length){var file_nodes_for_ui=this._grep_kids(file_nodes);$.each(file_nodes,function(i,node){node.remove();});this.trigger('after_nodes_removed',file_nodes_for_ui,refresh_space_info,animate);}},move_nodes:function(file_nodes,dir_id){if(file_nodes.length){var file_nodes_for_ui=this._grep_kids(file_nodes);$.each(file_nodes,function(i,node){node.remove();});this.trigger('after_nodes_moved',file_nodes_for_ui,dir_id);var target_node=all_file_map.get(dir_id);if(target_node){target_node.set_dirty(true);}}},get_selected_file_ids:function(){if(selection){return selection.get_selected_file_ids();}else{return[];}},get_selected_files:function(){if(selection){return selection.get_selected_files();}else{return[];}},silent_remove_file_in_serv:function(dir_id,file_id,file_name){var target_dir=all_file_map.get(dir_id);if(target_dir){remove.silent_remove(target_dir,file_id,file_name);}},_get_node_by_name:function(name,is_dir){var cur_node=this.get_cur_node();if(cur_node){var kid_nodes=is_dir?cur_node.get_kid_dirs():cur_node.get_kid_files();for(var i=kid_nodes.length-1;i>=0;i--){var kid_node=kid_nodes[i];if(kid_node.get_name()===name){return kid_node;}}}},_grep_kids:function(file_nodes){var cur_node=this.get_cur_node();if(cur_node){return collections.grep(file_nodes,function(node){var parent=node.get_parent();if(!parent){return false;}
return parent.get_id()===cur_node.get_id();});}else{return file_nodes;}}});module.exports=file_list;});define.pack("./file_list.file_processor.move.move",["lib","common","$","./file.utils.file_node_from_cgi","./tmpl","./file_list.file_processor.move.ui"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),Module=common.get('./module'),request=common.get('./request'),RequestTask=common.get('./request_task'),global_event=common.get('./global.global_event'),user_log=common.get('./user_log'),query_user=common.get('./query_user'),file_node_from_cgi=require('./file.utils.file_node_from_cgi'),tmpl=require('./tmpl'),long_long_ago='1970-01-01 00:00:00',undefined;var move=new Module('disk_file_move',{ui:require('./file_list.file_processor.move.ui'),show_move_to:function(files,op){this.trigger('show_move_to',files,op);},start_move:function(files,par_id,dir_id,op){var me=this,mover=new Mover(files,par_id,dir_id,op);mover.on('start',function(){me.trigger('start');}).on('step',function(cursor,length){me.trigger('step',cursor,length);}).on('has_ok',function(ok_ids){me.trigger('has_moved',ok_ids,par_id,dir_id);global_event.trigger('disk_file_move_has_moved');}).on('all_ok',function(msg){me.trigger('all_moved',msg);global_event.trigger('disk_file_move_all_moved');}).on('part_ok',function(msg){me.trigger('part_moved',msg);}).on('error',function(msg){me.trigger('error',msg);}).on('done',function(){me.trigger('done');}).start();},load_sub_dirs:function(node_par_id,node_id){var me=this;me.trigger('before_load_sub_dirs',node_id);request.get({cmd:'get_dir_list',cavil:true,resent:true,body:{pdir_key:node_par_id,dir_key:node_id,dir_mtime:long_long_ago,only_dir:1}}).ok(function(msg,body){var dirs=file_node_from_cgi.dirs_from_cgi(body['dirs']);me.trigger('load_sub_dirs',dirs,node_id);}).fail(function(msg,ret){me.trigger('load_sub_dirs_error',msg,ret);}).done(function(){me.trigger('after_load_sub_dirs',node_id);});}});var Mover=function(files,target_par_id,target_dir_id,op){var proc_options={step_size:query_user.get_cached_user().get_files_move_step_size(),files:files,op:op,cmd_parser:function(frag_files){var first=frag_files[0];return first.is_dir()?'batch_folder_move':'batch_file_move';},data_parser:function(frag_files){var data={},encode=encodeURIComponent,first=frag_files[0];if(first.is_dir()){data['move_folders']=$.map(frag_files,function(file){return{dir_key:file.get_id(),src_pdir_key:file.get_parent().get_id(),src_ppdir_key:file.get_parent().get_parent().get_id(),dst_pdir_key:target_dir_id,dst_ppdir_key:target_par_id,folder_name:encode(file.get_name())};});}else{data['move_files']=$.map(frag_files,function(file){return{file_id:file.get_id(),src_pdir_key:file.get_parent().get_id(),src_ppdir_key:file.get_parent().get_parent().get_id(),dst_pdir_key:target_dir_id,dst_ppdir_key:target_par_id,file_attr:{file_name:encode(file.get_name())},src_file_name:encode(file.get_name())};});}
return data;}};RequestTask.call(this,proc_options);};$.extend(Mover.prototype,RequestTask.prototype);return move;});define.pack("./file_list.file_processor.move.ui",["lib","common","$","./tmpl","./file_list.file_processor.move.move","./file_list.file_list","./toolbar.toolbar"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),Module=common.get('./module'),progress=common.get('./ui.progress'),widgets=common.get('./ui.widgets'),request=common.get('./request'),user_log=common.get('./user_log'),mini_tip=common.get('./ui.mini_tip'),file_list,toolbar,tmpl=require('./tmpl'),move,MSG_ALREADY_IN='文件已经在该文件夹下了',MSG_NO_DEEP='不能将文件移动到自身或其子文件夹下',undefined;var ui=new Module('disk_file_move_ui',{render:function(){move=require('./file_list.file_processor.move.move');file_list=require('./file_list.file_list');toolbar=require('./toolbar.toolbar');this.listenTo(move,'step',function(cursor,length){progress.show(text.format('正在移动第{0}/{1}个文件',[cursor,length]));}).listenTo(move,'done',function(){progress.hide();}).listenTo(move,'all_moved',function(){mini_tip.ok('文件移动成功');}).listenTo(move,'error',function(msg){mini_tip.error(msg);}).listenTo(move,'part_moved',function(msg){mini_tip.warn('部分文件移动失败：'+msg);}).listenTo(move,'show_move_to',function(files,op){var box=new FileMoveBox(files,op);box.show();box.listenTo(move,'start',function(){box.close();});}).listenTo(move,'show_view',function(){this.show();});}});var FileMoveBox=function(files,op){var me=this;me._files=files;me._chosen_id=me._chosen_par_id=null;var root_dir=file_list.get_root_node(),root_id=root_dir.get_id(),root_par_id=root_dir.get_parent().get_id();me._$el=$(tmpl.file_move_box({files:files,root_dir:root_dir}));me._dialog=new widgets.Dialog({klass:'file-mv-box',title:'选择存储位置',destroy_on_hide:true,content:me._$el,buttons:['OK','CANCEL'],handlers:{OK:function(){if(me._chosen_id){move.start_move(me._files,me._chosen_par_id,me._chosen_id,op);}}}});me._dialog.on('render',function(){this.get_$body().on('click','li[data-file-id]',function(e){e.preventDefault();e.stopPropagation();var $dir=$(e.target).closest('[data-file-id]'),par_id=$dir.attr('data-file-pid'),dir_id=$dir.attr('data-file-id');me.toggle_expand($dir);me.set_chosen(par_id,dir_id);});me.listenTo(move,'load_sub_dirs',function(dir_nodes,par_id){this.render_$dirs_dom(dir_nodes,par_id);}).listenTo(move,'load_sub_dirs_error',function(msg){this._dialog.error_msg(msg);}).listenTo(move,'before_load_sub_dirs',function(dir_id){this.mark_loading(dir_id,true);}).listenTo(move,'after_load_sub_dirs',function(dir_id){this.mark_loading(dir_id,false);});}).on('show',function(){me.expand_load(root_par_id,root_id);}).on('hide',function(){me._$el.remove();me._files=this._chosen_id=this._chosen_par_id=this._$el=null;me.off().stopListening();});me.on('chosen',function(par_id,dir_id){var cur_node=file_list.get_cur_node(),cur_dir_id=cur_node?cur_node.get_id():undefined,err;if(dir_id==cur_dir_id){err=MSG_ALREADY_IN;}
else{var
$node=this.get_$node(dir_id),chosen_pids=collections.array_to_set($node.parentsUntil(me._$el,'[data-file-id]').andSelf(),function(it){return it.getAttribute('data-file-id');}),joined=collections.any(me._files,function(file){return file.get_id()in chosen_pids;});if(joined){err=MSG_NO_DEEP;}}
if(err){me._dialog.error_msg(err);}else{me._dialog.hide_msg();}
me._dialog.set_button_enable('OK',!err);});};FileMoveBox.prototype=$.extend({show:function(){this._dialog.show();this.trigger('show');},close:function(){if(this._dialog){this._dialog.hide();}
this.off().stopListening();},render_$dirs_dom:function(dirs,dir_par_id){var $dir=this.get_$node(dir_par_id);if($dir[0]){var $arrow=$dir.children('a');if(dirs.length>0){$dir.attr('data-loaded','true');var $dirs_dom=$(tmpl.file_move_box_node_list({files:dirs,par_id:dir_par_id}));$arrow.addClass('expand');$dirs_dom.hide().appendTo($dir).slideDown('fast');}
else{$arrow.children('._expander').css('visibility','hidden');}}},expand_load:function(par_id,dir_id){move.load_sub_dirs(par_id,dir_id);},toggle_expand:function($dir){$dir=$($dir);var par_id=$dir.attr('data-file-pid'),dir_id=$dir.attr('data-file-id'),$ul=$dir.children('ul'),loaded='true'===$dir.attr('data-loaded');if(loaded){var $arrow=$dir.children('a'),expanded=$arrow.is('.expand');if(expanded){$ul.stop(false,true).slideUp('fast',function(){$arrow.removeClass('expand');});}else{$ul.stop(false,true).slideDown('fast');$arrow.addClass('expand');}}
else{this.expand_load(par_id,dir_id);}},set_chosen:function(par_id,dir_id){if(this._chosen_id===dir_id&&this._chosen_par_id===par_id){return;}
if(this._chosen_id){this.get_$node(this._chosen_id).children('a').removeClass('selected');}
this._chosen_id=dir_id;this._chosen_par_id=par_id;this.get_$node(dir_id).children('a').addClass('selected');this.trigger('chosen',par_id,dir_id);},get_$node:function(dir_id){return $('#_file_move_box_node_'+dir_id);},mark_loading:function(dir_id,loading){this.get_$node(dir_id).children('a').toggleClass('loading',!!loading);}},events);return ui;});define.pack("./file_list.file_processor.remove.remove",["lib","common","$","./file.utils.all_file_map","./file_list.file_processor.remove.ui"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),Module=common.get('./module'),ret_msgs=common.get('./ret_msgs'),user_log=common.get('./user_log'),request=common.get('./request'),RequestTask=common.get('./request_task'),global_event=common.get('./global.global_event'),query_user=common.get('./query_user'),all_file_map=require('./file.utils.all_file_map'),undefined;var remove=new Module('disk_file_remove',{ui:require('./file_list.file_processor.remove.ui'),remove_confirm:function(files,op,white_mask){var me=this;var remover=new Remover(files,op);this.trigger('remove_confirm',files,remover,function(){me._start_remove(remover,white_mask);},function(){remover.destroy();});return remover;},start_remove:function(files,op,white_mask){var remover=new Remover(files,op);this._start_remove(remover,white_mask);return remover;},silent_remove:function(target_dir,file_id,file_name){if(target_dir){var target_par=target_dir.get_parent();if(target_par){var file_data={ppdir_key:target_par.get_id(),pdir_key:target_dir.get_id(),file_id:file_id,file_ver:'',file_name:encodeURIComponent(file_name)};request.get({cmd:'batch_file_delete',body:{del_files:[file_data]}});this.trigger('has_removed',[file_id]);}}},_start_remove:function(remover,white_mask){var me=this;remover.on('has_ok',function(removed_file_ids){me.trigger('has_removed',removed_file_ids);global_event.trigger('disk_file_remove_has_removed');}).on('all_ok',function(msg){me.trigger('all_removed',msg);global_event.trigger('disk_file_remove_all_removed');}).on('part_ok',function(msg){me.trigger('part_removed',msg);}).on('step',function(cursor,len){me.trigger('step',cursor,len,white_mask);}).on('done',function(){me.trigger('done');}).on('error',function(msg){me.trigger('error',msg);}).start();}});var Remover=function(files,op){var proc_options={step_size:query_user.get_cached_user().get_files_remove_step_size(),files:files,op:op,ok_rets:[0,1019,1020],cmd_parser:function(frag_files){var first=frag_files[0];return first.is_dir()?'batch_folder_delete':'batch_file_delete';},data_parser:function(frag_files){var data={},encode=encodeURIComponent,first=frag_files[0];var availableFiles=[];$.each(frag_files,function(index,file){file=all_file_map.get(file.get_id());if(file){availableFiles.push(file);}});if(first.is_dir()){data['del_folders']=$.map(availableFiles,function(file){return{ppdir_key:file.get_parent().get_pid(),pdir_key:file.get_pid(),dir_key:file.get_id(),flag:1,dir_name:encode(file.get_name())};});}else{data['del_files']=$.map(availableFiles,function(file){return{ppdir_key:file.get_parent().get_pid(),pdir_key:file.get_pid(),file_id:file.get_id(),file_ver:file.get_file_ver()||'',file_name:encode(file.get_name())};});}
return data;}};RequestTask.call(this,proc_options);};$.extend(Remover.prototype,RequestTask.prototype);return remove;});define.pack("./file_list.file_processor.remove.ui",["lib","common","$","./toolbar.toolbar","./file_list.file_processor.remove.remove"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),Module=common.get('./module'),progress=common.get('./ui.progress'),widgets=common.get('./ui.widgets'),mini_tip=common.get('./ui.mini_tip'),toolbar=require('./toolbar.toolbar'),undefined;var ui=new Module('disk_file_remove_ui',{render:function(){var remove=require('./file_list.file_processor.remove.remove');var me=this;me.listenTo(remove,'remove_confirm',function(files,remover,on_yes,on_no){var
unit=files.length>1?'些':'个',thing=collections.any(files,function(f){return!f.is_dir();})?'文件':'文件夹';widgets.confirm('删除文件',text.format('确定删除这{unit}{thing}吗？',{unit:unit,thing:thing}),text.smart_sub(files[0].get_name(),10)+(files.length>1?'  等'+files.length+'个'+thing:''),function(){on_yes(remover);},function(){on_no(remover);});}).listenTo(remove,'has_removed',function(){toolbar.switch_to_default();}).listenTo(remove,'all_removed',function(){mini_tip.ok('删除成功');}).listenTo(remove,'part_removed',function(msg){mini_tip.warn('部分文件删除失败：'+msg);}).listenTo(remove,'step',function(cursor,length,white_mask){var title=length===1?'正在删除&nbsp;&nbsp;':text.format('正在删除第{0}/{1}个文件',[cursor,length]);progress.show(title,false,white_mask);}).listenTo(remove,'done',function(){progress.hide();}).listenTo(remove,'error',function(msg){mini_tip.warn('文件删除失败：'+msg);})}});return ui;});define.pack("./file_list.file_processor.vir_remove.vir_remove",["lib","common","$"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),console=lib.get('./console'),text=lib.get('./text'),Module=common.get('./module'),widgets=common.get('./ui.widgets'),request=common.get('./request'),user_log=common.get('./user_log'),undef;var vir_remove=new Module('disk_file_list_vir_remove',{remove_confirm:function(node,thing,desc,op){var me=this,files=[node],unit=files.length>1?'些':'个',msg=text.format('确定删除这{unit}{thing}吗？',{unit:unit,thing:thing}),def=$.Deferred();widgets.confirm('删除文件',msg,desc,function(){me.remove(node,op,def);},function(){def.reject()});return def;},remove:function(node,op,def){def=def||$.Deferred();var data={ppdir_key:node.get_parent().get_pid(),pdir_key:node.get_pid(),files:[{file_id:node.get_id(),file_name:node.get_name()||''}]};request.get({url:'http://web.cgi.weiyun.com/weiyun_web_vircgi.fcg',cmd:'delete_virtual_file',body:data,cavil:true,resend:true}).ok(function(msg,body){node.remove();def.resolve();}).fail(function(msg,ret){def.reject(msg,ret);});if(op){user_log(op);}
return def;}});return vir_remove;});define.pack("./file_list.menu.menu",["lib","common","$","./file_list.menu.ui"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),Module=common.get('./module'),constants=common.get('./constants'),undefined;var menu=new Module('disk_file_menu',{ui:require('./file_list.menu.ui'),render:function(){this.listenTo(this.ui,'show_on',function(el){this.trigger('show_on',el);}).listenTo(this.ui,'hide',function(){this.trigger('hide');});},show_more_menu:function(el){this.trigger('show_more_menu',el);},show_context_menu:function(x,y){this.trigger('show_context_menu',x,y);}});return menu;});define.pack("./file_list.menu.ui",["lib","common","$","./file_list.file_list","./file_list.ui_normal","./file_list.menu.menu","./file_list.selection.selection","./file_list.share.share","./view_switch.view_switch","./file_list.file_processor.move.move","./file_list.rename.rename","./file_list.file_processor.remove.remove"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),Module=common.get('./module'),ContextMenu=common.get('./ui.context_menu'),progress=common.get('./ui.progress'),user_log=common.get('./user_log'),constants=common.get('./constants'),log_event=common.get('./global.global_event').namespace('log'),click_tj=common.get('./configs.click_tj'),mini_tip=common.get('./ui.mini_tip'),selection,share,file_list,file_list_ui_normal,menu,is_more,undefined;var ui=new Module('disk_file_menu_ui',{render:function(){var me=this;file_list=require('./file_list.file_list');file_list_ui_normal=require('./file_list.ui_normal');menu=require('./file_list.menu.menu');selection=require('./file_list.selection.selection');share=require('./file_list.share.share');me.context_menu=me._create_menu();me.listenTo(menu,'show_more_menu',function(el){this.show_more_menu(el);}).listenTo(menu,'show_context_menu',function(x,y){this.show_context_menu(x,y);}).listenTo(me.context_menu,'show show_on',function(){log_event.trigger('contextmenu_toggle',true);}).listenTo(me.context_menu,'hide',function(){log_event.trigger('contextmenu_toggle',false);});me.get_downloader();},_downloader:null,get_downloader:function(){var me=this;if(!me._downloader){require.async('downloader',function(mod){me._downloader=mod;});}
return me._downloader;},show_more_menu:function(el){is_more=true;var view_switch=require('./view_switch.view_switch'),file=file_list_ui_normal.get_file_by_$el($(el)),item_id_map=this._get_item_id_map([file],true);if(!$.isEmptyObject(item_id_map)){this.context_menu.show_on(el,file_list_ui_normal.get_$list_parent(),item_id_map,70,-19,18);}
else{this.context_menu.hide();}},show_context_menu:function(x,y){is_more=false;var files=selection.get_selected_files(),item_id_map=this._get_item_id_map(files,false);if(!$.isEmptyObject(item_id_map)){this.context_menu.show(x,y,item_id_map);}
else{this.context_menu.hide();}},_create_menu:function(){var me=this;var menu=new ContextMenu({items:[{id:'single_download',text:'下载',icon_class:'icon-download',group:'download',after_render:function($item){click_tj.with_$el($item,'RIGHTKEY_MENU_DOWNLOAD');},click:function(e){var files=selection.get_selected_files();if(files.length){if(me.get_downloader()){me.get_downloader().down(files,e);}}}},{id:'package_download',text:'下载',icon_class:'icon-download',group:'download',after_render:function($item){click_tj.with_$el($item,'RIGHTKEY_MENU_DOWNLOAD');},click:function(e){var files=selection.get_selected_files();if(files.length){if(me.get_downloader()){me.get_downloader().down(files,e);user_log('disk_contextmenu_download');}}}},{id:'mail_share',text:'邮件分享',icon_class:'icon-mail',group:'share',after_render:function($item){click_tj.with_$el($item,is_more?'MORE_MENU_MAIL_SHARE':'RIGHTKEY_MENU_MAIL_SHARE');var file=selection.get_selected_files()[0];if(file){var err=share.is_sharable(file);if(!err){var share_url=share.get_mail_url(file);$item.children('a').attr('href',share_url).attr('target','_blank');}}},click:function(){var file=selection.get_selected_files()[0];if(file){var err=share.is_sharable(file);if(err){mini_tip.warn(err);}}}},{id:'link_share',text:'链接分享',icon_class:'icon-share',group:'share',after_render:function($item){click_tj.with_$el($item,is_more?'MORE_MENU_LINK_SHARE':'RIGHTKEY_MENU_LINK_SHARE');},click:function(){var files=selection.get_selected_files();if(files){var err=share.is_link_sharable(files);if(!err){share.link_share(files);}else{mini_tip.warn(err);}}}},{id:'move',text:'移动',icon_class:'icon-move',group:'edit',after_render:function($item){!is_more&&click_tj.with_$el($item,'RIGHTKEY_MENU_MOVE');},click:function(){var files=selection.get_selected_files();if(files.length){var move=require('./file_list.file_processor.move.move');if(move){move.show_move_to(files,'disk_contextmenu_file_move');}}}},{id:'rename',text:'重命名',icon_class:'icon-edit',group:'edit',after_render:function($item){click_tj.with_$el($item,is_more?'MORE_MENU_RENAME':'RIGHTKEY_MENU_RENAME');},click:function(){var files=selection.get_selected_files();if(files.length){var rename=require('./file_list.rename.rename');rename.start_edit(files[0]);}}},{id:'remove',text:'删除',icon_class:'icon-del',group:'edit',after_render:function($item){click_tj.with_$el($item,is_more?'MORE_MENU_DELETE':'RIGHTKEY_MENU_DELETE');},click:function(){var files=selection.get_selected_files();if(files.length){var remove=require('./file_list.file_processor.remove.remove');remove.remove_confirm(files,'disk_contextmenu_file_remove');}}}]});menu.on('show_on',function(el){me.trigger('show_on',el);});menu.on('hide',function(){me.trigger('hide');});return menu;},_get_item_id_map:function(files,is_more_menu){if(!files||!files.length){return null;}
var usable_items={single_download:1,package_download:1,mail_share:1,link_share:1,move:1,rename:1,remove:1};var
has_broken=false,has_no_del=false,has_no_move=false,has_no_rename=false,has_no_down=false,multi=files.length>1,has_dir=false,only_1_file=!multi&&!files[0].is_dir();$.each(files,function(i,file){if(file.is_broken_file()){has_broken=true;}
if(!file.is_removable()){has_no_del=true;}
if(!file.is_movable()){has_no_move=true;}
if(!file.is_renamable()){has_no_rename=true;}
if(!file.is_downable()){has_no_down=true;}
if(file.is_dir()){has_dir=true;}});if(has_broken){usable_items={remove:1};}
if(has_no_del){delete usable_items['remove'];}
if(has_no_move){delete usable_items['move'];}
if(has_no_rename){delete usable_items['rename'];}
if(has_no_down){delete usable_items['single_download'];delete usable_items['package_download'];}
if(has_dir){delete usable_items['mail_share'];}
if(has_dir||multi){delete usable_items['single_download'];delete usable_items['mail_share'];}
if(multi){delete usable_items['rename'];}
else if(only_1_file){delete usable_items['package_download'];}
if(is_more_menu){delete usable_items['single_download'];}
return usable_items;}});return ui;})
define.pack("./file_list.rename.rename",["lib","common","$","./file_list.rename.ui"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),date_time=lib.get('./date_time'),request=common.get('./request'),Module=common.get('./module'),File=common.get('./file.file_object'),renaming_node,renaming_callback,renaming_scope,deep_limit=19,undefined;var rename=new Module('disk_file_rename',{ui:require('./file_list.rename.ui'),render:function(){this.on('deactivate',function(){this.close_edit();});},is_idle:function(){return!this._saving;},start_edit:function(node,callback,scope){if(this._saving){return;}
this.render();this.close_edit();renaming_node=node;renaming_callback=callback;renaming_scope=scope;this.trigger('start',renaming_node);},close_edit:function(new_name,properties){if(renaming_node){new_name=new_name||renaming_node.get_name();this.trigger('done',renaming_node,new_name);if(renaming_callback&&$.isFunction(renaming_callback)){renaming_callback.call(renaming_scope,!!new_name,new_name,properties);}
renaming_node=null;}},try_save:function(new_name,keep_focus){if(renaming_node){var changed=renaming_node.is_tempcreate()||new_name&&new_name!==renaming_node.get_name();if(changed){var err=this._check_name(new_name);if(!err&&renaming_node.is_tempcreate()){err=this._check_deep(renaming_node.get_parent());}
if(err){this.trigger('error',err);if(!keep_focus){this.close_edit();}}else{this.trigger('temp_save',renaming_node,new_name);this._try_save(new_name);}}else{this.close_edit();}}},_try_save:function(new_name){var me=this;if(me._saving){return false;}
var
data={ppdir_key:renaming_node.get_parent().get_parent().get_id(),pdir_key:renaming_node.get_parent().get_id()},cmd,encode=encodeURIComponent;if(renaming_node.is_dir()){if(renaming_node.is_tempcreate()){cmd='dir_create';}else{cmd='dir_attr_mod';data.dir_key=renaming_node.get_id();}
data.dir_attr={dir_name:encode(new_name),dir_note:''};}else{cmd='file_attr_mod';data.file_id=renaming_node.get_id();data.file_attr={file_name:encode(new_name),file_note:'',file_mtime:date_time.now_str()};}
request.post({cmd:cmd,body:data,cavil:true}).ok(function(msg,body){var old_name=renaming_node.get_name();var properties=null;if(renaming_node.is_tempcreate()){properties={id:body.dir_key,name:new_name,create_time:body.dir_ctime,modify_time:body.dir_mtime};}
me.trigger('ok',renaming_node,old_name,new_name);me.close_edit(new_name,properties);}).fail(function(msg){me.trigger('error',msg);me.close_edit();}).done(function(){me._saving=false;});me._saving=true;},_check_name:function(new_name){var err=File.check_name(new_name);if(!err){new_name=new_name.toLowerCase();var siblings=renaming_node.get_parent().get_kid_nodes();var name_conflict=collections.any(siblings,function(sib_node){if(sib_node!==renaming_node&&sib_node.get_name().toLocaleLowerCase()===new_name){return true;}});if(name_conflict){err=(renaming_node.is_dir()?'文件夹':'文件')+'名有冲突，请重新命名';}}
return err;},_check_deep:function(dir_node){var par_len=0;while(dir_node=dir_node.get_parent()){par_len++;}
if(par_len>deep_limit){return'文件夹路径过深，请重新创建';}}});return rename;});define.pack("./file_list.rename.ui",["lib","common","$","./tmpl","./file_list.ui_normal","./file_list.rename.rename"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),Module=common.get('./module'),mini_tip=common.get('./ui.mini_tip'),tmpl=require('./tmpl'),key_event=($.browser.msie&&$.browser.version<7)?'keypress':'keydown',$body,file_list_ui_normal,rename,undefined;var ui=new Module('disk_file_rename_ui',{render:function(){file_list_ui_normal=require('./file_list.ui_normal');rename=require('./file_list.rename.rename');$body=$(document.body);this.listenTo(rename,'start',function(node){var
$editor=this._get_$editor(),$input=$editor.find('input'),$item=file_list_ui_normal.get_$item(node.get_id()),$file_name=$item.find('[data-name=file_name]');$file_name.hide().after($editor.show());$input.val(node.get_name()).on(key_event+'.file_rename',function(e){if(e.which===13){var val=$.trim(this.value);if(val){rename.try_save(val,true);}}else if(e.which==27){rename.close_edit();}});if(node.is_dir()){$input.focus().select();}else{this._select_text_before($input,'.');}
setTimeout(function(){$body.on('mousedown.file_rename',function(e){if(!$(e.target).is($input)){var val=$.trim($input.val());if(node.is_tempcreate()&&!val){rename.close_edit();}
else{rename.try_save(val,false);}}});},0);}).listenTo(rename,'ok',function(node,old_name,new_name){mini_tip.ok(node.is_tempcreate()?'新建文件夹成功':'更名成功');}).listenTo(rename,'done',function(){this.destroy();}).listenTo(rename,'deny',function(node,err){mini_tip.error(err);this._get_$editor().find('input').focus();}).listenTo(rename,'error',function(err){mini_tip.error(err);}).listenTo(rename,'temp_save',function(node,name){var $editor=this._get_$editor();$editor.hide();$editor.find('input').toggle().toggle();});},destroy:function(){var $editor=this._get_$editor();$editor.hide().remove();this._$editor=null;$body.off('mousedown.file_rename');},_get_$editor:function(){if(!this._$editor){this._$editor=$(tmpl.rename_editor());}
return this._$editor;},_select_text_before:function($input,sep){var input=$($input)[0],text=$input.val(),before=(text.lastIndexOf(sep)==-1)?text.length:text.lastIndexOf(sep);if(input.setSelectionRange){input.focus();input.setSelectionRange(0,before);}
else if(input.createTextRange){var text_range=input.createTextRange();text_range.collapse(true);text_range.moveEnd('character',before);text_range.moveStart('character',0);text_range.select();}
else{input.select();}}});return ui;});define.pack("./file_list.selection.selection",["lib","common","$","./tmpl","./file.file_node","./file.utils.all_file_map","./file_list.file_list","./file_list.ui_normal"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),Selectable=lib.get('./ui.selectable'),events=lib.get('./events'),console=lib.get('./console'),text=lib.get('./text'),constants=common.get('./constants'),Module=common.get('./module'),global_event=common.get('./global.global_event'),log_event=common.get('./global.global_event').namespace('log'),disk_event=common.get('./global.global_event').namespace('disk'),user_log=common.get('./user_log'),tmpl=require('./tmpl'),FileNode=require('./file.file_node'),all_file_map=require('./file.utils.all_file_map'),file_list,file_list_ui_normal,SELECTED_CLASS='ui-selected',ITEM_CLASS='ui-item',FILTER_QUICK_DRAG='[data-action=enter]',DROP_ITEM_LIST='#_disk_files_dir_list',FILTER_CHECKBOX='',KEEP_SELECT_ON='[data-no-selection], object, embed',KEEP_SELECT_ON_BATCH_MODE=KEEP_SELECT_ON+', .'+SELECTED_CLASS,CLICK_CANCEL='input, textarea, button, a, '+KEEP_SELECT_ON,SELECT_CANCEL='[data-function], [data-action=enter],'+CLICK_CANCEL,CLICK_CANCEL_BATCH_MODE=CLICK_CANCEL,SELECT_CANCEL_BATCH_MODE=CLICK_CANCEL,NO_MOVE_FILTER='[data-no-move]',selectable,dragdrop,batch_mode,batch_op_type,batch_without,get_by_el_id=function(id){return document.getElementById(id);},undefined;var selection=new Module('disk_file_selection',{$list:null,render:function(){file_list=require('./file_list.file_list');file_list_ui_normal=require('./file_list.ui_normal');dragdrop={_enabled:false,enable:function(){var me=this;if(me._enabled){return;}
me.refresh();me.listenTo(selectable,'select_change',function(change_status){var $items=$.map($.extend({},change_status.org_sel_id_set,change_status.new_sel_id_set),function(x,el_id){return get_by_el_id(el_id);});me.refresh($items);});me._enabled=true;},disable:function(){if(this._enabled){this._destroy();this.stopListening(file_list,'load').stopListening(selectable,'select_change');this._enabled=false;}},refresh:function(items){var me=this;var $items=items?$(items):selectable.get_$items();me.refresh_drag($items);me.refresh_drop($items.filter(function(i,item){var file_id=item.getAttribute('data-file-id'),file_node=all_file_map.get(file_id);return file_node&&file_node.is_droppable();}));},refresh_drag:function($items){if(!$items||!$items.length){return;}
var me=this;require.async('jquery_ui',function(){$items.each(function(i,item){var $item=$(item),is_selected=selection.is_selected($item),handle=is_selected?'.'+ITEM_CLASS:FILTER_QUICK_DRAG;if($item.data('data-draggable-handle')!=handle){if($item.data('draggable')){$item.draggable('option','handle',handle);}else{$item.draggable({scope:'move_file',handle:handle,cursorAt:{top:-15,left:-15},distance:10,appendTo:'body',helper:function(e){return $('<div id="_selection_draggable_helper" class="drag-helper"/>');},start:$.proxy(me._on_drag_start,me),stop:$.proxy(me._on_drag_stop,me)});}
$item.data('data-draggable-handle',handle);}});});},refresh_drop:function($items){if(!$items||!$items.length){return;}
var dir_list_el=$items[0].parentNode;var options={scope:'move_file',tolerance:'pointer',hoverClass:'ui-dropping',drop:function(e,ui){var oe=e.originalEvent.originalEvent,o_target=$(oe.target||oe.srcElement);if(o_target.closest(dir_list_el)[0]){var $item=$(e.target);if(!selection.is_selected($item)){var $target_item=$(e.target).closest('.'+ITEM_CLASS),target_dir_id=$target_item.attr('data-file-id');disk_event.trigger('drag_and_drop_files_to',target_dir_id);user_log('DISK_DRAG_DIR');return true;}}
user_log('DISK_DRAG_RELEASE');return false;}};require.async('jquery_ui',function(){$items.droppable(options);});},_on_drag_start:function(e,ui){var oe=e.originalEvent.originalEvent;if($(oe.target||oe.srcElement).is('[data-function]')){return false;}
var $target=$(e.originalEvent.target),$curr_item=$target.closest('.'+ITEM_CLASS);if($curr_item.is(NO_MOVE_FILTER)){return false;}
var from_enter=$target.closest(FILTER_QUICK_DRAG).length;if(from_enter&&!selection.is_selected($curr_item)){selection.clear();selection.select_but($curr_item);$(document).one('mouseup blur',function(){selectable.select_item($curr_item,true,true);});}
var $sel_items=dragdrop._get_draggable_items();if(!$sel_items.length){return false;}
var files=selection.get_selected_files($sel_items);if(!files.length){return false;}
var curr_file=files[collections.indexOf($sel_items.get(),$curr_item[0])];var ret_val=selection.trigger('before_drag_files',$curr_item,curr_file,$sel_items,files);if(ret_val===false){return false;}
ui.helper.html(tmpl.dragging_cursor({files:files}));},_on_drag_stop:function(){selection.trigger('stop_drag');},_get_draggable_items:function(){var $sel_items=selection.get_selected_$items(),incom_items=[];$sel_items=$sel_items.filter(function(i,item){if($(item).is(NO_MOVE_FILTER)){incom_items.push(item);}else{return true;}});if(incom_items.length){selection.unselect(incom_items,true);}
return $sel_items;},_destroy:function(items){var $items=items?$(items):selectable.get_$items();$items.each(function(i,item){var $item=$(item),data=$item.data();if(data['draggable']){$item.draggable('destroy').removeData('data-draggable-handle');}
if(data['droppable']){$item.droppable('destroy');}});},_get_drag_helper:function(){return $('#_selection_draggable_helper');},cancel_drag:function(){var $helper=this._get_drag_helper();if($helper[0]){$helper.remove();}
$(document,document.body).trigger('mouseup');this.refresh(selectable.get_selected_$items());}};$.extend(dragdrop,events);selectable=new Selectable({target:file_list_ui_normal.get_$lists(),child_filter:'.'+ITEM_CLASS,checkbox:FILTER_CHECKBOX,keep_select_on:KEEP_SELECT_ON,select_cancel:SELECT_CANCEL});selectable.on('select_change',function(change_status){var id_arr=change_status.new_sel_id_arr;global_event.trigger('disk_selected_files',id_arr.length);log_event.trigger('sel_files_len_change',id_arr.length);});selectable.on('box_selection_stop',function(){if(selectable.has_selected()){user_log('BOX_SELECTION');}});},refresh_selection:function(){selectable.refresh();},is_selecting:function(){return selectable.is_selecting();},enable_selection:function(){selectable.enable();},disable_selection:function(){this.clear();selectable.disable();},enable_dragdrop:function(){dragdrop.enable();},disable_dragdrop:function(){dragdrop.disable();},refresh_drag:function($items){dragdrop.refresh_drag($items);},refresh_drop:function($items){dragdrop.refresh_drop($items);},_toggle_select:function(flag,args,trigger_event){if(args.length){trigger_event=trigger_event==undefined?true:trigger_event;var $items;if(args[0]instanceof jQuery||(args[0].tagName&&args[0].nodeType)){$items=args;}else{var file_ids;if(FileNode.is_instance(args[0])){file_ids=$.map(args,function(file){return file.get_id();});}
else if(typeof args[0]=='string'){file_ids=args;}
var id_set=collections.array_to_set(file_ids);$items=selectable.get_$items().filter(function(i,item){var $item=$(item),file_id=$item.attr('data-file-id');if(file_id in id_set){return $item;}});}
selectable.select_item($items,flag,trigger_event);}},select:function(args,trigger_event){this._toggle_select(true,args,trigger_event);},unselect:function(args,trigger_event){this._toggle_select(false,args,trigger_event);},clear:function(){selectable.clear_selected();},cancel_drag:function(){dragdrop.cancel_drag();},get_selected_files:function($items){var
ids=this.get_selected_file_ids($items),files=all_file_map.get_all(ids);return files;},get_selected_$items:function(){return selectable.get_selected_$items();},get_selected_file_ids:function($items){return $.map($items||this.get_selected_$items(),function(item){return $(item).attr('data-file-id');});},set_batch_mode:function(_batch,_without){if(batch_mode===_batch&&batch_op_type===_op_type&&batch_without===_without){return;}
var click_cancel=_batch?CLICK_CANCEL_BATCH_MODE:CLICK_CANCEL,select_cancel=_batch?SELECT_CANCEL_BATCH_MODE:SELECT_CANCEL,keep_select=(_batch?KEEP_SELECT_ON_BATCH_MODE:KEEP_SELECT_ON)+(_without?','+_without:'');selectable.set_select_cancel(click_cancel,select_cancel);selectable.set_keep_select_on(keep_select);selectable.set_ctrl_multi(!_batch);selectable.set_filter(file_list_ui_normal.get_$lists(),'.'+ITEM_CLASS+(_without?':not('+_without+')':''));batch_mode=_batch;batch_without=_without;},is_selected:function(item){return selectable.is_selected.apply(selectable,arguments);},has_selected:function(){return selectable.has_selected.apply(selectable,arguments);},is_can_select:function(){return selectable.is_can_select.apply(selectable,arguments);},filter_can_select:function(){return selectable.filter_can_select.apply(selectable,arguments);},select_but:function(){return selectable.select_but.apply(selectable,arguments);}});return selection;});define.pack("./file_list.share.share",["lib","common","$","./file.file_node","./file_list.share.ui"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),Module=common.get('./module'),ret_msgs=common.get('./ret_msgs'),urls=common.get('./urls'),user_log=common.get('./user_log'),query_user=common.get('./query_user'),request=common.get('./request'),size_limit=2*1024*1024*1024,FileNode=require('./file.file_node'),undefined;var share=new Module('share',{ui:require('./file_list.share.ui'),is_sharable:function(file){var err=0;if(!file.is_dir()){var size=file.get_size(),cur_size=file.get_cur_size();if(size!=cur_size){err=ret_msgs.INCOMPLETE_FILE;}else if(size==0){err=ret_msgs.EMPTY_FILE;}else if(cur_size>size_limit){err=ret_msgs.SHARE_FILE_OVER_SIZE;}}
else{err=ret_msgs.EMPTY_FILE;}
return err==0?'':ret_msgs.get(err);},is_link_sharable:function(files){if(!files){return'无效的参数';}
if(FileNode.is_instance(files)){files=[files];}
var err=0;for(var i=0,l=files.length;i<l;i++){var f=files[i];if(!f.is_dir()){if(f.is_broken_file()){err=ret_msgs.INCOMPLETE_FILE;}
else if(f.is_empty_file()){err=ret_msgs.EMPTY_FILE;}
else if(f.get_cur_size()>size_limit){err=ret_msgs.SHARE_FILE_OVER_SIZE;}}}
return err==0?'':ret_msgs.get(err);},get_mail_url:function(file){if(file&&!file.is_dir()){var uin=query_user.get_uin_num(),skey=query_user.get_skey();return urls.make_url('http://jump.weiyun.qq.com/set_cookie.php',{uin:uin,skey:skey,url:encodeURIComponent(urls.make_url('http://mail.qq.com/cgi-bin/login',{weiyunfid:file.get_id()+','+file.get_parent().get_id(),ADUIN:uin,lc:'zh_CN',vt:'passport',target:'weiyunsend',vm:'pt'},false))},false);}else{return'#';}},link_share:function(files){var err=this.is_link_sharable(files);if(!err){var me=this;me.render();var _files=[],_dirs=[];$.each(files,function(i,f){if(f.is_dir()){_dirs.push({dir_key:f.get_id(),dir_name:f.get_name()});}else{_files.push({file_id:f.get_id(),file_name:f.get_name()});}});if(files.length>40){me.trigger('warn',"一次分享不能超过40个文件");return;}
request.post({url:'http://web.cgi.weiyun.com/wy_share.fcg',cmd:'add_share',header:{"uin":query_user.get_cached_user().get_uin()},body:{ppdir_key:files[0].get_parent().get_parent().get_id(),pdir_key:files[0].get_parent().get_id(),files:_files,dirs:_dirs},cavil:true,resend:true}).ok(function(ret,body){me.trigger('link_shared',body['short_url'],body['raw_url'],files);}).fail(function(msg){me.trigger('error',msg);});}else{this.trigger('warn',err);}}});return share;});define.pack("./file_list.share.ui",["lib","common","$","./tmpl","./file_list.share.share"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),constants=common.get('./constants'),Module=common.get('./module'),widgets=common.get('./ui.widgets'),global_event=common.get('./global.global_event'),flash_focus_hacker=common.get('./ui.flash_focus_hacker'),mini_tip=common.get('./ui.mini_tip'),tmpl=require('./tmpl'),flash_clip,cur_short_link,cur_long_link,share,support_input_copy=false,ie=$.browser.msie,ie6=ie&&$.browser.version<7,doc_title,undefined;var ui=new Module('disk_file_share_ui',{render:function(){share=require('./file_list.share.share');var me=this;this.listenTo(share,'link_shared',function(short_link,long_link,files){this.show_link_share_box(short_link,long_link,files);}).listenTo(share,'warn',function(err){mini_tip.warn(err);}).listenTo(share,'error',function(err){mini_tip.error(err);});var dialog=this._link_share_dialog=new widgets.Dialog({empty_on_hide:true,buttons:['CLOSE'],content:tmpl.link_share_content()});dialog.on('show',function(){doc_title=document.title;var $body=this.get_$body(),$btn=$body.find('[data-function=copy]'),$link=me._$link=$body.find('a[data-function=link]');$link.attr('href',cur_short_link).text(cur_short_link);var support_copy=me._render_copy($btn,cur_short_link);if(!support_copy&&!support_input_copy){$btn.hide();}}).on('after_show',function($dialog){if(constants.IS_WEBKIT_APPBOX){$dialog.css('opacity',.9999);}}).on('hide',function(){document.title=doc_title;doc_title=null;me._destroy_copy();me._$link=null;}).on('tip',function(msg,left){var $tip=dialog.get_$body().find('[data-function="tip"]').css({left:left?(left+'px'):''});$tip.html(tmpl.link_share_copy_error({msg:msg})).stop().fadeIn(100).delay(3000).fadeOut(100);}).listenTo(me,'copy_error',function(){dialog.trigger('tip','您的浏览器不支持该功能',-50);}).listenTo(me,'copy_done',function(){dialog.trigger('tip','复制成功');});},show_link_share_box:function(short_link,long_link,files){cur_short_link=short_link;cur_long_link=long_link;var title;if(files.length===1){title=text.smart_sub(files[0].get_name(),20);}
else{var dir_len=0,file_len=0;$.each(files,function(i,file){file.is_dir()?dir_len++:file_len++;});title=text.smart_sub(files[0].get_name_no_ext(),16)+'等'+[dir_len?dir_len+'个文件夹':'',(dir_len&&file_len)?'和':'',file_len?file_len+'个文件':''].join('');}
this._link_share_dialog.set_title(title);this._link_share_dialog.show();},hide_link_share_box:function(){var dialog=this._link_share_dialog;if(dialog){dialog.hide();}},_render_copy:function($btn,text){this._destroy_copy();if((constants.IS_APPBOX&&ie)||ie6){return this._render_ie_copy.apply(this,arguments)||this._render_flash_copy.apply(this,arguments)||this._render_input_copy.apply(this,arguments);}else{return this._render_flash_copy.apply(this,arguments)||this._render_ie_copy.apply(this,arguments)||this._render_input_copy.apply(this,arguments);}},_destroy_copy:function(){if(flash_clip){require.async('ZeroClipboard',function(ZeroClipboard){ZeroClipboard.destroy();});flash_clip=null;}
this.stopListening(global_event,'window_resize window_scroll');},_render_flash_copy:function($btn,text){if(!this._has_flash()){return false;}
var me=this;require.async('zclip',function(){if(!flash_clip){$btn.attr('data-clipboard-text',text);$btn.zclip({path:'http://imgcache.qq.com/club/weiyun/js/lib/jquery-plugins/jquery.zclip/ZeroClipboard.swf',copy:text,afterCopy:function(){me.trigger('copy_done');document.title=doc_title;}});document.title=doc_title;}});return true;},_render_ie_copy:function($btn,text){if($.browser.msie&&window.clipboardData){var me=this;$btn.off('click').on('click',function(){var ie_clipboard=window.clipboardData;setTimeout(function(){if(ie_clipboard.getData('Text')===text){me.trigger('copy_done');}else{me.trigger('copy_error');}},50);ie_clipboard.setData('Text',text);});return true;}
return false;},_render_input_copy:function($btn,text){if(support_input_copy){var me=this;$btn.on('click',function(e){e.preventDefault();me._show_manual_copy(text);});return true;}else{return false;}},_show_manual_copy:function(text){if(support_input_copy){var me=this,$link=me._$link,$input=$link.next('input');if(!$input[0]){$input=$('<input class="ui-bold"/>').width($link.width()).height($link.height()).val(text);$input.on('focusout',function(){$link.show();$input.hide();});$link.hide().after($input);}
$link.hide();$input.show().focus();$input[0].select();}},__has_flash:undefined,_has_flash:function(){if(this.__has_flash!==undefined){return this.__has_flash;}
var hasFlash=false;try{if(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")){hasFlash=true;}}
catch(error){if(navigator.mimeTypes["application/x-shockwave-flash"]){hasFlash=true;}}
if(!hasFlash){hasFlash=window.external&&window.external.FlashEnable&&window.external.FlashEnable();}
return this.__has_flash=!!hasFlash;}});return ui;});define.pack("./file_list.thumb.thumb",["lib","common","$","./file.file_node","./file.utils.all_file_map"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console').namespace('disk/thumb'),events=lib.get('./events'),image_loader=lib.get('./image_loader'),request=common.get('./request'),query_user=common.get('./query_user'),m_speed=common.get('./m_speed'),FileNode=require('./file.file_node'),all_file_map=require('./file.utils.all_file_map'),encode=encodeURIComponent,batch_size=8,image_caches={},queue_files=[],queue_id_map={},error_map={},retry_times=1,doing=false,get_speed_started=false,get_speed_done=false,parse_int=parseInt,options={size:64,cgi_url:null,cgi_cmd:'img_view_bat',cgi_data:function(files){var user=query_user.get_cached_user();if(user){return{file_owner:user.get_uin(),pdir_key:files[0].get_parent().get_id(),files:$.map(files,function(file,i){return{file_id:file.get_id(),file_name:encode(file.get_name())}})}}},cgi_response:function(files,body){var size=this._options.size;return $.map(body['imgs'],function(img_rsp){var ret=parse_int(img_rsp['ret']),file_id,url;if(ret===0){var host=img_rsp['dl_svr_host'],port=img_rsp['dl_svr_port'],path=img_rsp['dl_encrypt_url'];url='http://'+host+':'+port+'/ftn_handler/'+path+'?size='+size+'*'+size;file_id=img_rsp['file_id'];}
return new ImageMeta(ret,file_id,url);})}},undefined;var Thumb=function(_options){this._options=$.extend({},options,_options);};$.extend(Thumb.prototype,{push:function(file_args){return this._add(file_args,false);},insert:function(file_args){return this._add(file_args,true);},_add:function(file_args,is_insert){var files=this._get_img_nodes(file_args);if(!files||!files.length){return;}
queue_files=is_insert?files.concat(queue_files):queue_files.concat(files);$.each(files,function(i,file){queue_id_map[file.get_id()]=1;});if(!doing){this.start();}},start:function(){doing=true;this._cgi_apply_next();},stop:function(){doing=false;},clear_queue:function(){queue_files=[];queue_id_map={};doing=false;},_cgi_apply_next:function(file){var me=this;var user=query_user.get_cached_user();if(user){var is_from_queue=!file;if(!file&&!queue_files.length){return me.stop();}
var files;if(file){files=[file];}else{files=me._get_files_from_queues();}
files=me._without_cached(files);if(!files.length){return me._cgi_apply_next();}
var req_ids=[];$.each(files,function(i,file){req_ids.push(file.get_id());});var cgi_data=me._options.cgi_data.call(me,files);me._speed_test_start();var request_method=files.length<5?request.get:request.post;request_method.call(request,{url:me._options.cgi_url,cmd:me._options.cgi_cmd,body:function(){return cgi_data;}}).ok(function(msg,body){var img_rsps=me._options.cgi_response.call(me,files,body);me._fill_images_by_rsp(req_ids,img_rsps);me._speed_test_done();}).fail(function(msg,ret,body,header){console.error(msg,ret);}).done(function(){if(is_from_queue){me._cgi_apply_next();}});if(!queue_files.length){me.stop();}}},_without_cached:function(files){if(files.length){var me=this,no_cached_files=[];$.each(files,function(i,file){var img=me.get_cache(file.get_id());if(img){me.trigger('get_image_ok',file,img);}
else{no_cached_files.push(file);}});return no_cached_files;}
return files;},_get_files_from_queues:function(){var first_parent=collections.first(queue_files,function(f){return f.is_on_tree();}).get_parent(),do_files=[],todo_files=[];$.each(queue_files,function(i,queue_file){if(queue_file.is_on_tree()){var parent=queue_file.get_parent();if(parent&&parent===first_parent&&do_files.length<batch_size){do_files.push(queue_file);}else{todo_files.push(queue_file);}}});queue_files=todo_files;return do_files;},_fill_images_by_rsp:function(req_ids,img_rsps){var me=this,failed_ids=[];if(img_rsps&&img_rsps.length){$.each(img_rsps,function(i,img_rsp){var is_ok=img_rsp.get_ret()===0;if(is_ok){var file_id=img_rsp.get_file_id(),file_node=all_file_map.get(file_id);if(file_node){me._get_thumb_async(file_node,img_rsp.get_url(),function(img_el,is_ok){if(is_ok){me.set_cache(file_node.get_id(),img_el);me.trigger('get_image_ok',file_node,img_el);}
else{me.trigger('get_image_error',file_node);}});}}
else{failed_ids.push(req_ids[i]);}});}
if(failed_ids.length){var
retry_failed_ids=[],to_fix_ids=collections.grep(failed_ids,function(file_id){var retried=error_map[file_id]||(error_map[file_id]=0);if(retried>retry_times){retry_failed_ids.push(file_id);return false;}else{error_map[file_id]++;return true;}});if(to_fix_ids.length){console.debug('缩略图加载失败 '+to_fix_ids.length+' 个：',error_map,' 已重试');me.insert(to_fix_ids);}
if(retry_failed_ids.length){$.each(retry_failed_ids,function(i,file_id){var file_node=all_file_map.get(file_id);me.trigger('get_image_error',file_node);});}}},_get_thumb_async:function(file,url,callback){if(file){var me=this;image_loader.load(url).done(function(img){callback.call(me,img,true);}).fail(function(img){callback.call(me,img,false);});}},_speed_test_start:function(){try{if(!get_speed_started){get_speed_started=true;m_speed.start('disk','thumb');}}
catch(e){}},_speed_test_done:function(){try{if(!get_speed_done){get_speed_done=true;m_speed.done('disk','thumb');}}
catch(e){}},set_cache:function(file_id,image){image_caches[file_id]=image;},get_cache:function(file_id){return image_caches[file_id];},destroy:function(){var div=$('<div style="display:none;"/>').appendTo(document.body);for(var file_id in image_caches){var image=image_caches[file_id];div.append(image);}
div.remove();},_get_img_nodes:function(file_args){var files;if(typeof file_args==='string'){files=[all_file_map.get(file_args)];}
else if($.isArray(file_args)){if(typeof file_args[0]==='string'){files=$.map(file_args,function(file_id){return all_file_map.get(file_id);});}
else{files=file_args;}}
else if(FileNode.is_instance(file_args)){files=[file_args];}
if(files.length){files=collections.grep(files,function(file){return!(!file.is_image()||file.is_broken_file()||file.is_empty_file());});}
return files;}},events);var ImageMeta=function(ret,file_id,url){this._ret=ret;this._file_id=file_id;this._url=url;};ImageMeta.prototype={get_ret:function(){return this._ret},get_file_id:function(){return this._file_id;},get_url:function(){return this._url;}};Thumb.ImageMeta=ImageMeta;return Thumb;});define.pack("./file_list.thumb.ui",["lib","common","$","./tmpl","./file_list.file_list","./file_list.ui_normal","./view_switch.view_switch","./file_list.thumb.thumb"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),cookie=lib.get('./cookie'),Module=common.get('./module'),request=common.get('./request'),query_user=common.get('./query_user'),constants=common.get('./constants'),tmpl=require('./tmpl'),file_list=require('./file_list.file_list'),file_list_ui_normal=require('./file_list.ui_normal'),view_switch=require('./view_switch.view_switch'),default_images={'http://imgcache.qq.com/vipstyle/nr/box/img/img-70.png':1,'http://imgcache.qq.com/vipstyle/nr/box/img/img-32.png':1},thumb,undefined;var ui=new Module('disk_file_list_thumb_ui',{_process_id:0,render:function(){thumb=require('./file_list.thumb.thumb');this.listenTo(thumb,'get_image_ok',function(file,img){this.set_$item_img(file,img);}).listenTo(thumb,'get_image_error',function(file){file_list_ui_normal.mark_$item_img_notfound(file);});},set_$item_img:function(file,img){var $item=file_list_ui_normal.get_$item(file.get_id()),$item_img=$item.find('img');if($item_img[0]){var src=img.src;$item_img[0].src=src;$item_img.toggleClass('default',src in default_images);}}});return ui;});define.pack("./file_list.ui",["lib","common","$","./file_path.file_path","./toolbar.toolbar","./view_switch.view_switch","main","./file_list.file_list","./file_list.ui_virtual","./file_list.ui_normal"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console').namespace('disk/file_list/ui'),events=lib.get('./events'),Module=common.get('./module'),query_user=common.get('./query_user'),widgets=common.get('./ui.widgets'),mini_tip=common.get('./ui.mini_tip'),page_event=common.get('./global.global_event').namespace('page'),global_event=common.get('./global.global_event'),scroller=common.get('./ui.scroller'),user_log=common.get('./user_log'),file_path=require('./file_path.file_path'),toolbar=require('./toolbar.toolbar'),view_switch=require('./view_switch.view_switch'),main_mod=require('main'),space_info=main_mod.get('./space_info.space_info'),file_list,ui_map={},cur_ui,doc=document,undefined;var ui=new Module('disk_file_list_ui',{render:function($list_to){file_list=require('./file_list.file_list');this._$list_to=$list_to;this.listenTo(file_list,'before_load',function(node,last_node,reset_ui){this.enter_dir(node,last_node,reset_ui);}).listenTo(file_list,'load',function(node){if(this.is_activated()&&file_list.is_cur_node(node)){this.set_node_data.apply(this,arguments);if(file_list.get_root_node()===node){doc.title=node.get_name();}else{doc.title=node.get_name()+' - 微云';}}}).listenTo(file_list,'before_async_load',function(){widgets.loading.show();}).listenTo(file_list,'after_async_load',function(){widgets.loading.hide();}).listenTo(file_list,'error',function(msg,ret){mini_tip.error(msg);}).listenTo(file_list,'prepend_node',function(dirs,files){if(cur_ui){cur_ui.prepend_$items(dirs,files);}}).listenTo(file_list,'append_node',function(dirs,files){if(cur_ui){cur_ui.append_$items(dirs,files,false);}}).listenTo(file_list,'add_node',function(dirs,files,index){if(cur_ui){cur_ui.insert_$items(dirs,files,index);}}).listenTo(file_list,'after_nodes_removed',function(nodes,refresh_space_info,animate){if(cur_ui){cur_ui.remove_$items(nodes,animate);}
if(refresh_space_info){space_info.refresh();}}).listenTo(file_list,'after_nodes_moved',function(nodes){if(cur_ui){cur_ui.remove_$items(nodes,true);}}).listenTo(file_list,'external_insert_files',function(ids,msg,is_ok){if(ids&&ids.length&&ui_map['ui_normal']){ui_map['ui_normal'].set_highlight_ids(ids);}
if(msg){if(is_ok){mini_tip.ok(msg);}else{mini_tip.warn(msg);}}}).listenTo(toolbar,'click_reload',function(){file_list.reload(false,true,false);space_info.refresh();scroller.go(0,0);user_log('disk_file_list_reload');});},enter_dir:function(node,last_node,reset_ui){var last_ui=cur_ui;cur_ui=this._get_ui(node);if(last_ui){last_ui.exit_dir(node,reset_ui);}
if(last_ui&&last_ui!==cur_ui){last_ui.hide();last_ui.reset();}
cur_ui.render(this._get_$list_parent());cur_ui.activate();cur_ui.enter_dir(node,last_node);cur_ui.show();file_path.update(node);view_switch.ui.toggle(cur_ui.is_view_switchable());global_event.trigger('page_header_height_changed');},set_node_data:function(){if(cur_ui){cur_ui.set_node_data.apply(cur_ui,arguments);}
global_event.trigger('page_header_height_changed');},toggle:function(visible){if(cur_ui){if(visible){cur_ui.show();}else{cur_ui.hide();}}},_get_ui:function(node){if(!node){return null;}
var ui,ui_name;if(node.is_vir_dir()){ui_name='ui_virtual';ui=require('./file_list.ui_virtual');}else{ui_name='ui_normal';ui=require('./file_list.ui_normal');}
if(!ui_map[ui_name]){ui_map[ui_name]=ui;this.add_sub_module(ui);this.listenTo(ui,'add_$items remove_$items clear_$items list_resized',function(){this.trigger('list_height_changed');});}
return ui;},_get_$list_parent:function(){return this._$list_to;}});page_event.on('check_file_upload_draggable',function(){var cur_node=file_list.get_cur_node();return!!cur_node&&!cur_node.is_vir_dir();});return ui;});define.pack("./file_list.ui_abstract",["lib","common","$"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),console=lib.get('./console'),Module=common.get('./module'),constants=common.get('./constants'),icon_map={weixin:'icon-weixin icon-weixin-dir',text:'icon-weixin icon-weixin-msgs',text_audio:'icon-weixin icon-weixin-msgs',picture:'icon-weixin icon-weixin-img',picture_video:'icon-weixin icon-weixin-img',article:'icon-weixin icon-weixin-blog'},undef;var FileListUIModule=function(module_name,options){var me=this;Module.apply(me,arguments);$.each(me,function(prop,val){if(!val){me[prop]=val;}});};FileListUIModule.prototype=$.extend({},Module.prototype,{enter:$.noop,exit:$.noop,set_node_data:$.noop,reset:$.noop,show:$.noop,hide:$.noop,prepend_$items:$.noop,append_$items:$.noop,insert_$items:$.noop,remove_$items:$.noop,set_highlight_ids:$.noop,is_view_switchable:$.noop,appbox_preview:function(node){var ex=window.external,def=$.Deferred(),support=constants.IS_APPBOX&&((ex.PreviewImage&&ex.IsCanPreviewImage&&ex.IsCanPreviewImage(node.get_name()))||(ex.PreviewDocument&&ex.IsCanPreviewDocument&&ex.IsCanPreviewDocument(node.get_name())));if(support){require.async('full_screen_preview',function(mod){try{var full_screen_preview=mod.get('./full_screen_preview');full_screen_preview.preview(node);def.resolve();}catch(e){console.warn('全屏预览失败，则使用普通预览, file_name='+node.get_name());def.reject();}});}else{def.reject();}
return def;},preview_zip_file:function(file){require.async('compress_file_iframe',function(mod){var compress_file_iframe=mod.get('./compress_file_iframe'),iframe=compress_file_iframe.create_preview({file:file,max_width:constants.IS_APPBOX?670:915});iframe.set_title(file.get_name());iframe.show();});},preview_doc:function(file){require.async('doc_preview',function(mod){var doc_preview=mod.get('./doc_preview');doc_preview.preview(file);});},get_icon_map:function(){return icon_map;}});return FileListUIModule;});define.pack("./file_list.ui_normal",["lib","common","$","./tmpl","./file.file_node","./file.utils.file_factory","./file.utils.all_file_map","./view_switch.view_switch","./file_path.file_path","./file_list.rename.rename","main","./file_list.ui_abstract","./toolbar.toolbar","./file_list.file_list","./file_list.ui","./file_list.menu.menu","./file_list.file_processor.remove.remove","./file_list.file_processor.move.move","./file_list.selection.selection","./file_list.thumb.thumb"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console').namespace('disk/file_list/ui'),events=lib.get('./events'),store=lib.get('./store'),routers=lib.get('./routers'),text=lib.get('./text'),constants=common.get('./constants'),widgets=common.get('./ui.widgets'),scroller=common.get('./ui.scroller'),global_event=common.get('./global.global_event'),disk_event=common.get('./global.global_event').namespace('disk'),page_event=common.get('./global.global_event').namespace('page'),global_function=common.get('./global.global_function'),global_variable=common.get('./global.global_variable'),user_log=common.get('./user_log'),query_user=common.get('./query_user'),Paging_Helper=common.get('./ui.paging_helper'),mini_tip=common.get('./ui.mini_tip'),m_speed=common.get('./m_speed'),ie_click_hacker=common.get('./ui.ie_click_hacker'),tmpl=require('./tmpl'),FileNode=require('./file.file_node'),file_factory=require('./file.utils.file_factory'),all_file_map=require('./file.utils.all_file_map'),downloader,view_switch=require('./view_switch.view_switch'),file_path=require('./file_path.file_path'),rename=require('./file_list.rename.rename'),main_mod=require('main'),main_ui=main_mod.get('./ui'),FileListUIAbstract=require('./file_list.ui_abstract'),file_list,file_list_ui,remove,move,menu,selection,ColumnModel,cm,thumb,toolbar,set_timeout=setTimeout,add_dirs_queue=[],add_files_queue=[],cur_node,paging_helper,scroll_listening=false,is_batch_mode=false,batch_op_type,batch_without='',speed_reported=false,highlight_ids={},selected_ids={},ui_visible=false,doc=document,body=doc.body,$body=$(body),undefined;var ui_normal=new FileListUIAbstract('disk_file_list_ui_normal',{_$list_to:null,_$file_list:null,_$dir_list:null,_$lists:null,_column_model:null,render:function($list_to){toolbar=require('./toolbar.toolbar');file_list=require('./file_list.file_list');file_list_ui=require('./file_list.ui');menu=require('./file_list.menu.menu');require.async('downloader',function(mod){downloader=mod;});var me=this;$list_to.append(tmpl.file_list());me._$list_to=$list_to;me._$views=$list_to.children('.dirs-view, .files-view');me._$dirs_view=me._$views.filter('.dirs-view');me._$files_view=me._$views.filter('.files-view');var
$dir_list=me._$dir_list=$('#_disk_files_dir_list'),$file_list=me._$file_list=$('#_disk_files_file_list'),$lists=me._$lists=$dir_list.add($file_list),$list_sub_titles=me._$list_sub_titles=$('#_disk_files_file_title, #_disk_files_dir_title'),$no_files_tip=me._$no_files_tip=$('#_disk_files_empty');me._render_thumb();me._render_column_header();me._render_paging();me._render_enter();set_timeout(function(){me._render_selection();me._render_remove();me._render_move();me._render_rename();set_timeout(function(){me._render_drag_down();me._render_menu();me._render_ie6_fix();me._render_hightlight();me._render_batch_mode();},0);},0);me.on('on_batch_mode',function(is_batch_mode){var enable=!is_batch_mode;file_path.update(cur_node,enable);}).on('add_$items',function(){if(this.is_activated()&&ui_visible){this._update_list_view_status(null,null,true);this.trigger('list_height_changed');}}).on('close_create_dir',function(){if(this.is_activated()&&ui_visible){this._update_list_view_status(null,null,true);this.trigger('list_height_changed');}}).on('show',function(){if(this.is_activated()&&ui_visible){this._update_list_view_status();this.trigger('list_height_changed');}})},show:function($parent){this.render($parent);this.get_$views().show();this.trigger('show');ui_visible=true;},hide:function(){this.get_$views().hide();this.trigger('hide');ui_visible=true;},enter_dir:function(node){cur_node=node;},exit_dir:function(new_node,reset_ui){if(reset_ui){if(thumb)
thumb.clear_queue();if(selection)
selection.clear();}
this._clear_$items(false);},set_node_data:function(node,last_node,reset_ui){cur_node=node;var sort_meta=this._get_sort_meta(),datas=cm.sort_datas([node.get_kid_dirs()||[],node.get_kid_files()||[]],sort_meta.field,sort_meta.dir),dirs=datas[0]||[],files=datas[1]||[];this._set_$items(node,last_node,dirs,files);this._update_list_view_status(dirs.length>0,files.length>0,true);this._show_guide_tips_if(node);if(reset_ui){mini_tip.ok('文件列表已更新');}},append_$items:function(dirs,files,is_first_page){this.add_$items(dirs,files,is_first_page);},prepend_$items:function(dirs,files){var count=(dirs?dirs.length:0)+(files?files.length:0);if(count>1){console.warn('file_list_ui_normal.prepend_$items(...) 方法目前只支持追加一个文件，追加多个时排序会有问题');}
var files_html;dirs||(dirs=[]);files||(files=[]);if(dirs.length){files_html=tmpl.file_item({files:dirs,icon_map:this.get_icon_map()});this.get_$dir_list().prepend(files_html);}
if(files.length){files_html=tmpl.file_item({files:files,icon_map:this.get_icon_map()});this.get_$file_list().prepend(files_html);}
this.trigger('add_$items',[].concat(dirs,files),dirs,files);},insert_$items:function(dirs,files,index){var nodes,target_el,target_cache,rendered_dirs=[],rendered_files=[],target_rendered;if(dirs&&dirs.length){nodes=dirs;target_el=this.get_$dir_list();target_cache=add_dirs_queue;target_rendered=rendered_dirs;}else if(files&&files.length){nodes=files;target_el=this.get_$file_list();target_cache=add_files_queue;target_rendered=rendered_files;}else{return;}
var ui_elements=target_el.children(),ui_size=ui_elements.length;if(index<ui_size){$(ui_elements[index]).before(tmpl.file_item({files:nodes,icon_map:this.get_icon_map()}));Array.prototype.splice.apply(target_rendered,[0,0].concat(nodes));}else{if(target_cache.length){Array.prototype.splice.apply(target_cache,[index-ui_size,0].concat(nodes));}else{target_el.append(tmpl.file_item({files:nodes,icon_map:this.get_icon_map()}));Array.prototype.splice.apply(target_rendered,[0,0].concat(nodes));}}
this.trigger('add_$items',target_rendered,rendered_dirs,rendered_files);},add_$items:function(dirs,files,is_first_page){if(dirs&&dirs.length){add_dirs_queue=add_dirs_queue.concat(dirs);}
if(files&&files.length){add_files_queue=add_files_queue.concat(files);}
this.fill_$items(is_first_page);if(!scroll_listening){this._start_listen_scroll();}},fill_$items:function(is_first_page){if(is_first_page||paging_helper.is_reach_bottom()){this._add_$items_from_quque(is_first_page);}},_add_$items_from_quque:function(is_first_page){if(!add_dirs_queue.length&&!add_files_queue.length){this._stop_listen_scroll();this.trigger('add_$items',[]);return;}
var me=this,step_dirs,step_files,files_html,line_size=paging_helper.get_line_size(),line_count=paging_helper.get_line_count(is_first_page),add_count=line_size*line_count,dir_count=0;if(add_dirs_queue.length){var step_size=add_count;if(step_size>0){step_dirs=add_dirs_queue.splice(0,step_size);files_html=tmpl.file_item({files:step_dirs,icon_map:this.get_icon_map()});this.get_$dir_list().append(files_html);dir_count=step_dirs.length;}}
if(add_files_queue.length){var is_list=view_switch.is_list_view(),file_step_size;if(is_list){file_step_size=add_count-dir_count;console.debug('列表模式，已添加目录'+dir_count+'个；文件'+file_step_size+'个');}
else{var is_break_line=dir_count<add_count,add_dir_lines=Math.ceil(dir_count/line_size);file_step_size=is_break_line?line_size*(line_count-add_dir_lines):add_count;console.debug('缩略图模式，已添加目录'+add_dir_lines+'行共'+dir_count+'个；文件'+file_step_size+'个');}
if(file_step_size>0){step_files=add_files_queue.splice(0,file_step_size);files_html=tmpl.file_item({files:step_files,icon_map:this.get_icon_map()});this.get_$file_list().append(files_html);}}
if(!step_dirs){step_dirs=[];}
if(!step_files){step_files=[];}
this.trigger('add_$items',[].concat(step_dirs,step_files),step_dirs,step_files);if(!add_dirs_queue.length&&!add_files_queue.length){me._stop_listen_scroll();}},_ensure_visible:function(node){if(!node){return;}
var $item=this.get_$item(node&&node.get_id());if(!$item){return;}
var win=$(window),position=$item.offset(),file_list_position=this.get_$list_parent().offset(),max_visible_top=position.top-file_list_position.top,min_visible_top=position.top-win.height()+$item.height(),top=win.scrollTop(),need_scroll=false;if(top<min_visible_top){top=min_visible_top;need_scroll=true;}else if(top>max_visible_top){top=max_visible_top;need_scroll=true;}
if(need_scroll){scroller.go(top);}},_start_listen_scroll:function(){if(!scroll_listening){this.listenTo(global_event,'window_scroll window_resize',function(e){if(paging_helper.is_reach_bottom()){this._add_$items_from_quque(false);}});scroll_listening=true;}},_stop_listen_scroll:function(){if(scroll_listening){this.stopListening(global_event,'window_scroll');scroll_listening=false;add_dirs_queue=[];add_files_queue=[];}},remove_$items:function(file_nodes,animate){if(!file_nodes||!file_nodes.length)
return;var me=this,remove_fn=function(){$(this).remove();me.trigger('remove_$items');};if(file_nodes.length==1){var first=file_nodes[0],id=first.get_id(),$item=me.get_$item(id);if(animate){$item.fadeOut('fast',remove_fn);}else{remove_fn.apply($item);}}else{var ids;if(FileNode.is_instance(file_nodes[0])){ids=collections.map(file_nodes,function(file){return file.get_id();});}else{ids=file_nodes;}
var items=[];$.each(ids,function(i,id){var item=me.get_$item(id)[0];if(item){items.push(item);}});remove_fn.apply(items);}},_set_$items:function(node,last_node,dirs,files){this._clear_$items(true);this.append_$items(dirs,files,true);try{if(!speed_reported){m_speed.done('disk','root_list_show');set_timeout(function(){m_speed.send('disk');},5000);speed_reported=true;}}
catch(e){}},_clear_$items:function(silent){if(!this.is_rendered())return;this._stop_listen_scroll();var $dir_list=this.get_$dir_list(),$file_list=this.get_$file_list();if($dir_list)
$dir_list.empty();if($file_list)
$file_list.empty();if(!silent){this.trigger('clear_$items');this._update_list_view_status(false,false,false);}},reset:function(){this._clear_$items(false);},get_$item:function(file_id){return $('#_disk_file_item_'+file_id);},get_$items:function(ids){var me=this,items=$.map(ids,function(id){return me.get_$item(id).get(0);});return $(items);},update_$item:function(node,old_id){var $cur_item=this.get_$item(old_id||node.get_id());if(old_id){$cur_item.after(tmpl.file_item({files:[node],icon_map:this.get_icon_map()}));$cur_item.remove();}else{$cur_item.empty().html(tmpl.file_item({files:[node],icon_map:this.get_icon_map(),only_content:true}));}
this.trigger('update_$item',node);},show_$item_name:function(node,name){var $item=this.get_$item(node.get_id()),$file_name=$item.find('[data-name=file_name]');$file_name.text(name).css('display','');},get_$lists:function(){return this._$lists;},get_$dir_list:function(){return this._$dir_list;},get_$file_list:function(){return this._$file_list;},get_$views:function(){return this._$views;},get_$dirs_view:function(){return this._$dirs_view;},get_$files_view:function(){return this._$files_view;},get_$list_parent:function(){return this._$list_to;},get_$list_sub_titles:function(){return this._$list_sub_titles;},get_$no_files_tip:function(){return this._$no_files_tip;},mark_menu_on:function(el){this.clear_menu_mark();var
$more=$(el),$item=$more.closest('[data-file-id]');$item.addClass('selected');$more.addClass('actived');this._last_menu_on_item=$item;},_last_menu_on_item:null,clear_menu_mark:function(){if(this._last_menu_on_item){this._last_menu_on_item.removeClass('selected').find('[data-function="more"]').removeClass('actived');}},_set_batch_mode:function(_batch,_op_type,_without){if(is_batch_mode===_batch&&batch_op_type===_op_type&&batch_without===_without){return;}
is_batch_mode=_batch;batch_op_type=_op_type;batch_without=_without;this.trigger('on_batch_mode',is_batch_mode,batch_op_type,batch_without);global_event.trigger('disk_batch_mode',is_batch_mode,batch_op_type);},set_highlight_ids:function(ids){ids=ids||[];$.extend(highlight_ids,collections.array_to_set(ids));},is_view_switchable:function(){return true;},show_create_dir:function(){var temp_node,target_index=0;if(cur_node&&rename.is_idle()){temp_node=file_factory.create('FileNode',{is_dir:true,id:'_TEMP_ONLY_FOR_CREATE_',name:'',is_tempcreate:true});$.each(cur_node.get_kid_dirs(),function(index,node){if(node.is_sortable()){target_index=index;return false;}});file_list.add_node(temp_node,false,cur_node.get_id(),target_index);this._ensure_visible(temp_node);rename.start_edit(temp_node,function(success,new_name,properties){var old_id;if(success){old_id=temp_node.mark_create_success(properties);this.update_$item(temp_node,old_id);}else{file_list.remove_nodes([temp_node]);}},this);}},get_selected_$items:function(){return selection.get_selected_$items();},mark_$item_img_notfound:function(file){if(file&&file.get_parent()&&file.get_parent()===file_list.get_cur_node()){var $item=this.get_$item(file.get_id());if($item[0]){$item.empty().html(tmpl.file_item({files:[file],show_thumb:false,only_content:true,icon_map:this.get_icon_map()}));}}},mark_items_selected:function(file_ids){selected_ids=collections.array_to_set(file_ids);},get_file_by_$el:function($el){var file_id=$($el).closest('[data-file-id]').attr('data-file-id');return all_file_map.get(file_id);},highlight_items:function(id_set,files){var me=this,items=[],highlighted=[];for(var i=0,l=files.length;i<l;i++){var file_id=files[i].get_id();if(file_id in id_set){var $item=me.get_$item(file_id);if($item){items.push($item[0]);highlighted.push(file_id);}}}
var $items=$(items).addClass('hilight');set_timeout(function(){$items.removeClass('hilight');},6000);return highlighted;},toggle:function(visible){this._$views.toggle(visible);},is_batch_mode:function(){return is_batch_mode;},_get_sort_meta:function(){var view_name=view_switch.get_cur_view(),field,dir;switch(view_name){case'azlist':field='name';dir='asc';break;case'newestlist':field='modify_time';dir='desc';break;case'list':case'grid':default:field='name';dir='asc';break;}
return{field:field,dir:dir};},_render_paging:function(){var
item_width_thumb=120,item_height_thumb=101,item_width_list='auto',item_height_list=52;paging_helper=new Paging_Helper({$container:this.get_$list_parent(),item_width:view_switch.is_grid_view()?item_width_thumb:item_width_list,item_height:view_switch.is_grid_view()?item_height_thumb:item_height_list,fixed_height:0,is_list:view_switch.is_list_view()});this.listenTo(global_event,'page_header_height_changed',function(){var height=main_ui.get_fixed_header_height();paging_helper.set_fixed_height(height);});this.listenTo(view_switch,'switch',function(is_grid,is_list){paging_helper.set_item_width(is_grid?item_width_thumb:item_width_list);paging_helper.set_item_height(is_grid?item_height_thumb:item_height_list);paging_helper.set_is_list(is_list);});},_render_enter:function(){var me=this,is_enter_event=function(e){return!(e.ctrlKey||e.shiftKey||e.metaKey||!!$(e.target).closest('input, a, button, [data-function]')[0]);},enter_file=function(node,e){if(node.is_broken_file()||node.is_tempcreate()){return;}
if(node.is_dir()){file_list.load(node,true);}
else{if(node.is_preview_doc()){me.appbox_preview(node).fail(function(){me.preview_doc(node);});user_log('ITEM_CLICK_DOC_PREVIEW');}
else if(node.is_image()){me.appbox_preview(node).fail(function(){me.preview_image(node);});user_log('ITEM_CLICK_IMAGE_PREVIEW');}
else if(node.is_compress_file()){me.preview_zip_file(node);user_log('ITEM_CLICK_ZIP_PREVIEW');}
else{download_file(node,e);user_log('ITEM_CLICK_DOWNLOAD');}}},download_file=function(node,e){if(node.is_broken_file()){}
else{if(downloader){downloader.down(node,e);}else{console.log('downloader未初始化 -- down_file事件不能促发下载');}}},click_file_event=function(e){e.preventDefault();if(is_batch_mode||!is_enter_event(e)||!ie_click_hacker.is_click_event(e)){return;}
var node=me.get_file_by_$el(this);enter_file(node,e);},down_file_event=function(e){e.preventDefault();e.stopImmediatePropagation();var node=me.get_file_by_$el(this);download_file(node,e);$(e.target).toggle().toggle();};this.get_$dir_list().add(this.get_$file_list()).off('click.file_list','[data-file-id]').on('click.file_list','[data-file-id]',{selector:'[data-action=enter], [data-whole-click]'},click_file_event);this.get_$file_list().off('click.file_list','[data-function=download]').on('click.file_list','[data-function=download]',down_file_event);},_render_remove:function(){var me=this;remove=require('./file_list.file_processor.remove.remove');remove.render();me.listenTo(toolbar,'start_remove_files',function(){var files=selection.get_selected_files();if(files.length>0){remove.start_remove(files,'disk_toolbar_file_remove');}});me.get_$lists().on('click.file_list','[data-function="remove"]',function(e){e.preventDefault();var $item=$(this).closest('[data-file-id]');selection.select_but($item);var node=me.get_file_by_$el(this);remove.remove_confirm([node],'disk_contextmenu_file_remove');});},_render_move:function(){move=require('./file_list.file_processor.move.move');move.render();this.listenTo(toolbar,'start_move_files',function(){var files=selection.get_selected_files();if(files.length>0){move.show_move_to(files,'disk_toolbar_file_move');}}).listenTo(disk_event,'drag_and_drop_files_to',function(target_dir_id){var files=selection.get_selected_files(),target_node=all_file_map.get(target_dir_id);if(target_node.is_droppable()){move.start_move(files,target_node.get_parent().get_id(),target_node.get_id(),'disk_drag_file_move');}})},_render_selection:function(){selection=require('./file_list.selection.selection');selection.render({lists:this.get_$lists(),drop_list:this.get_$dir_list()});var me=this;this.on('add_$items update_$item',function(files){files=[].concat(files);if(!is_batch_mode){var drag_els=[],drop_els=[];$.each(files,function(i,f){var item_el=me.get_$item(f.get_id())[0];if(item_el){drag_els.push(item_el);if(f.is_droppable()){drop_els.push(item_el);}}});var $drag_els=$(drag_els),$drop_els=$(drop_els);selection.refresh_drag($drag_els);selection.refresh_drop($drop_els);selection.refresh_selection();}}).on('on_batch_mode',function(is_batch,op_type,without){selection.set_batch_mode(is_batch,without);if(is_batch){selection.disable_dragdrop();}else{selection.enable_dragdrop(without);}}).on('show',function(){selection.enable_selection();if(is_batch_mode){selection.disable_dragdrop();}else{selection.enable_dragdrop();}}).on('hide',function(){selection.disable_selection();selection.disable_dragdrop();});this.listenTo(file_list_ui,'activate',function(){if(this.is_activated()&&ui_visible){selection.enable_selection();if(is_batch_mode){selection.disable_dragdrop();}else{selection.enable_dragdrop();}}}).listenTo(file_list_ui,'deactivate',function(){selection.disable_selection();selection.disable_dragdrop();});this.on('sorted',function(){selection.clear();});$(document).on('keydown',function(e){if(e.ctrlKey||e.shiftKey){$body.addClass('ctrl-shift-pressed');}}).on('keyup',function(e){if(e.which===17||e.which===16){$body.removeClass('ctrl-shift-pressed');}}).on('mouseenter',function(e){if(!e.ctrlKey&&!e.shiftKey){$body.removeClass('ctrl-shift-pressed');}});},_render_drag_down:function(){if(constants.IS_APPBOX){var mouseleave='mouseleave.file_list_ddd_files';this.listenTo(selection,'before_drag_files',function($cur_item,cur_file,$sel_items,files){$body.off(mouseleave).one(mouseleave,function(e){selection.cancel_drag();if(downloader){downloader.drag_down(files,e);user_log('DISK_DRAG_DOWNLOAD');}else{console.log('downloader未初始化 -- 拖拽下载 不能触发');}});}).listenTo(selection,'stop_drag',function(){$body.off(mouseleave);});}
this.listenTo(file_list,'rebuild_file_list',function(){selection.cancel_drag();});},_render_menu:function(){menu.render();var me=this;var enable_menu=function(){disable_menu();me.listenTo(menu,'show_on',function(el){this.mark_menu_on(el);}).listenTo(menu,'hide',function(){this.clear_menu_mark();});me.get_$file_list().on('click.file_list','[data-function="more"]',function(e){e.preventDefault();var $on_el=$(this),$item=$on_el.closest('[data-file-id]');if(selection.select_but($item)){menu.show_more_menu($on_el);}});me.get_$lists().off('mousedown.file_list_context_menu').on('mousedown.file_list_context_menu','.ui-item',function(e){if(e.which===3||e.which===0){if($(e.target).closest('input, textarea, [data-function]').length==0){var can_show=true,$on_item=$(this);if(selection.is_selected($on_item)){can_show=true;}
else{can_show=selection.select_but($on_item);}
if(can_show){e.stopImmediatePropagation();menu.show_context_menu(e.pageX,e.pageY);}
if(e.handleObj.type==='contextmenu'){e.preventDefault();}}}});};var disable_menu=function(){me.stopListening(menu,'show_on').stopListening(menu,'hide');me.get_$file_list().off('click.file_list','[data-function="more"]');me.get_$lists().off('mousedown.file_list_context_menu contextmenu.file_list_context_menu').on('mousedown.file_list_context_menu contextmenu.file_list_context_menu');};var toggle_enable_menu=function(is_batch_mode){if(is_batch_mode){disable_menu();}else{enable_menu();}};me.on('on_batch_mode',toggle_enable_menu);me.listenTo(view_switch,'switch',function(){if(this.is_activated()&&ui_visible){this._update_list_view_status();var sort_meta=me._get_sort_meta();cm.sort(sort_meta.field,sort_meta.dir);var node=file_list.get_cur_node();me._set_$items(node,node,node.get_kid_dirs(),node.get_kid_files());}});toggle_enable_menu(is_batch_mode);},_render_column_header:function($column_model_to){ColumnModel=common.get('./ui.column_model.column_model');cm=new ColumnModel({el:$column_model_to,cols:[{field:'name',klass:'filename',title:'名称',val_get:function(it){return it.get_name().toLowerCase();}},{field:'modify_time',klass:'datetime',title:'更新时间',val_get:function(it){return it.get_modify_time();}},{field:'size',klass:'size',title:'大小',val_get:function(it){return it.get_size();}}],default_field:'modify_time',default_order:'desc',visible:false,klass:'',get_datas:function(field){var node=file_list.get_cur_node();if(node){var dirs_data=node.get_kid_dirs(),files_data=node.get_kid_files();if(field==='size'){dirs_data=[];}
return[dirs_data,files_data];}
return[];},before_comparator:function(node1,node2){var fixed1=!node1.is_sortable(),fixed2=!node2.is_sortable();if(fixed1){if(fixed2){return false;}
return-1;}else{if(fixed2){return 1;}
return 0;}}});cm.render();this.listenTo(cm,'sorted',function(datas,field){this.trigger('sorted');var dirs=datas[0],files=datas[1],node=file_list.get_cur_node();if(node){if(field==='size'){dirs=node.get_kid_dirs();}
node.set_nodes(dirs,files);}});},_render_rename:function(){var me=this;me.listenTo(toolbar,'enter_create_dir',function(){this.show_create_dir();}).listenTo(rename,'temp_save',function(node,new_name){if(node.get_name()!==new_name){this.show_$item_name(node,new_name);}}).listenTo(rename,'done',function(node,new_name){if(node.is_tempcreate()){return;}
if(node.get_name()!==new_name){node.set_name(new_name);this.update_$item(node);}
else{this.show_$item_name(node,node.get_name());}}).listenTo(rename,'deny',function(node){this.show_$item_name(node,node.get_name());});this.get_$dir_list().on('click.file_list','[data-function=rename]',function(e){e.preventDefault();var node=me.get_file_by_$el(this);rename.start_edit(node);});},_render_thumb:function(){var me=this;var Thumb=require('./file_list.thumb.thumb');thumb=new Thumb();me.on('add_$items set_$items update_$item',function(files){thumb.push(files);}).listenTo(thumb,'get_image_ok',function(file,img){set_image(file,img);}).listenTo(thumb,'get_image_error',function(file){this.mark_$item_img_notfound(file);});var default_images={'http://imgcache.qq.com/vipstyle/nr/box/img/img-70.png':1,'http://imgcache.qq.com/vipstyle/nr/box/img/img-32.png':1},set_image=function(file,img){var $item=me.get_$item(file.get_id()),$item_img=$item.find('img');if($item_img[0]){$item_img.attr('src',img.src).toggleClass('default',img.src in default_images);}};},_render_ie6_fix:function(){if($.browser.msie&&$.browser.version<7){this.get_$dir_list().on('mouseenter','>div',function(){$(this).addClass('hover');}).on('mouseleave','>div',function(){$(this).removeClass('hover');});this.get_$file_list().on('mouseenter','>div',function(){var $item=$(this),incomp=$item.hasClass('incomplete');$(this).addClass('hover '+(incomp?'ui-exclude-hover':''));}).on('mouseleave','>div',function(){$(this).removeClass('hover ui-exclude-hover');});}},_render_hightlight:function(){this.on('add_$items',function(files){if(!$.isEmptyObject(highlight_ids)){var highlighted=this.highlight_items(highlight_ids,files);for(var i=0,l=highlighted.length;i<l;i++){delete highlight_ids[highlighted[i]];}}});},_render_batch_mode:function(){this.listenTo(toolbar,'enter_default',function(){this._set_batch_mode(false,'default','[data-no-sel]');}).listenTo(toolbar,'enter_down_files',function(){this._set_batch_mode(true,'down','[data-no-sel],[data-no-down]');}).listenTo(toolbar,'enter_move_files',function(){this._set_batch_mode(true,'move','[data-no-sel],[data-no-move]');}).listenTo(toolbar,'enter_remove_files',function(){this._set_batch_mode(true,'remove','[data-no-sel],[data-no-remove]');});this._set_batch_mode(false,'default','[data-no-sel]');},_show_guide_tips_if:function(node){var user=query_user.get_cached_user();if(user){var uin=user.get_uin();if(node.is_net_fav_dir()&&!store.get(uin+'_intro_fav_dir_closed')){require.async('net_fav_migration',function(mod){var net_fav_migration=mod.get('./net_fav_migration');net_fav_migration.show_intro();store.set(uin+'_intro_fav_dir_closed',1);});}
else if(node.is_qq_disk_dir()&&!store.get(uin+'_intro_qq_disk_dir_closed')){require.async('qd_migration',function(mod){var qd_migration=mod.get('./qd_migration');qd_migration.show_intro();store.set(uin+'_intro_qq_disk_dir_closed',1);});}}},preview_image:function(file){var me=this;require.async(['image_preview','downloader'],function(image_preview_mod,downloader_mod){var image_preview=image_preview_mod.get('./image_preview'),downloader=downloader_mod,images=$.grep(file.get_parent().get_kid_files(),function(file){return file.is_image();}),sort_meta=me._get_sort_meta();images=cm.sort_datas([images],sort_meta.field,sort_meta.dir)[0];var index=$.inArray(file,images);image_preview.start({support_nav:false,total:images.length,index:index,get_url:function(index){var file=images[index];return downloader.get_down_url(file,{abs:'640*640'});},download:function(index,e){var file=images[index];if(file){downloader.down(file,e);}},remove:function(index,callback){var file=images[index];if(file){var remover=remove.remove_confirm([file],null,false);remover.on('has_ok',function(removed_file_ids){var file_id=removed_file_ids[0];for(var i=0,l=images.length;i<l;i++){if(file_id===images[i].get_id()){images.splice(i,1);break;}}
callback();});}}});});},_last_has_dirs:undefined,_last_has_files:undefined,_last_is_grid_view:undefined,_last_show_empty_tip:undefined,_update_list_view_status:function(_has_dirs,_has_files,show_empty_tip){if(!this.is_rendered())return;var
is_grid_view=view_switch.is_grid_view(),real_has_dirs=cur_node&&cur_node.get_kid_dirs()&&cur_node.get_kid_dirs().length>0,real_has_files=cur_node&&cur_node.get_kid_files()&&cur_node.get_kid_files().length>0,has_dirs=!!(typeof _has_dirs==='boolean'?_has_dirs:real_has_dirs),has_files=!!(typeof _has_files==='boolean'?_has_files:real_has_files);if(this._last_has_dirs!==has_dirs||this._last_has_files!==has_files||this._last_is_grid_view!==is_grid_view||this._last_show_empty_tip!==show_empty_tip){this.get_$list_sub_titles().toggle(is_grid_view&&has_files&&has_dirs);this.get_$file_list().toggle(has_files);this.get_$dir_list().toggle(real_has_dirs);if(typeof show_empty_tip==='boolean'){if(show_empty_tip!==false){this.get_$no_files_tip().toggle(!has_files&&!has_dirs);}else{this.get_$no_files_tip().hide();}}
this._last_has_dirs=has_dirs;this._last_has_files=has_files;this._last_is_grid_view=is_grid_view;this._last_show_empty_tip=show_empty_tip;}}});page_event.on('check_file_upload_draggable',function(){var cur_node=file_list.get_cur_node();return!is_batch_mode&&cur_node.is_dir()&&!cur_node.is_vir_dir();});return ui_normal;});define.pack("./file_list.ui_virtual",["weixin_css","lib","common","$","./tmpl","./view_switch.view_switch","./file_list.ui_abstract","./file.file_node","./file.utils.all_file_map","./file_list.file_list","./file_list.ui","./toolbar.toolbar","./file_list.file_processor.vir_remove.vir_remove","./file_list.thumb.thumb"],function(require,exports,module){require('weixin_css');var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),date_time=lib.get('./date_time'),easing=lib.get('./ui.easing'),security=lib.get('./security'),constants=common.get('./constants'),query_user=common.get('./query_user'),widgets=common.get('./ui.widgets'),mini_tip=common.get('./ui.mini_tip'),ie_click_hacker=common.get('./ui.ie_click_hacker'),PagingHelper=common.get('./ui.paging_helper'),request=common.get('./request'),urls=common.get('./urls'),user_log=common.get('./user_log'),tmpl=require('./tmpl'),view_switch=require('./view_switch.view_switch'),FileListUIAbstract=require('./file_list.ui_abstract'),FileNode=require('./file.file_node'),all_file_map=require('./file.utils.all_file_map'),file_list=require('./file_list.file_list'),file_list_ui=require('./file_list.ui'),toolbar=require('./toolbar.toolbar'),cur_node,thumb,vir_remove,downloader,page_helper,$list_to,$cur_view,$sub_view,$cur_dir_list,$cur_file_list,$cur_empty_tip,$all_list,$cur_pager,$voice_player,playing_voice,cur_is_classic=false,appended_ids={},cur_total=0,doc=document,$body,parse_int=parseInt,re_url=new RegExp("((http|https|ftp)\\:\\/\\/|\\bw{3}\\.)[a-z0-9\\-\\.]+\\.[a-z]{2,3}(:[a-z0-9]*)?\\/?([a-z\\u00C0-\\u017F0-9\\-\\._\\?\\,\\'\\/\\\\\\+&amp;%\\$#\\=~])*",'gi'),re_protocol=/^(?:(?:http|https|ftp):\/\/)/i,re_double_words=/[^\x00-\xFF]/,undefined;var ui_virtual=new FileListUIAbstract('disk_file_list_ui_virtual',{render:function(_$list_to){_$list_to.append(tmpl.vir_dir_file_list({empty_text:'没有了'}));$list_to=_$list_to;$body=$(doc.body);require.async('downloader',function(mod){downloader=mod;});this._render_thumb();this._render_pager();},enter_dir:function(node){cur_node=node;var is_thumb=node.has_image()||node.has_video();is_thumb?view_switch.temp_to_thumb():view_switch.temp_to_list();},exit_dir:function(new_node,reset_ui){if(cur_node!==new_node){this._clear_$items(true);if(thumb)
thumb.clear_queue();view_switch.exit_temp_view();this._update_pager();$cur_empty_tip.hide();}},set_node_data:function(node,last_node,dirs,files,is_reload,total){cur_node=node;cur_total=total;this._update_pager(total);if(is_reload){this._set_$items(dirs,files);}else{this.append_$items(dirs,files);this._loading(false);}
this._update_list_view_status(true);},show:function(){var is_classic=cur_is_classic=!(cur_node.has_text()||cur_node.has_voice()||cur_node.has_article()||cur_node.has_image()||cur_node.has_video());$cur_view=$list_to.children('[data-view='+(is_classic?'classic':'special')+']');if(is_classic){$cur_dir_list=$cur_view.find('[data-type=dir]');$cur_file_list=$cur_view.find('[data-type=file]');$sub_view=null;}else{$sub_view=$cur_view.children('[data-sub-view="'+(this.is_thumb_view(cur_node)?'thumb':'list')+'"]');$cur_dir_list=$sub_view.children('[data-type=dir]');$cur_file_list=$sub_view.children('[data-type=file]');}
$cur_empty_tip=$cur_view.find('[data-action=empty-tip]');$all_list=$cur_dir_list.add($cur_file_list);$cur_pager=$cur_view.find('[data-action="more"]');$cur_view.siblings('[data-view]').hide();if($sub_view){$sub_view.siblings('[data-sub-view]').hide();}
$body.toggleClass('app-chat',cur_node.has_text()||cur_node.has_voice()).toggleClass('app-blog',cur_node.has_article());this._render_enter();this._render_remove();this._render_ie6();$cur_view.show();if($sub_view){$sub_view.show();}
toolbar.hide();},hide:function(){$cur_view.hide();if($sub_view){$sub_view.hide();}
$cur_view=$sub_view=$cur_dir_list=$cur_file_list=$cur_empty_tip=$all_list=$cur_pager=null;toolbar.show();},append_$items:function(dirs,files){var me=this,filter=function(file){if(appended_ids[file.get_id()]){me._update_$item(file);}else{return true;}};dirs=$.grep(dirs,filter);files=$.grep(files,filter);if(dirs.length){var dirs_html=tmpl.vir_dir_file_item({files:dirs,icon_map:this.get_icon_map()});$cur_dir_list.append(dirs_html);$.each(dirs,function(i,file){appended_ids[file.get_id()]=1;});}
if(files.length){var files_html=tmpl.vir_dir_file_item({files:files,icon_map:this.get_icon_map()});$cur_file_list.append(files_html);$.each(files,function(i,file){appended_ids[file.get_id()]=1;});}
this.trigger('add_$items',files);},remove_$items:function(file_nodes,animate){if(!file_nodes||!file_nodes.length)
return;var me=this,remove_fn=function(ids){$.each(ids,function(i,id){delete appended_ids[id];});$(this).remove();me.trigger('remove_$items');me._update_list_view_status(true);};if(file_nodes.length==1){var first=file_nodes[0],id=first.get_id(),$item=me.get_$item(id);if(animate){$item.fadeOut('fast',remove_fn);}else{remove_fn.call($item,[id]);}}else{var ids;if(FileNode.is_instance(file_nodes[0])){ids=collections.map(file_nodes,function(file){return file.get_id();});}else{ids=file_nodes;}
var items=[];$.each(ids,function(i,id){var item=me.get_$item(id)[0];if(item){items.push(item);}});remove_fn.call(items,ids);}},is_view_switchable:function(){return false;},is_thumb_view:function(node){return!!node&&node.has_image()||node.has_video();},_update_$item:function(node){var $item=this._get_$item(node);if($item){$item.replaceWith(tmpl.vir_dir_file_item({files:[node],icon_map:this.get_icon_map()}));console.log('update_$item ok -> '+node.get_id());this.trigger('update_$item',node);}},_set_$items:function(dirs,files){this._clear_$items(true);this.append_$items(dirs,files);},_clear_$items:function(silent){if(!this.is_rendered())return;if($all_list)
$all_list.empty();appended_ids={};if(!silent){this.trigger('clear_$items');this._update_list_view_status(true);}},_load_more:function(size){var offset=cur_node.get_kid_nodes()?cur_node.get_kid_nodes().length:0;if(offset<cur_total){size=size||this._get_page_size(cur_node);return file_list.load_vir_dir(cur_node,offset,size);}},_render_enter:function(){var me=this,is_enter_event=function(e){return!(e.ctrlKey||e.shiftKey||e.metaKey||!!$(e.target).closest('input, a, button, [data-function]')[0]);},enter_file=function(node,e){if(node.is_dir()){file_list.load_vir_dir(node,0,me._get_page_size(node));}
else{if(node.is_broken_file()){}
else{if(node.class_name==='ArticleNode'){require.async('third_party_iframe',function(m){var third_party_iframe=m.get('./third_party_iframe');var preview=third_party_iframe.create_preview({url:node.get_raw_url()});preview.show();});}
else if(node.is_preview_doc()){me.appbox_preview(node).fail(function(){me.preview_doc(node);});user_log('ITEM_CLICK_DOC_PREVIEW');}
else if(node.is_image()){me.appbox_preview(node).fail(function(){me.preview_image(node);});user_log('ITEM_CLICK_IMAGE_PREVIEW');}
else if(node.is_compress_file()){me.preview_zip_file(node);user_log('ITEM_CLICK_ZIP_PREVIEW');}
else{download_file(node,e);user_log('ITEM_CLICK_DOWNLOAD');}}}},download_file=function(node,e){if(node.is_broken_file()){}
else{if(downloader){var url=me._get_down_url(node,false);downloader.down_url(url,node.get_name(),node.get_size());}else{console.log('downloader未初始化 -- down_file事件不能促发下载');}}},click_file_event=function(e){e.preventDefault();if(!is_enter_event(e)||!ie_click_hacker.is_click_event(e)){return;}
var node=me._get_file_by_$el(this);enter_file(node,e);},down_file_event=function(e){e.preventDefault();e.stopImmediatePropagation();var node=me._get_file_by_$el(this);download_file(node,e);$(e.target).toggle().toggle();};$all_list.off('click.file_list','[data-action="enter"]').on('click.file_list','[data-action="enter"]',click_file_event);$cur_file_list.off('click.file_list','[data-action=download]').on('click.file_list','[data-action=download]',down_file_event).off('click.file_list','[data-action="text-expand"],[data-action="text-collapse"]').on('click.file_list','[data-action="text-expand"],[data-action="text-collapse"]',function(e){e.preventDefault();var expand=$(this).attr('data-action')==='text-expand';me._toggle_text_expand($(this).closest('[data-file-id]').attr('data-file-id'),expand);$(this).text(expand?'点击收起':'点击展开').attr('data-action',expand?'text-collapse':'text-expand');}).off('click.file_list','[data-action="play-voice"]').on('click.file_list','[data-action="play-voice"]',function(e){e.preventDefault();var voice_node=me._get_file_by_$el(this);if(voice_node){me._play_voice(voice_node);}});},_render_remove:function(){var me=this;vir_remove=require('./file_list.file_processor.vir_remove.vir_remove');vir_remove.render();$all_list.off('click.file_list','[data-action="remove"]').on('click.file_list','[data-action="remove"]',function(e){e.preventDefault();var node=me._get_file_by_$el(this);me._remove_file(node);});},_render_pager:function(){var me=this;$list_to.children('[data-view]').off('click.file_list','[data-action="more"]').on('click.file_list','[data-action="more"]',function(e){e.preventDefault();me._loading(true);me._load_more();});},_render_thumb:function(){var Thumb=require('./file_list.thumb.thumb');thumb=new Thumb({cgi_url:'http://web.cgi.weiyun.com/weiyun_web_vircgi.fcg',cgi_cmd:'batch_download_virtual_file',cgi_data:function(files){return{pdir_key:cur_node.get_id(),files:$.map(files,function(file){return{file_id:file.get_id(),file_name:file.get_name()};})};},cgi_response:function(files,body){var imgs=body['files'];if(imgs){return $.map(imgs,function(img_rsp){var ret=parse_int(img_rsp['retcode']),url,file_id;if(ret==0){var host=img_rsp['dl_svr_host'],port=img_rsp['dl_svr_port'],path=img_rsp['dl_encrypt_url'];url='http://'+host+':'+port+'/ftn_handler/'+path+'?size=128*128';file_id=img_rsp['file_id'];}
return new Thumb.ImageMeta(ret,file_id,url);})}}});var me=this;me.on('add_$items set_$items update_$item',function(files){thumb.push(files);}).listenTo(thumb,'get_image_ok',function(file,img){set_image(file,img);}).listenTo(thumb,'get_image_error',function(file){set_image(file);});var default_image='http://imgcache.qq.com/vipstyle/nr/box/img/img-70.png',set_image=function(file,img){var $item=me._get_$item(file.get_id()),$item_img;if($item&&($item_img=$item.find('img'))[0]){if(img){$item_img.attr('src',img.src);}else{$item_img.attr('src',default_image);}
$item_img.css('visibility','');}};},_render_ie6:function(){$all_list.off('mouseenter mouseleave','.ui-item').on('mouseenter','.ui-item',function(e){$(this).addClass('hover');}).on('mouseleave','.ui-item',function(e){$(this).removeClass('hover');});},preview_image:function(node){var me=this;require.async(['image_preview'],function(image_preview_mod){var image_preview=image_preview_mod.get('./image_preview'),files=node.get_parent().get_kid_files(),index=$.inArray(node,files);image_preview.start({support_nav:true,total:cur_total,index:index,get_url:function(index){if(index===files.length-1){console.log('load more');var def=me._load_more();if(def){def.done(function(){image_preview._update_status();});}}
var file=files[index];if(file&&file.is_image()){var major_url=me._get_down_url(file,true);return major_url;}},has_next:function(index){for(var i=index;i<files.length;i++){var file=files[i+1];if(file&&file.is_image()){return true;}}
return false;},download:function(index){var file=files[index];if(file){var raw_url=me._get_down_url(file,false);downloader.down_url(raw_url,file.get_name(),file.get_size());}},remove:function(index,callback){var file=files[index];if(file){me._remove_file(file).done(function(){callback()});}}});});},_get_file_by_$el:function($el){var file_id=$($el).closest('[data-file-id]').attr('data-file-id');return all_file_map.get(file_id);},_get_$item:function(node_or_id){var id;if(typeof node_or_id==='string'){id=node_or_id;}else if(FileNode.is_instance(node_or_id)){id=node_or_id.get_id();}
var $item=id?$('#_disk_vdir_item_'+id):null;return $item&&$item[0]?$item:null;},_toggle_text_expand:function(text_id,expand){var me=this,$el=this._get_$item(text_id),$texts=$el.find('[data-name="short-text"], [data-name="long-text"]'),$short=$texts.eq(0),$long=$texts.eq(1);$short.toggle(!expand);$long.toggle(expand);me.trigger('list_resized');},_play_voice:function(voice_node){var me=this,url=voice_node.get_url(),$msg=me._get_$item(voice_node.get_id()),$play=$msg.find('[data-action="play-voice"]'),$play_time=$play.siblings('[data-action="play-time"]'),$play_loading=$play.siblings('[data-action="play-loading"]');if(playing_voice){var $last_msg=me._get_$item(playing_voice.get_id()),$last_play=$last_msg.find('[data-action="play-voice"]'),$last_play_time=$last_play.siblings('[data-action="play-time"]'),$last_play_loading=$last_play.siblings('[data-action="play-loading"]')
$last_play.removeClass('audio-playing');$last_play_loading.hide();$last_play_time.show();}
playing_voice=voice_node;var title=doc.title;require.async('jquery_jplayer',function(){me._get_$voice_player().off($.jPlayer.event.error).on($.jPlayer.event.error,function(ev){var err_type=ev.jPlayer.error.type;if(err_type==$.jPlayer.error.FLASH||err_type==$.jPlayer.error.FLASH_DISABLED||err_type==$.jPlayer.error.NO_SOLUTION){widgets.alert.warn({msg:'您还没有安装flash播放器，请点击<a href="http://www.adobe.com/go/getflash" target="_blank">这里</a>安装',button_text:'确定'});}}).jPlayer('destroy').jPlayer({swfPath:constants.DOMAIN+'/web/flash/',supplied:"mp3",solution:'flash',wmode:"window",ready:function(){$(this).jPlayer("setMedia",{mp3:url}).jPlayer('play');$play_time.hide();$play_loading.show();},progress:function(){$play.addClass('audio-playing');$play_loading.hide();doc.title=title;},ended:function(){$play.removeClass('audio-playing');$play_loading.hide();$play_time.show();playing_voice=undefined;}});});},_get_$voice_player:function(){return $voice_player||($voice_player=$('<div data-jplayer style="width:0;height:0;position:absolute;"/>').appendTo(doc.body));},_get_page_size:function(node){if(!page_helper){page_helper=new PagingHelper({$container:null,item_width:0,item_height:0,fixed_height:$cur_view.offset().top});}
var is_thumb=this.is_thumb_view(node);page_helper.set_$container($cur_view);page_helper.set_item_width(is_thumb?136:0);page_helper.set_item_height(is_thumb?136:106);page_helper.set_is_list(!is_thumb);var size=Math.max(page_helper.get_line_size()*page_helper.get_line_count(true),10);return size;},_update_pager:function(total){var kid_len=cur_node.get_kid_nodes()?cur_node.get_kid_nodes().length:0;$cur_pager.css('visibility',(!!total&&kid_len<total)?'':'hidden');},_loading:function(loading){$cur_pager.html(loading?'加载中...':'加载更多');},_set_$item_img:function(file,src){var $item=this._get_$item(file.get_id()),$img=$item.find('img');if($img[0]){if(src){$img.attr('src',src).removeClass('default');}else{$img.attr('src','http://imgcache.qq.com/vipstyle/nr/box/img/img-70.png');}}},_get_down_url:function(node,is_preview){var down_name=downloader.get_down_name(node.get_name()),uin=query_user.get_uin(),skey=query_user.get_skey(),header={cmd:'download_virtual_file',appid:constants.IS_APPBOX?30012:30013,proto_ver:20130708,token:security.getAntiCSRFToken(),uin:uin},body={file_owner:uin,pdir_key:cur_node.get_id(),file_id:node.get_id(),file_name:down_name},params={data:{req_header:header,req_body:body},uin:uin,skey:skey};if(is_preview){body.size='640*640';}
else{params.err_callback=constants.DOMAIN+'/web/callback/iframe_disk_down_fail.html';}
return urls.make_url('http://webcgi.weiyun.qq.com/weiyun_web_vircgi.fcg',params);},_remove_file:function(node){var me=this;var thing_map={ArticleNode:'文章',VoiceNode:'消息',PlaintextNode:'消息'},thing=thing_map[node.class_name]||(node.is_dir()?'文件夹':'文件'),ok_callback=function(){mini_tip.ok('删除成功');me._get_$item(node).fadeOut('fast',function(){$(this).remove();me._load_more(1);});};var def=vir_remove.remove_confirm(node,thing,node.get_name()).done(function(){ok_callback();}).fail(function(msg,ret){if(ret===10005){ok_callback();}
else if(msg){mini_tip.error(msg);}});return def;},_last_has_dirs:undefined,_last_has_files:undefined,_last_show_empty_tip:undefined,_update_list_view_status:function(show_empty_tip){if(!this.is_rendered())return;var
has_dirs=cur_node&&cur_node.get_kid_dirs()&&cur_node.get_kid_dirs().length>0,has_files=cur_node&&cur_node.get_kid_files()&&cur_node.get_kid_files().length>0;show_empty_tip=show_empty_tip!==false;if(this._last_has_dirs!==has_dirs||this._last_has_files!==has_files||this._last_show_empty_tip!==show_empty_tip){$cur_file_list.toggle(has_files);$cur_dir_list.toggle(has_dirs);if(show_empty_tip){var has_data=has_files||has_dirs;$cur_empty_tip.toggle(!has_data).text('您还没有保存任何'+cur_node.get_name()+'内容');if($sub_view){$sub_view.toggle(has_data);}}else{$cur_empty_tip.hide();}
$cur_pager.toggle(has_files||has_dirs);this._last_has_dirs=has_dirs;this._last_has_files=has_files;this._last_show_empty_tip=show_empty_tip;}},fix_user_text:function(str,len){if(!str||!(typeof str==='string'))return'';var me=this;var texts=[],is_urls={},last_end=0,i=0;var match;while(match=re_url.exec(str)){var url=match[0],start=match.index,end=start+url.length,left_text=str.substring(last_end,start);texts.push(left_text);texts.push(url);is_urls[texts.length-1]=url;last_end=end;i++;}
if(last_end<str.length-1){texts.push(str.substr(last_end));}
if(len>0){texts=me._smart_sub_arr(texts,len);}
texts=$.map(texts,function(str,i){var url;if(i in is_urls&&str===(url=is_urls[i])){if(!re_protocol.test(url)){url='http://'+url;}
return'<a href="'+url+'" target="_blank">'+str+'</a>';}
else{return text.text(str);}});return texts.join('');},_smart_sub_arr:function(str,len){var arr=str,results=[],stop_arr_index=-1,stop_chr_index=-1,chr_index=-1,index=0;len*=2;for(var m=0,n=arr.length;m<n;m++){var s=arr[m];for(var i=0,l=s.length;i<l;i++){chr_index++;if(re_double_words.test(s.charAt(i))){index+=2;}else{index++;}
if(index>len){stop_chr_index=i;break;}}
if(stop_chr_index!==-1){stop_arr_index=m;break;}}
if(stop_arr_index!==-1&&stop_chr_index!==-1){results=arr.slice(0,stop_arr_index);results.push(arr[stop_arr_index].substr(0,stop_chr_index)+'..');}else{results=arr;}
return results;}});return ui_virtual;});define.pack("./file_path.file_path",["lib","common","$","./file.utils.all_file_map","./file_path.ui"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),Module=common.get('./module'),disk_event=common.get('./global.global_event').namespace('disk'),all_file_map=require('./file.utils.all_file_map'),file_list,cur_node,last_enable,undefined;var file_path=new Module('disk_file_path',{ui:require('./file_path.ui'),update:function(file_node,enable){enable=enable!==false;if(file_node===cur_node&&enable===last_enable){return;}
if(file_node){var nodes=[],node=file_node;while((node.get_parent()&&!node.get_parent().is_super())&&(node=node.get_parent())){nodes.push(node);}
nodes.reverse();nodes.push(file_node);cur_node=file_node;last_enable=enable;this.trigger('update',nodes,enable);}}});return file_path;});define.pack("./file_path.ui",["lib","common","$","./tmpl","./file_list.file_list","./file_path.file_path","./file_list.selection.selection"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),global_event=common.get('./global.global_event'),disk_event=common.get('./global.global_event').namespace('disk'),Module=common.get('./module'),user_log=common.get('./user_log'),tmpl=require('./tmpl'),file_list,file_path,selection,droppable_options={scope:'move_file',tolerance:'pointer',hoverClass:'ui-dropping',drop:function(e,ui){var target_dir_id=$(e.target).closest('[data-file-id]').attr('data-file-id');disk_event.trigger('drag_and_drop_files_to',target_dir_id);user_log('DISK_DRAG_BREAD');}},undefined;var ui=new Module('disk_file_path_ui',{render:function($to){file_list=require('./file_list.file_list');file_path=require('./file_path.file_path');selection=require('./file_list.selection.selection');this._$el=$to;this.listenTo(file_path,'update',function(nodes,enable){this.update_$nodes(nodes,enable);});this.on('click_path',function(dir_id){file_list.load(dir_id,true);});},update_$nodes:function(nodes,enable){var me=this;me.destroy();var $el=$(tmpl.file_path({nodes:nodes,enable:!!enable}));me._$el.replaceWith($el);me._$el=$el;$el.on('click','[data-file-id]',function(e){e.preventDefault();me.trigger('click_path',$(this).attr('data-file-id'));});var $droppable_nodes=$el.find('[data-file-id][data-cur-node!=true]');require.async('jquery_ui',function(){if($droppable_nodes.parent()[0]){$droppable_nodes.droppable(droppable_options);}});if($.browser.msie&&$.browser.version<7){$el.on('mouseenter','td',function(){$(this).addClass('hover');}).on('mouseleave','td',function(){$(this).removeClass('hover');});}
var active_el;if($.browser.msie||$.browser.opera){var $body=$(document.body);$el.on('mousedown','td',function(){active_el=$(this);active_el.addClass('active');$body.one('mouseup',function(){if(active_el){active_el.removeClass('active');active_el=null;}});});}},destroy:function(){var $items=this._$el.children('[data-file-id]');$items.each(function(i,item){if($.data(item,'droppable')){$(item).droppable('destroy');}});this._$el.empty();}});return ui;});define.pack("./mini_tip.mini_tip",["lib","common","$","./tmpl"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),Module=common.get('./module'),tmpl=require('./tmpl'),delay_min=4,delay_max=6,second_every_letter=1,t,undefined;var mini_tip=new Module('disk_mini_tip',{render:function($to){this._$el=$(tmpl.mini_tip());$to.replaceWith(this._$el);},_msg:function(type,msg,second){if(!msg)
return;msg=msg.toString();clearTimeout(t);var $el=this._$el.removeClass('ui-tips-ok ui-tips-warn ui-tips-err').addClass('ui-tips-'+type).html(msg).stop(false,true).fadeIn();var delay=second>0?second:Math.min(Math.max(msg.length*second_every_letter,delay_min),delay_max);t=setTimeout(function(){$el.fadeOut();},delay*1000);},ok:function(msg,sec){this._msg('ok',msg,sec);},warn:function(msg,sec){this._msg('warn',msg,sec);},error:function(msg,sec){this._msg('err',msg,sec);}});return mini_tip;});define.pack("./toolbar.toolbar",["lib","common","$","./tmpl","./file_list.file_list","./file_list.selection.selection"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),events=lib.get('./events'),routers=lib.get('./routers'),constants=common.get('./constants'),Module=common.get('./module'),global_event=common.get('./global.global_event'),disk_event=common.get('./global.global_event').namespace('disk'),tmpl=require('./tmpl'),file_list=require('./file_list.file_list'),selection=require('./file_list.selection.selection'),$body=$(document.body),$cur_bar,undefined;var toolbar=new Module('disk_toolbar',{_last_type:undefined,render:function($to){this._$container=$to.empty();this.get_$main_bar();this.on('activate',function(){this.switch_toolbar(this._last_type||'default');}).on('deactivate',function(){var type=this._last_type;this.switch_toolbar((type&&type!=='none')?type:'default');})},get_$main_bar:function(create){if(create!==false){if(!this._$main_bar){var me=this;this._$main_bar=$(tmpl.main_toolbar()).hide().appendTo(this._$container).on('click','[data-action=manage]',function(e){e.preventDefault();me._toggle_manage_menu(this);}).on('click','[data-action=download]',function(e){e.preventDefault();me.trigger('enter_download');me.switch_toolbar('down_files');}).on('click','[data-action=reload]',function(e){e.preventDefault();me.trigger('click_reload');}).on('click','[data-action=upload]',function(e){e.preventDefault();me.trigger('upload_init',this);}).on('mouseover','[data-action=upload]',function(e){e.preventDefault();me.trigger('upload_mouseover');}).on('click','[data-action=move_files]',function(e){e.preventDefault();me.trigger('enter_move_files');me.switch_toolbar('move_files');}).on('click','[data-action=remove_files]',function(e){e.preventDefault();me.trigger('enter_remove_files');me.switch_toolbar('remove_files');}).on('click','[data-action=create_dir]',function(e){e.preventDefault();me.trigger('enter_create_dir');}).on('click','[data-action=recycle]',function(e){e.preventDefault();routers.go({m:'recycle'});});}
return this._$main_bar;}else{return this._$main_bar||$();}},get_$down_bar:function(create){if(create!==false){if(!this._$down_bar){var me=this;this._$down_bar=$(tmpl.download_toolbar()).hide().appendTo(this._$container).on('click','[data-action=back]',function(e){e.preventDefault();me.switch_to_default();}).on('click','[data-action=start_down_files]',function(e){e.preventDefault();me.trigger('start_download',e);}).on('click','[data-action=down_holder]',function(e){e.preventDefault();});}
return this._$down_bar;}else{return this._$down_bar||$();}},get_$move_bar:function(create){if(create!==false){if(!this._$move_bar){var me=this;this._$move_bar=$(tmpl.move_toolbar()).hide().appendTo(this._$container).on('click','[data-action=back]',function(e){e.preventDefault();me.switch_to_default();}).on('click','[data-action=start_move_files]',function(e){e.preventDefault();me.trigger('start_move_files');}).on('click','[data-action=move_holder]',function(e){e.preventDefault();});}
return this._$move_bar;}else{return this._$move_bar||$();}},get_$remove_bar:function(create){if(create!==false){if(!this._$remove_bar){var me=this;this._$remove_bar=$(tmpl.remove_toolbar()).hide().appendTo(this._$container).on('click','[data-action=back]',function(e){e.preventDefault();me.switch_to_default();}).on('click','[data-action=start_remove_files]',function(e){e.preventDefault();me.trigger('start_remove_files');}).on('click','[data-action=remove_holder]',function(e){e.preventDefault();});}
return this._$remove_bar;}else{return this._$remove_bar||$();}},_get_$manage_menu:function($on){$on=$($on);var me=this,$menu=me._$manage_menu;if(!$menu){var on_position=$on.position();$menu=me._$manage_menu=$(tmpl.toolbar_manage_menu()).hide().css({left:on_position.left,top:on_position.top+$on.outerHeight(),marginLeft:-1,marginTop:-1}).on('click','[data-action]',function(e){e.preventDefault();}).on('click','[data-action=move_files]',function(e){me.trigger('enter_move_files');me.switch_toolbar('move_files');}).on('click','[data-action=remove_files]',function(e){me.trigger('enter_remove_files');me.switch_toolbar('remove_files');}).on('click','[data-action=create_dir]',function(e){me.trigger('enter_create_dir');});this._$main_bar.after($menu);}
return $menu;},_get_$upload_button:function(){return this._$main_bar.find('a[data-action=upload]');},_toggle_manage_menu:function($on,show){var me=this,$menu=this._get_$manage_menu($on);$menu.stop(true,false);show=typeof show!=='boolean'?!$menu.is(':visible'):show;(show?$.fn.fadeIn:$.fn.fadeOut).call($menu,100);$body.off('click.hide_toolbar_manage_menu');if(show){setTimeout(function(){$body.on('click.hide_toolbar_manage_menu',function(e){if($(e.target).closest($on).length===0){me._toggle_manage_menu($on,false);}});},0);}},switch_to_default:function(){this.switch_toolbar('default');},toggle_download_icon:function(start_btn,type){if(type==='down_files'){start_btn.find('.icon_mv').attr('class','icon_download');}},switch_toolbar:function(type){var me=this,$holder,$start_btn,update_btn=$.noop,need_update_btn=false;this.stopListening(global_event,['disk_start_down_files','disk_selected_files','disk_file_remove_has_removed','disk_file_remove_all_removed','disk_file_move_has_moved','disk_file_move_all_moved'].join(' '));switch(type){case'default':$cur_bar=this.get_$main_bar();break;case'down_files':$cur_bar=this.get_$down_bar();$holder=$cur_bar.find('[data-action=down_holder]');$start_btn=$cur_bar.find('[data-action=start_down_files]');need_update_btn=true;this.toggle_download_icon($start_btn,type);this.listenTo(global_event,'disk_start_down_files',function(){me.switch_to_default();});break;case'move_files':$cur_bar=this.get_$move_bar();$holder=$cur_bar.find('[data-action=move_holder]');$start_btn=$cur_bar.find('[data-action=start_move_files]');need_update_btn=true;this.listenTo(global_event,'disk_file_move_has_moved',function(){update_btn();}).listenTo(global_event,'disk_file_move_all_moved',function(){me.switch_to_default();me.trigger('close_move_files');});break;case'remove_files':$cur_bar=this.get_$remove_bar();$holder=$cur_bar.find('[data-action=remove_holder]');$start_btn=$cur_bar.find('[data-action=start_remove_files]');need_update_btn=true;this.listenTo(global_event,'disk_file_remove_has_removed',function(){update_btn();}).listenTo(global_event,'disk_file_remove_all_removed',function(){me.switch_to_default();me.trigger('close_remove_files');});break;case'none':$cur_bar=null;break;default:throw'toolbar.switch_toolbar(type) -> 无效的type参数：'+type;}
if(need_update_btn){update_btn=function(){var len=selection.get_selected_$items().length,has_files=len>0;$holder.toggle(!has_files);$start_btn.toggle(has_files).find('._n').text(len);};this.listenTo(global_event,'disk_selected_files',update_btn);update_btn();}
this._last_type=type;if(type!=='none'){$cur_bar.siblings().hide();$cur_bar.show();}else{this.get_$main_bar(false).hide();this.get_$down_bar(false).hide();this.get_$move_bar(false).hide();this.get_$remove_bar(false).hide();}
this.trigger('enter_'+type);},_toggle:function(visible){this._$container.toggle(visible);},show:function(){this._toggle(true);},hide:function(){this._toggle(false);}});module.exports=toolbar;});define.pack("./ui",["disk_css","lib","common","$","./tmpl","./disk","./view_switch.view_switch","./file_list.file_list","./file_list.ui"],function(require,exports,module){require('disk_css');var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),routers=lib.get('./routers'),Module=common.get('./module'),query_user=common.get('./query_user'),user_log=common.get('./user_log'),global_event=common.get('./global.global_event'),global_function=common.get('./global.global_function'),upload_event=common.get('./global.global_event').namespace('upload'),page_event=common.get('./global.global_event').namespace('page'),constants=common.get('./constants'),mini_tip=common.get('./ui.mini_tip'),tmpl=require('./tmpl'),disk,view_switch,file_list,file_list_ui,$win=$(window),fix_body_bottom,undefined;var ui=new Module('disk_ui',{render:function($header_box,$body_box){disk=require('./disk');view_switch=require('./view_switch.view_switch');file_list=require('./file_list.file_list');file_list_ui=require('./file_list.ui');this.get_$header().appendTo($header_box);this.get_$body().appendTo($body_box);this.listenTo(view_switch,'switch',function(){this._update_view();}).listenTo(global_event,'disk_batch_mode',function(batch,op_type){this._set_selection_view(batch,op_type);}).listenTo(query_user,'error',function(msg){mini_tip.error(msg);}).listenTo(file_list_ui,'list_height_changed',function(){this._fix_view_height_delay();});this.on('activate',function(){this._update_view();this.get_$header().show();if($.browser.msie&&parseInt($.browser.version,10)<=7){this.get_$header().repaint();}
this.get_$body().show();this.listenTo(global_event,'window_resize',function(){this._fix_view_height_delay();});this._fix_view_height();document.title='微云';}).on('deactivate',function(){this.get_$header().hide();this.get_$body().hide();this.stopListening(global_event,'window_resize');});},_update_view:function(){var $view=this.get_$view();$view.toggleClass('ui-thumbview',view_switch.is_grid_view()).toggleClass('ui-listview',view_switch.is_list_view());if($.browser.webkit){$view.toggle().toggle();}},_set_selection_view:function(batch,op_type){this.get_$body().toggleClass('selection-view',!!batch);var view=this.get_$view()[0];var org_class=view.className,new_class=org_class.replace(new RegExp('\\s*view\\-when\\-\\w+\\s*','g'),' ');if(op_type){new_class+=' view-when-'+op_type;}
if(org_class!==new_class){view.className=new_class;}},get_$header:function(){if(!this._$header){this._$header=$(tmpl.header({module:this}));}
return this._$header;},get_$body:function(){if(!this._$body){this._$body=$(tmpl.body({module:this}));}
return this._$body;},get_$view:function(){return $('#_disk_view');},get_$toolbar:function(){return $('#_disk_toolbar_container');},get_$column_model:function(){return $('#_disk_list_column_model');},get_$file_path:function(){return $('#_disk_file_path');},get_$mini_tip:function(){return $('#_disk_mini_tips');},get_$space_info:function(){return $('#_disk_space_info');},get_$view_switch:function(){return $('#_disk_view_switch');},get_header_placeholder:function(){return $('#_header_placeholder');},_fix_view_timer:null,_fix_view_height_delay:function(){clearTimeout(this._fix_view_timer);this._fix_view_timer=setTimeout($.proxy(this._fix_view_height,this),0);},_fix_view_height:function(){var $view=this.get_$view(),$body=this.get_$body();$view.css('height','');var offset_top=$view.offset().top,view_out_height=$view.outerHeight(true),view_height=$view.height(),win_height=$win.height(),new_height='';if(typeof fix_body_bottom!=='number'){fix_body_bottom=(parseInt($body.css('padding-bottom'))||0)+(parseInt($body.css('margin-bottom'))||0)||0;}
var view_bottom=offset_top+view_out_height;if(view_bottom<win_height-fix_body_bottom){new_height=view_height+(win_height-view_bottom-fix_body_bottom);}
$view.css('height',new_height);}});ui.once('render',function(){var hack_uploaded_2_wy=false;var inter_upload_files=function(file_num,file_path,source){var files=file_num>1?file_path.split('*'):file_path.split('\r\n');if(!files||files.length===0){return false;}
var is_upload_2_wy=source==='AIO'||routers.get_param('action')==='qq_receive';if(is_upload_2_wy){hack_uploaded_2_wy=true;setTimeout(function(){file_list.enter_qq_receive(false,function(){upload_event.trigger('start_upload_from_client',files);});user_log('upload_from_QQClient',undefined,undefined,{os_type:constants.OS_TYPES.QQ});},100);}
else if(source==='DragDrop'){user_log('DISK_DRAG_UPLOAD');return upload_event.trigger('start_upload_from_client',files);}};var inter_enter_qq_receive=function(){if(!disk.is_activated()){routers.go({m:'disk'});}
file_list.enter_qq_receive(true);user_log('view_from_QQClient',undefined,undefined,{os_type:constants.OS_TYPES.QQ});};var start_listening=function(){global_function.register('WYCLIENT_EnterOfflineDir',inter_enter_qq_receive);global_function.register('WYCLIENT_UploadFiles',inter_upload_files);if(routers.get_param('action')==='qq_receive'&&!hack_uploaded_2_wy){inter_enter_qq_receive();}};if(query_user.get_cached_user()){start_listening();}else{query_user.once('load',start_listening);}});page_event.on('check_file_upload_draggable',function(){if(!ui.get_$body().is(':visible')){return false;}});return ui;});define.pack("./upload.Upload_class",["lib","common","$","./file.utils.all_file_map","./file_list.file_list","./upload.view","./upload.upload_queue","./upload.aop_wrap_log","./file.file_node","./upload.upload_route"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),dance=lib.get('./dance'),collections=lib.get('./collections'),functional=common.get('./util.functional'),all_file_map=require('./file.utils.all_file_map'),file_type_map=common.get('./file.file_type_map'),JSON=lib.get('./json'),request=common.get('./request'),file_list=require('./file_list.file_list'),c=lib.get('./console').namespace('upload'),View=require('./upload.view'),upload_event=common.get('./global.global_event').namespace('upload'),random=lib.get('./random'),Class=lib.get('./class'),Queue=require('./upload.upload_queue'),user_log=common.get('./user_log'),aop_wrap_log=require('./upload.aop_wrap_log'),FileNode=require('./file.file_node'),toString=Object.prototype.toString;var Upload=(function(){var cache={},curr_cache={length:0},G4=4*1024*1024*1024,__info={length:0,start:0,error:0,done:0},__Upload=Class.create();__Upload.interface('init',function(){var path=this.path;this.file_name=functional.try_it(function(){var ary=path.split(/\\|\//);var file_name=ary[ary.length-1]||'';return file_name;});this.queue=Queue;this.view=View.add(this);cache[this.local_id]=this;});__Upload.interface('cache',cache);__Upload.interface('change_state',function(){var state=Array.prototype.shift.call(arguments),__statefn=this.states[state];if(!__statefn)return;if(state!==this.state){this.view.transform_state.call(this.view,state);}
this.state=state;__statefn.apply(this,arguments);this.view.change_state();});__Upload.interface('get_timeout',function(__time){var t,__self=this;var timeout=function(){t=setTimeout(function(){__self.change_state('error',10000);},__time);};var clear=function(){clearTimeout(t);};return{timeout:timeout,clear:clear};});__Upload.interface('upload_speed',function(){var prev_time,prev_process,curr_time,speed,get_speed,reset;get_speed=function(){if(!prev_time){prev_time=+new Date();prev_process=this.processed;return 0;}
if(prev_process===this.processed){return;}
curr_time=+new Date();speed=(this.processed-prev_process)/(curr_time-prev_time)*1000|0;prev_time=curr_time;prev_process=this.processed;return Math.max(0,speed);};reset=function(){prev_time=null;};return{get_speed:get_speed,reset:reset};});__Upload.interface('set_local_id',function(local_id){cache[this.local_id]=null;delete cache[this.local_id];if(!local_id){return;}
this.local_id=local_id;cache[local_id]=this;this.view.dom.attr('__id',local_id);});__Upload.interface('get_file_size',function(){var self=this;var file_size=functional.try_it(function(){return self.upload_plugin.GetFileSizeString(self.path)-0;})||this.upload_plugin.GetFileSize(self.path)||0;file_size=file_size-0;if(file_size<0){file_size+=4*1024*1024*1024;}
return file_size;});__Upload.interface('get_upload_param',function(md5,sha){var curr_file=all_file_map.get(this.curr_dir_id),file_name=this.file_name;file_name=file_name.replace(/(^\.*|\.*$)/g,'');return{ppdir_key:curr_file.get_parent().get_id(),pdir_key:curr_file.get_id(),upload_type:0,file_md5:md5,file_sha:sha,file_size:this.file_size+'',file_attr:{file_name:encodeURIComponent(file_name),file_note:'',file_mtime:curr_file.get_modify_time()}};});__Upload.interface('get_file_type',function(){var self=this;var suffix=functional.try_it(function(){var ary=self.path.split('.'),__suffix=ary[ary.length-1];return __suffix||'';});return file_type_map.get_type_by_ext(suffix);});__Upload.interface('destroy',function(){cache[this.local_id]=null;delete cache[this.local_id];if(curr_cache[this.del_local_id]){curr_cache.length-=1;}
curr_cache[this.del_local_id]=null;delete curr_cache[this.del_local_id];});__Upload.interface('dom_events',{click_cancel:function(){this.events.clear.call(this);},click_pause:function(){this.change_state('pause');},click_continuee:function(){this.change_state('continuee');},click_resume_continuee:function(){this.change_state('resume_continuee');}});__Upload.interface('request_upload',function(data,callback){var __self=this;request.get({cmd:'file_upload',body:data,cavil:true}).fail(function(msg,ret,rsp_body,rsp_header){__self.change_state('error',ret);}).ok(function(msg,rsp_body,rsp_header){$.extend(__self,rsp_body);callback(rsp_body,data);});});__Upload.interface('remove_file',function(){if(!this.file_id){return;}
file_list.silent_remove_file_in_serv(this.curr_dir_id,this.file_id,this.file_name);});__Upload.interface('get_resume_param',function(){var server=this.server,port=this.port,check_key=this.check_key,file_key=this.file_key,file_sha=this.file_sha,path=this.path,file_index=this.file_index,processed=this.processed,file_id=this.file_id,file_ctime=this.file_ctime,file_ver=this.file_ver,local_id=this.local_id;return JSON.stringify({server:server,port:port,check_key:check_key,file_key:file_key,file_sha:file_sha,path:path,file_index:file_index,processed:processed,file_id:file_id,file_ctime:file_ctime,file_ver:file_ver,local_id:local_id});});__Upload.__static={set_info:function(key,value){__info[key]=value;},get_info:function(){var __new_info=$.extend({},__info);__new_info.undone=curr_cache.length;return __new_info;},get_curr_cache:function(){return curr_cache;},get_cache:function(){return cache;},get_curr_local_id:function(){return Queue.get_curr_local_id();},get_curr_upload:function(){return cache[Queue.get_curr_local_id()];},get_instance:function(){for(var i in cache){return cache[i];}},each:function(fn){if(!fn){return;}
$.each(cache,function(){fn.call(this);});},curr_upload_each:function(fn){if(!fn){return;}
for(var i in curr_cache){fn.call(curr_cache[i]);}},dom_events:{click_close:function(){View.close();},click_remove:function(is_user_event){__info={length:0,start:0,error:0,done:0};View.clear_all();}},queue:Queue,add_state:function(state_name,state_fn){__Upload.interface('states.'+state_name,state_fn);},add_events:function(event_name,event_fn){__Upload.interface('events.'+event_name,event_fn);},store_upload_progress:function(){var resume_files=[];Upload.__static.each(function(){if(this.state==='upload_file_update_process'||this.state==='pause'||this.state==='resume_pause'){resume_files.push(this.get_resume_param());}});upload_event.trigger('set_resume_store',resume_files);},get_page_unload_confirm:function(){var conf=false;Upload.__static.each(function(){if(this.state!=='done'&&this.state!=='error'){conf=true;}});return conf?'您有文件正在上传, 确定要关闭微云吗？':undefined;},stop_upload:function(){Upload.__static.each(function(){var upload_plugin=this.upload_plugin;try{if(upload_plugin&&upload_plugin.StopUpload){var ret=upload_plugin.StopUpload(this.local_id);if(0!==ret){upload_plugin.StopUpload(this.local_id+'');}}}catch(e){}});}};__Upload.__static.add_state('wait',function(){this.curr_dir_id=file_list.get_cur_node().get_id();var __self=this;__Upload.__static.queue.add.call(this,function(){__self.change_state('start');});});__Upload.__static.add_state('start',function(is_re_start){curr_cache[this.del_local_id]=this;curr_cache.length+=1;if(!is_re_start){__info.start+=1;}else{__info.error-=1;this.file_sign_done_flag=false;}
var ret=this.validata&&this.validata.run();if(ret){this.error_type='client';this.change_state('error',function(){return ret;});return false;}
if(this.time){this.time.timeout();}});__Upload.__static.add_state('start_upload',function(){this.start_time=+new Date();});__Upload.__static.add_state('error',function(error_code){if(toString.call(error_code)==='[object Function]'){error_code=error_code();}
if(toString.call(error_code)==='[object Array]'){this.code=error_code[0];this.log_code=error_code[1];}else{this.code=this.log_code=error_code;}
__info.error+=1;this.queue.dequeue();if(this.time){this.time.clear();}
View.show();this.destroy();});__Upload.__static.add_state('pause',function(){this.pause_mode=1;var ret=this.upload_plugin.StopUpload(this.local_id);if(ret!==0){this.upload_plugin.StopUpload(this.local_id+'');}
this.speed.reset();this.queue.dequeue();});__Upload.__static.add_state('continuee',function(){var ret=this.upload_plugin.ResumeFileLocal(this.local_id);if(ret!==0){this.upload_plugin.ResumeFileLocal(this.local_id+'');}});__Upload.__static.add_state('resume_pause',function(obj){curr_cache[this.del_local_id]=this;curr_cache.length+=1;__info.start+=1;this.set_local_id();$.extend(this,obj);this.set_local_id(obj.local_id);});__Upload.__static.add_state('resume_continuee',function(){this.pause_mode=1;curr_cache[this.del_local_id]=this;this.set_local_id();var local_id=this.upload_plugin.ResumeFile(this.server,this.port,this.check_key,this.file_sha,this.file_key,this.path,this.processed,'weiyun');this.set_local_id(local_id);});__Upload.__static.add_state('file_sign_update_process',functional.throttle(function(event_param){var processlow=event_param.Processed<0?G4+event_param.Processed:event_param.Processed;if(event_param.ProcessedH){processlow=event_param.ProcessedH*G4+processlow;}
this.file_sign_update_process=processlow;}),1000);__Upload.__static.add_state('file_sign_done',function(event_param){if(this.file_sign_done_flag===true){return;}
this.file_sign_done_flag=true;var data=this.get_upload_param.call(this,event_param.Md5,event_param.SHA),__self=this;this.request_upload(data,function(rsp_body,data){__self.change_state('start_upload',rsp_body,data);});});__Upload.__static.add_state('upload_file_update_process',functional.throttle(function(event_param){this.update_process_count+=1;var processlow=event_param.Processed<0?G4+event_param.Processed:event_param.Processed;if(event_param.ProcessedH){processlow=event_param.ProcessedH*G4+processlow;}
this.processed=processlow;this.file_index=event_param.FileIndex;}),1000);__Upload.__static.add_state('done',function(event_param){if(event_param&&typeof event_param.ErrorCode!=='undefined'){if(event_param.ErrorCode!==0||event_param.Step!==0){c.error('fileupload done errorCode= '+event_param.ErrorCode);c.error('fileupload done step= '+event_param.Step);return this.change_state('error',['储存服务繁忙('+event_param.ErrorCode+')',event_param.ErrorCode]);}}
__info.done+=1;var node=all_file_map.get(this.curr_dir_id);if(node){node.set_dirty(true);}
if(this.file_id){var file_node=new FileNode({is_dir:false,id:this.file_id,name:this.new_name||this.file_name,size:this.file_size,cur_size:this.file_size,create_time:this.file_ctime,modify_time:this.file_ctime,file_ver:this.file_ver,file_md5:this.file_md5,file_sha:this.file_sha});file_list.prepend_node(file_node,true,this.curr_dir_id);}
if(this.time){this.time.clear();}
this.destroy();var route=require('./upload.upload_route');return this.queue.dequeue();});__Upload.__static.add_events('clear',function(flag){__info.length-=1;if(this.state==='error'||this.state==='done'){__info[this.state]-=1;__info.start-=1;}else if(this.state!=='wait'){__info.start-=1;}
var __self=this;this.queue.remove(this.del_local_id);functional.try_it(function(){__self.upload_plugin.StopUpload(__self.local_id);});this.set_local_id();if(!flag){this.remove_file();}
if(this.state!=='wait'){this.queue.dequeue();}
this.destroy();return this.view.clear();});__Upload.__static.add_events('clear_all',function(){__Upload.__static.each(function(){this.events.clear.call(this,1);});upload_event.trigger('remove_rest_icon');});__Upload.__static.add_events('close',function(){this.view.close();});return aop_wrap_log(__Upload);})();return Upload;});define.pack("./upload.aop_wrap_log",["lib","common","./upload.upload_route"],function(require,exports,module){var
lib=require('lib'),common=require('common'),functional=common.get('./util.functional'),c=lib.get('./console').namespace('upload'),user_log=common.get('./user_log'),toString=Object.prototype.toString,wrap_log;wrap_log=function(Upload){Upload.getPrototype().dom_events.click_cancel=functional.before(Upload.getPrototype().dom_events.click_cancel,function(){var cache=Upload.__static.get_cache(),process=cache[this.local_id];if(!process){return;}
if(process.state==='wait'){return user_log('DISK_UPLOAD_CANCEL');}
return user_log('DISK_UPLOAD_HAS_DATA_CANCEL');});Upload.getPrototype().dom_events.click_pause=functional.before(Upload.getPrototype().dom_events.click_pause,function(){user_log('DISK_UPLOAD_PAUSE');});Upload.getPrototype().dom_events.click_continuee=functional.after(Upload.getPrototype().dom_events.click_continuee,function(){user_log('DISK_UPLOAD_CONTIUNE');});Upload.getPrototype().dom_events.click_resume_continuee=functional.after(Upload.getPrototype().dom_events.click_resume_continuee,function(){user_log('DISK_UPLOAD_RESUME_CONTIUNE');});Upload.__static.dom_events.click_close=functional.after(Upload.__static.dom_events.click_close,function(){user_log('DISK_UPLOAD_SLIDE_UP');});Upload.__static.dom_events.click_remove=functional.after(Upload.__static.dom_events.click_remove,function(is_user_event){if(is_user_event!==false){user_log('DISK_UPLOAD_DONE');}});Upload.getPrototype().states.error=functional.after(Upload.getPrototype().states.error,function(error_code){var route,rpt_data;route=require('./upload.upload_route');rpt_data={"extInt1":this.start_time?(+new Date())-this.start_time:0,"file_type":this.get_file_type()};user_log(route.type,this.log_code,rpt_data);});Upload.getPrototype().states.done=functional.after(Upload.getPrototype().states.done,function(error_code){var route,ret;route=require('./upload.upload_route');if(this.update_process_count&&this.update_process_count<=1){ret=30000002;}else if(this.pause_mode===1){ret=30000003;}else{ret=30000001;}
user_log(route.type,0,{"extInt1":+new Date()-this.start_time,"extInt2":ret,"file_size":this.file_size,"file_type":this.get_file_type(),"subop":route.type});});return Upload;};return function(Upload){return wrap_log(Upload);};});define.pack("./upload.drag_upload",["lib","common","$","./upload.view"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),Module=common.get('./module'),view=require('./upload.view'),functional=common.get('./util.functional'),upload_event=common.get('./global.global_event').namespace('upload'),console=lib.get('./console').namespace('drag_upload'),constants=common.get('./constants');var parent;var plugin=functional.try_it(function(){var plugin=new ActiveXObject("TXGYMailActiveX.ScreenCapture");var plugin_name=plugin.GetDLLFileName();var $obj;if(plugin_name.indexOf("_2.dll")>-1){$obj=$('<object classid="CLSID:B0F77C07-8507-4AB9-B130-CC882FDDC046" width=100% height=100%>');}else{$obj=$('<object classid="CLSID:F4BA5508-8AB7-45C1-8D0A-A1237AD82399" width=100% height=100%>');}
parent=$('<div class="ui-dnd" style="z-index:10003"><a class="ui-pos-right ui-dnd-close" href="javascript:void(0)">关闭</a></div>').appendTo($('body')).hide();parent.find('a').on('click',function(){parent.hide();});document.body.ondragover=function(){parent.show();};return $obj.appendTo(parent)[0];});var module=new Module('drag_upload',{render:function(){if(!plugin){return;}
plugin.text='将文件拖拽至此区域';plugin.OnFilesDroped=function(type){if(type==='ENTER'){return plugin.text='释放鼠标';}
if(type==='LEAVE'){return plugin.text='将文件拖拽至此区域';}
if(type==='OVER'){return;}
parent.hide();var _oFiles=type.split("\r\n");var _oFileList=[];for(var i=0;i<_oFiles.length;i++){var _oFilePart=_oFiles[i].split(" ");if(_oFilePart.length>=2){var _sFid=_oFilePart.shift(),_sFileName=_oFilePart.join(" ");_oFileList.push(_sFileName);}}
upload_event.trigger('start_upload_from_client',_oFileList);};}});setTimeout(function(){module.render();},1000);});define.pack("./upload.event",["lib","common","$","./tmpl","./upload.view"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),tmpl=require('./tmpl'),upload_event=common.get('./global.global_event').namespace('upload'),page_event=common.get('./global.global_event').namespace('page');var init=function(){var __self=this,upload_obj=this.upload_obj;this.upload_click.on('click',function(e){var data_action=$(e.target).attr('data-action');__self.upload_obj.dom_events[data_action].call(__self.upload_obj);return false;});this.upload_del.on('click',function(e){var data_action=$(e.target).attr('data-action');__self.upload_obj.dom_events[data_action].call(__self.upload_obj);return false;});};var init_header=function(){var __self=this;this.close_button.on('click',function(e){var data_action=$(e.target).attr('data-action');__self.master.__static.dom_events[data_action]();return false;});upload_event.on('upload_mouseover',function(){var Upload=__self.master;var info=Upload.__static.get_info(),view=require('./upload.view');if(info.length){view.$dom.show();view.state='show';}
return false;});};module.exports={init:init,init_header:init_header};});define.pack("./upload.html5_file_sign",["lib","common","$","./upload.upload_route","./file_list.file_list","./upload.Upload_class"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),functional=common.get('./util.functional'),upload_route=require('./upload.upload_route'),file_type_map=common.get('./file.file_type_map'),file_list=require('./file_list.file_list'),c=lib.get('./console'),global_function=common.get('./global.global_function'),Upload_class=require('./upload.Upload_class'),random=lib.get('./random'),query_user=common.get('./query_user'),Class=lib.get('./class');var cache={};var __FileReader=(function(){var Reader=Class.create(function(local_id,file){this.local_id=local_id;this.file=file;this.process_fn=null;this.done_fn=null;this.file_size=this.file.size;this.read_position=0;this.__slice=this.file.slice||this.file.mozSlice||this.file.webkitSlice;this.__silce_length=1024*1024;cache[this.local_id]=this;this.worker=new Worker('http://www.weiyun.com/appbox/file_md5_sha/calculator.worker.md5.js');this.worker.addEventListener('message',function(event){var local_id=event.data.local_id,type=event.data.type,end=event.data.end;if(!cache[local_id]){return;}
var __worker=cache[local_id];__worker.worker_response[type].call(__worker,event.data);});this.start();});Reader.interface('start',function(){if(this.read_position>=this.file_size){return;}
var result=this.slice();this.read(result.buffer,result.start,result.end);});Reader.interface('read',function(buffer,start,end){var file_reader=new FileReader(),__self=this;file_reader.onload=function(e){__self.worker.postMessage({local_id:__self.local_id,result:e.target.result,file_size:__self.file_size,start:start,end:end});file_reader.onload=null;file_reader=null;__self.start();};file_reader.readAsArrayBuffer(buffer);});Reader.interface('slice',function(){this.end=Math.min(this.read_position+this.__silce_length,this.file_size);var buffer=this.file.slice(this.read_position,this.end,'text/plain;charset=UTF-8');var ret={start:this.read_position,end:this.end,buffer:buffer};this.read_position=this.end;return ret;});Reader.interface('worker_response',{process:function(result){return this.process_fn(result.end);},done:function(result){this.worker=null;c.log(result.MD5,result.SHA);return this.done_fn(result.MD5,result.SHA);}});Reader.interface('process',function(fn){this.process_fn=fn;});Reader.interface('done',function(fn){this.done_fn=fn;});var create=function(local_id,file){return Reader.getInstance(local_id,file);};return{create:create};})();module.exports=__FileReader;});define.pack("./upload.msg",[],function(require,exports,module){var g={};g.upload_error={1013:'存储服务繁忙，请稍后再试',1051:'该目录下已有同名文件',1019:'文件夹不存在',1024:'登录超时',1028:'文件总数超过65535',1053:'用户剩余空间不足',1083:'当前目录下文件数超过2000',1088:'文件名不合法',100027:'无效的字符',8:'文件名过长',16:'不支持上传目录和空文件',17:'源文件不存在',1029:'文件过大',10000:'上传超时',20000:'存储服务繁忙，请稍后再试(20000)'};var get=function(type,code){if(typeof code==='string'){return code;}
return g[type][code]||'网络问题';};module.exports={get:get};});define.pack("./upload.upload_flash_start",["lib","common","$","./upload.upload_route","./file_list.file_list","./upload.view","./mini_tip.mini_tip","./upload.upload_validata","./upload.Upload_class"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),functional=common.get('./util.functional'),upload_route=require('./upload.upload_route'),file_type_map=common.get('./file.file_type_map'),file_list=require('./file_list.file_list'),c=lib.get('./console'),View=require('./upload.view'),query_user=common.get('./query_user'),mini_tip=require('./mini_tip.mini_tip'),global_function=common.get('./global.global_function'),Validata=require('./upload.upload_validata'),Upload_class=require('./upload.Upload_class'),flash_focus_hacker=common.get('./ui.flash_focus_hacker'),random=lib.get('./random');var Upload=Upload_class.sub(function(id,path,size,upload_plugin){this.local_id=id;this.path=path;this.file_name=null;this.file_size=size;this.processed=0;this.upload_plugin=upload_plugin;this.del_local_id=random.random();this.code=null;this.log_code=0;this.speed=this.upload_speed();this.can_pause=false;this.state=null;this.view=null;this.validata=Validata.create();this.validata.add_validata($.browser.msie?'flash_max_size':'max_size',this.file_size,104857600*3);this.validata.add_validata('empty_file',this.file_size);this.validata.add_validata('max_space',this.file_size,query_user.get_cached_user().get_used_space(),query_user.get_cached_user().get_total_space());this.init();});Upload.__static=Upload_class.__static;View.master=Upload;Upload.interface('states',$.extend({},Upload_class.getPrototype().states));Upload.interface('events',$.extend({},Upload_class.getPrototype().events));Upload.interface('events.clear',function(){this.superClass.events.clear.apply(this,arguments);this.upload_plugin.cancelFile(this.local_id);});Upload.interface('states.start',functional.after(Upload_class.getPrototype().states.start,function(){var __self=this,data=this.get_upload_param.call(this,'','');data.upload_type=1;this.request_upload(data,function(rsp_body,data){__self.change_state('start_upload',rsp_body,data);});}));Upload.interface('states.start_upload',function(){this.start_time=+new Date();this.upload_plugin.uploadFile(this.local_id,this.upload_svr_host,this.upload_svr_port-0,this.file_key,this.upload_csum,{'mode':'flashupload'});});var __reload=functional.throttle(function(){file_list.reload(false,false);},2000);Upload.interface('states.done',function(){this.superClass.states.done.apply(this,arguments);__reload();});Upload.interface('states.upload_file_update_process',function(processed){this.curr_file_size=this.processed=processed;});var add_upload=function(files,upload_plugin){var info=Upload.__static.get_info(),file_len=files.length,upload_max_count=3;if(info.done===info.length){Upload.__static.dom_events.click_remove(false);}
var start_upload=functional.burst(files,function(opt){var upload_obj=Upload.getInstance(opt.id,'C\\'+opt.name,opt.size,upload_plugin),new_info=Upload.__static.get_info();upload_obj.change_state('wait');if(new_info.undone>=upload_max_count){return;}
Upload.__static.queue.dequeue(upload_max_count-new_info.undone);},8);start_upload.start();var new_info=Upload.__static.get_info();Upload.__static.set_info('length',new_info.length+file_len);View.show();flash_focus_hacker.fix();};var op=[null,'add',null,'upload_file_update_process','done','upload_file_update_process'];global_function.register('FileUploaderCallback',function(code,opt){var fn=op[code-0];if(fn===null){return;}
fn=fn||'upload_file_update_process';if(fn==='add'){return add_upload(opt,upload_route.upload_plugin);}
var upload_obj=Upload.__static.get_cache()[opt.id];upload_obj.change_state(fn,opt.processed);});module.exports=Upload;});define.pack("./upload.upload_form_start",["lib","common","$","./upload.upload_route","./file_list.file_list","./upload.view","./upload.Upload_class"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),functional=common.get('./util.functional'),Module=common.get('./module'),upload_route=require('./upload.upload_route'),file_list=require('./file_list.file_list'),c=lib.get('./console'),View=require('./upload.view'),global_function=common.get('./global.global_function'),Upload_class=require('./upload.Upload_class'),random=lib.get('./random'),query_user=common.get('./query_user'),session_event=common.get('./global.global_event').namespace('session'),ret_msgs=common.get('./ret_msgs');var upload_lock=false;document.domain='weiyun.com';var Upload=Upload_class.sub(function(upload_plugin,id,path,ppdir,pdir,skey){this.upload_plugin=upload_plugin;this.local_id=id;this.path=path;this.ppdir=ppdir,this.pdir=pdir,this.skey=skey,this.file_name=null;this.processed=0;this.code=null;this.log_code=0;this.speed=this.upload_speed();this.can_pause=false;this.state=null;this.view=null;this.time=this.get_timeout(180000);this.init();});Upload.__static=Upload_class.__static;View.master=Upload;Upload.interface('states',$.extend({},Upload_class.getPrototype().states));Upload.interface('states.done',function(){this.superClass.states.done.apply(this,arguments);this.upload_plugin.destory();file_list.reload(false,false);});Upload.interface('states.error',function(){this.superClass.states.error.apply(this,arguments);this.upload_plugin.destory();});Upload.interface('states.start',function(){this.start_time=+new Date();this.superClass.states.start.apply(this,arguments);this.upload_plugin.send({name:'web',ppdir:this.ppdir,pdir:this.pdir,skey:this.skey});View.show();});View.View_instance.prototype.start=functional.after(View.View_instance.prototype.start,function(){this.upload_msg.hide();this.upload_del.hide();this.upload_icon_sh.show();});View.View_instance.prototype.done=functional.after(View.View_instance.prototype.done,function(){this.upload_icon_sh.hide();});View.View_instance.prototype.error=functional.after(View.View_instance.prototype.error,function(){this.upload_icon_sh.hide();});var form_upload=new Module('form_upload',{render:function(){this.listenTo(upload_route,'render',function(){upload_route.upload_plugin.change(function(){var info=Upload.__static.get_info(),upload_max_count=1,curr_file=file_list.get_cur_node();if(info.done===info.length){Upload.__static.dom_events.click_remove(false);}
var start_upload=functional.burst([upload_route.upload_plugin.get_path()],function(path){var upload_obj=Upload.getInstance(upload_route.upload_plugin,random.random(),path,curr_file.get_parent().get_id(),curr_file.get_id(),query_user.get_skey());new_info=Upload.__static.get_info();upload_obj.change_state('wait');if(new_info.undone>=upload_max_count){return;}
Upload.__static.queue.dequeue(upload_max_count-new_info.undone);},3);start_upload.start();var new_info=Upload.__static.get_info();Upload.__static.set_info('length',new_info.length+1);View.show();});});}});global_function.register('weiyun_post_end',function(json){setTimeout(function(){if(json.ret===0){Upload.__static.get_curr_upload().change_state('done');return upload_lock=false;}else{Upload.__static.get_curr_upload().change_state('error',json.ret);if(json.ret===ret_msgs.INVALID_SESSION){session_event.trigger('session_timeout');}
return upload_lock=false;}},0);});form_upload.render();module.exports=Upload;});define.pack("./upload.upload_global_function",["lib","common","$","./upload.Upload_class","./toolbar.toolbar"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),c=lib.get('./console'),routers=lib.get('./routers'),json=lib.get('./json'),functional=common.get('./util.functional'),query_user=common.get('./query_user'),user_log=common.get('./user_log'),global_function=common.get('./global.global_function'),upload_event=common.get('./global.global_event').namespace('upload'),page_event=common.get('./global.global_event').namespace('page'),Upload=require('./upload.Upload_class'),toolbar=require('./toolbar.toolbar'),op_map=[null,'file_sign_done','file_sign_update_process','done','upload_file_update_process','create_file_done','get_resume_info_done'],undefined;global_function.register('OnEvent',window.OnEvent=function(event_param){var cache=Upload.__static.get_cache();if($.isEmptyObject(cache)){return;}
event_param=functional.try_it(function(){return JSON.parse(event_param);})||event_param;var local_id=event_param.LocalID;if(!cache[local_id]){return;}
var event_type=event_param.EventType,op=op_map[event_type];cache[local_id].change_state(op,event_param);return 1;});global_function.register('WYCLIENT_BeforeCloseWindow',function(is_close_QQ){var close=true,no_close=false;if(is_close_QQ==="TRUE"){return close;}
else{var msg=page_event.trigger('before_unload');if(msg){if(window.external.MsgBox_Confirm('提示',msg,1)){page_event.trigger('confirm_unload');return close;}else{return no_close;}}}
return close;});window.support_plugin_drag_upload=function(){if(page_event.trigger('check_file_upload_draggable')===false){return 0;}
return 1;};page_event.on('before_unload',function(){return Upload.__static.get_page_unload_confirm();});var unload_confirmed=false;page_event.on('confirm_unload',function(){if(!unload_confirmed){unload_confirmed=true;Upload.__static.store_upload_progress();Upload.__static.stop_upload();}});global_function.register('onbeforeunload',function(){if(!unload_confirmed){return page_event.trigger('before_unload');}});$(window).on('unload',function(){page_event.trigger('confirm_unload');});return global_function.get('OnEvent');});define.pack("./upload.upload_html5_start",["lib","common","$","./upload.upload_route","./file_list.file_list","./upload.view","./upload.Upload_class","./upload.html5_file_sign"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),functional=common.get('./util.functional'),Module=common.get('./module'),upload_route=require('./upload.upload_route'),file_type_map=common.get('./file.file_type_map'),file_list=require('./file_list.file_list'),c=lib.get('./console'),View=require('./upload.view'),global_function=common.get('./global.global_function'),Upload_class=require('./upload.Upload_class'),random=lib.get('./random'),query_user=common.get('./query_user'),file_sign=require('./upload.html5_file_sign'),undefined;var Upload=Upload_class.sub(function(upload_plugin,id,size,path,ppdir,pdir,skey,file_data){this.upload_plugin=upload_plugin;this.local_id=id;this.file_size=size;this.path=path;this.ppdir=ppdir;this.pdir=pdir;this.skey=skey;this.file_data=file_data;this.file_name=null;this.processed=0;this.code=null;this.speed=this.upload_speed();this.can_pause=false;this.state=null;this.view=null;this.time=this.get_timeout(180000);this.init();});Upload.__static=Upload_class.__static;View.master=Upload;Upload.interface('change_state',function(){this.superClass.change_state.apply(this,arguments);this.view.change_state();});Upload.interface('states',$.extend({},Upload_class.getPrototype().states));Upload.interface('states.start',function(){this.FileSign();this.superClass.states.start.call(this);});Upload.interface('FileSign',function(){var file=this.file_data,sign=file_sign.create(this.local_id,this.file_data),__self=this;sign.process(function(processed){__self.change_state('file_sign_update_process',processed);});sign.done(function(Md5,SHA){console.log(Md5);console.log(SHA);__self.change_state('file_sign_done',{Md5:Md5,SHA:SHA,fileSize:__self.file_size});sign=null;});});Upload.interface('states.start',function(){this.FileSign();this.superClass.states.start.call(this);});Upload.interface('states.file_sign_update_process',function(processed){this.file_sign_update_process=processed;this.curr_file_size=this.file_size;});Upload.interface('states.start_upload',function(){console.log(this.local_id,this.upload_svr_host,this.upload_svr_port-0,this.file_key,this.upload_csum);});var change_fn=function(files){if(Upload.__static.each().undone===0){Upload.__static.dom_events.click_remove(false);}
var curr_file=file_list.get_cur_node();$.each(files,function(){var upload_obj=Upload.getInstance(upload_route.upload_plugin,random.random(),this.size,'c\\'+this.name,curr_file.get_parent().get_id(),curr_file.get_id(),query_user.get_skey(),this);upload_obj.change_state('wait');});Upload.__static.queue.dequeue();};var html5_upload=new Module('flash_upload',{render:function(){this.listenTo(upload_route,'render',function(){upload_route.upload_plugin.change(change_fn);});}});html5_upload.render();module.exports=Upload;});define.pack("./upload.upload_plugin_start",["lib","common","$","./upload.upload_route","./upload.view","./upload.Upload_class","./mini_tip.mini_tip","./file_list.file_list","./upload.upload_validata"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),functional=common.get('./util.functional'),Module=common.get('./module'),constants=common.get('./constants'),upload_route=require('./upload.upload_route'),upload_event=common.get('./global.global_event').namespace('upload'),store=lib.get('./store'),query_user=common.get('./query_user'),c=lib.get('./console'),View=require('./upload.view'),Upload_class=require('./upload.Upload_class'),random=lib.get('./random'),mini_tip=require('./mini_tip.mini_tip'),interval=lib.get('./interval'),file_list=require('./file_list.file_list'),JSON=lib.get('./json'),Class=lib.get('./class'),Validata=require('./upload.upload_validata'),view_update_timer;var Upload=Upload_class.sub(function(file_path,upload_plugin,queue_length){this.path=file_path;this.file_name=null;this.upload_plugin=upload_plugin;this.local_id=random.random();this.del_local_id=random.random();this.state=null;this.file_size=this.get_file_size();this.file_sign_update_process=0;this.code=0;this.log_code=0;this.processed=0;this.event_param=null;this.curr_file_size=0;this.can_pause=true;this.queue=null;this.speed=this.upload_speed();this.view=null;this.file_sign_done_flag=false;this.update_process_count=0;this.pause_mode=0;this.validata=Validata.create();this.validata.add_validata('max_size',this.file_size,upload_route.type==='active_plugin'||(constants.IS_APPBOX&&window.external.GetFileSizeString)?4294967296:2147483648);this.validata.add_validata('empty_file',this.file_size);this.validata.add_validata('max_space',this.file_size,query_user.get_cached_user().get_used_space(),query_user.get_cached_user().get_total_space());this.init();});Upload.__static=Upload_class.__static;View.master=Upload;Upload.interface('states',$.extend({},Upload_class.getPrototype().states));Upload.interface('states.start',functional.after(Upload_class.getPrototype().states.start,function(){var local_id=this.upload_plugin.FileSign(this.path,'weiyun'),__self=this,callee=arguments.callee;if(!local_id){return setTimeout(function(){return callee.call(__self);},1000);}
this.set_local_id(local_id);}));Upload.interface('states.start_upload',function(rsp_body,data){this.start_time=+new Date();this.server=rsp_body.upload_svr_host;this.port=rsp_body.upload_svr_port;this.check_key=rsp_body.upload_csum;this.file_key=rsp_body.file_key;this.file_md5=data.file_md5;this.file_sha=data.file_sha;var local_id=this.upload_plugin.UploadFile(this.server,this.port,this.check_key,this.file_sha,this.file_key,this.path,'weiyun'),__self=this,callee=arguments.callee;if(!local_id){return setTimeout(function(){return callee.call(__self,rsp_body,data);},1000);}
this.set_local_id(local_id);});var add_upload=function(files,upload_plugin){var info=Upload.__static.get_info(),file_len=files.length,upload_max_count=upload_plugin.__type==='webkit_plugin'?2:1;if(info.done===info.length){Upload.__static.dom_events.click_remove(false);}
var start_upload=functional.burst(files,function(path){var upload_obj=Upload.getInstance(path,upload_plugin),new_info=Upload.__static.get_info();upload_obj.change_state('wait');if(new_info.undone>=upload_max_count){return;}
Upload.__static.queue.dequeue(upload_max_count-new_info.undone);},8);start_upload.start();var new_info=Upload.__static.get_info();Upload.__static.set_info('length',new_info.length+file_len);View.show();};var add_resume=function(files,upload_plugin){Upload.__static.set_info('undone',files.length);Upload.__static.set_info('length',files.length);$.each(files,function(){var obj=JSON.parse(this);var upload_obj=Upload.getInstance(obj.path,upload_plugin);functional.try_it(function(){upload_obj.change_state('resume_pause',obj);});});View.show();};var start_upload=function(upload_plugin){if(upload_plugin.SelectFilesAsync&&!$.browser.safari){return upload_plugin.SelectFilesAsync(window,function(files){if(!files){return;}
var __files=files.split('\r\n');__files.pop();if(!__files||!__files.length){return;}
return add_upload(__files,upload_plugin);});}
var files=functional.try_it(function(){var ary=upload_plugin.SelectFiles(window).split('\r\n');ary.pop();return ary;});if(!files||!files.length){return;}
return add_upload(files,upload_plugin);};var plugin_start=new Module('plugin_start',{render:function(){upload_event.on('start_upload',start_upload);this.listenTo(upload_route,'render',function(){upload_event.on('start_upload_from_client',function(files){return add_upload(files,upload_route.upload_plugin);});});var start=function(){var key=query_user.get_uin()+'resume_store',str=store.get(key);if(!str||str==='[]')return;functional.try_it(function(){var files=JSON.parse(str);add_resume(files,upload_route.upload_plugin);});};var user=query_user.get_cached_user();if(user){start();}else{this.listenToOnce(query_user,'load',function(){start();});}}});plugin_start.render();upload_event.on('set_resume_store',function(files){var key=query_user.get_uin()+'resume_store';store.set(key,JSON.stringify(files));});module.exports=plugin_start;return module;});define.pack("./upload.upload_queue",["lib"],function(require,exports,module){var lib=require('lib'),console=lib.get('./console');var Cpu_check=(function(){var stack=[],timer,__date;var start=function(){if(timer){return;}
__date=+new Date;timer=setInterval(function(){var __new_date=+new Date;stack.push(__new_date-__date);__date=__new_date;if(stack.length>5){stack.shift();}},50);};var busy=function(){var __busy=5;$.each(stack,function(i,n){var s=Math.abs(n-50);if(s>2){__busy=1;return;}else if(s<=1){__busy=2;}
return __busy;});};var stop=function(){clearInterval(timer);timer=null;};return{start:start,busy:busy,stop:stop};})();var Queue=(function(){var stack=[],curr_local_id;var add=function(fn){fn.del_local_id=this.del_local_id;fn.local_id=this.local_id;stack.push(fn);};var dequeue=function(len){if(stack.length===0){return;}
len=Math.min(stack.length,len||1);for(var i=0;i<len;i++){var fn=stack.shift();fn&&fn();}
return fn&&(curr_local_id=fn.local_id);};var clear=function(){stack.length=0;};var remove=function(del_local_id){for(var len=stack.length-1;len>=0;len--){var c=stack[len];if(c.del_local_id===del_local_id){stack.splice(len,1);}}};var length=function(){return stack.length;};var get=function(){return stack;};var get_curr_local_id=function(){return curr_local_id;};return{add:add,dequeue:dequeue,clear:clear,remove:remove,length:length,get:get,get_curr_local_id:get_curr_local_id};})();module.exports=Queue;});define.pack("./upload.upload_route",["lib","common","$","./toolbar.toolbar","./upload.upload_global_function","./upload.Upload_class","./upload.upload_plugin_start","./upload.drag_upload","./upload.upload_flash_start","./upload.upload_html5_start","./upload.upload_form_start"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),functional=common.get('./util.functional'),Module=common.get('./module'),toolbar=require('./toolbar.toolbar'),upload_event=common.get('./global.global_event').namespace('upload'),global_function=require('./upload.upload_global_function'),random=lib.get('./random'),console=lib.get('./console'),is_safari=$.browser.safari,ua=navigator.userAgent.toLowerCase(),is_windows=ua.indexOf("windows")>-1||ua.indexOf("win32")>-1,upload;var get_upload_plugin=function(){var plugins={};var get_active_plugin=function(){if(is_safari||!is_windows){throw new Error('unsupported system or browser');}
var obj;try{obj=new ActiveXObject("TXFTNActiveX.FTNUpload");require('./upload.Upload_class');require('./upload.upload_plugin_start');require('./upload.drag_upload');obj.OnEvent=global_function;console.debug('ActiveXObject plugin');this.type='active_plugin';return obj;}
catch(e){throw new Error('ActiveXObject plugin init error');}};var get_webkit_plugin=function(){if(is_safari||!is_windows){throw new Error('unsupported system or browser');}
if(window.external&&window.external.UploadFile){require('./upload.Upload_class');require('./upload.upload_plugin_start');window.external.OnEvent=global_function;window.external.__type='webkit_plugin';console.debug('webkit_plugin plugin');this.type='webkit_plugin';return window.external;}
var embed=$('<embed id="npftnPlugin" type="application/txftn-webkit" width="0" height="0" style="position:absolute"></embed>').appendTo($('body'))[0];if(embed.UploadFile){require('./upload.Upload_class');require('./upload.upload_plugin_start');embed.OnEvent=global_function;window.upload_obj=embed;embed.__type='webkit_plugin';console.debug('webkit_plugin plugin');this.type='webkit_plugin';return embed;}
throw new Error('webkit plugin init error');};var get_flash=function(){var hasFlash=function(){var ext=window.external;if(ext&&ext.FlashEnable&&ext.FlashEnable()){return true;}
else if($.browser.msie){try{if(new ActiveXObject('ShockwaveFlash.ShockwaveFlash')){return true;}}
catch(e){}}else{var plugs=navigator.plugins;if(plugs&&plugs.length>0&&plugs['Shockwave Flash']){return true;}}
return false;}();if(!hasFlash){throw new Error('flash plugin init error');}
var toolbar=require('./toolbar.toolbar'),upload_dom=toolbar.get_$main_bar().find('[data-action=upload]'),flash_url='http://imgcache.qq.com/club/qqdisk/web/FileUploader.swf?r='+random.random(),img_url='http://imgcache.qq.com/vipstyle/nr/box/img/flashUpload.png',isIe=$.browser.msie;var mode=1;var $upload_obj=$(['<b class="icon_upload"></b><span id="uploadswf">','<object id="swfFileUploader"'+(isIe?'':' data="'+flash_url+'"')+' style="width:'+100+'px;height:'+27+'px;left:0px;top:0px;position:absolute"'+(isIe?'classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"':'type="application/x-shockwave-flash"')+'>',isIe?'<param name="movie" value="'+flash_url+'"/>':'','<param name="allowScriptAccess" value="always" />','<param name="allownetworking" value="all" />','<param name="wmode" value="transparent" />','<param name="flashVars" value="callback=window.FileUploaderCallback&selectionMode='+(mode===1?1:0)+'&buttonSkinURL='+img_url+'"/>','<param name="menu" value="false" />','</object></span>'].join('')).appendTo(upload_dom);var upload_obj=$upload_obj.find('object')[0];if(isIe){setTimeout(function(){upload_obj.LoadMovie(0,flash_url);},0);}else{upload_obj.setAttribute("data",flash_url);}
require('./upload.Upload_class');require('./upload.upload_flash_start');console.debug('flash_plugin');this.type='upload_flash';return upload_obj;};var get_html5=function(){if(!window.File||!window.FileReader||!window.FileList||!window.Blob||!window.Worker){throw new Error('html5 upload init error');}
console.debug('html5_plugin');require('./upload.Upload_class');require('./upload.upload_html5_start');var toolbar=require('./toolbar.toolbar'),upload_dom=toolbar.get_$main_bar();var input=$('<div class="uploads upload-form"><input id="file" name="file" type="file" class="ui-file"/></div>').appendTo(upload_dom).find('input');input.change(function(e){var event=e||window.event;change_fn&&change_fn(event.target.files);});var get_xhr=function(){return new XMLHttpRequest();};var get_form_data=function(data_obj){var form_data=new FormData();for(var key in data_obj){form_data.append(key,data_obj[key]);}
return form_data;};var change_fn;var change=function(fn){change_fn=fn;};return{change:change,get_xhr:get_xhr,get_form_data:get_form_data};};var get_form=function(){console.debug('form_plugin');this.type='upload_form';require('./upload.Upload_class');require('./upload.upload_form_start');var __random=random.random(),body=$('body');var toolbar=require('./toolbar.toolbar'),upload_dom=toolbar.get_$main_bar();var iframe=$('<iframe name='+__random+' id='+__random+' style="display:none;width:0px;height:0px;"></iframe>').appendTo(body);var form=$('<form method="post" action="http://wfup.cgi.weiyun.com/" target='+__random+' enctype="multipart/form-data"><div class="uploads upload-form"><input name="file" type="file" class="ui-file"/></div></form>').appendTo(upload_dom);var parentNode=form.find('div');var send=function(param){for(var key in param){$('<input type="hidden"></input>').attr('name',key).val(param[key]).appendTo(parentNode);}
form.submit();};var destory=function(){parentNode.find('input:hidden').remove();};var get_path=function(){return $('.ui-file').val();};var change_fn,change=function(fn){change_fn=fn;};form.change(function(){if(!change_fn){return;}
change_fn();});return{send:send,destory:destory,form:form,change:change,get_path:get_path};};plugins={get_active_plugin:get_active_plugin,get_webkit_plugin:get_webkit_plugin,get_flash:get_flash,get_form:get_form};return functional.getSingle(function(){for(var key in plugins){try{return plugins[key].call(this);}catch(e){continue;}}});}();upload=new Module('upload',{upload_plugin_type:'form',render:function(){var self=this;this.upload_plugin=get_upload_plugin.call(self);toolbar.on('upload_init',function(){upload_event.trigger('start_upload',self.upload_plugin);});toolbar.on('upload_mouseover',function(){upload_event.trigger('upload_mouseover');});}});module.exports=upload;});define.pack("./upload.upload_tips",["lib","common","$","./upload.view","./upload.upload_route"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),Module=common.get('./module'),view=require('./upload.view'),store=lib.get('./store'),functional=common.get('./util.functional'),widgets=common.get('./ui.widgets'),aid=common.get('./configs.aid'),user_log=common.get('./user_log'),constants=common.get('./constants');var install_href=$.browser.msie?'http://mail.qq.com/cgi-bin/readtemplate?t=browser_addon&check=false&s=install&aid='+
aid.WEIYUN_WEBAPP_DISK_LIJIANZHUANG:'http://mail.qq.com/zh_CN/crx/QQMailWebKitPlugin_1_0_1_53.exe?aid='+aid.WEIYUN_WEBAPP_DISK_LIJIANZHUANG;var install_title=$.browser.msie?'请在新页面控件安装完成后点击确定':'请在控件安装完成后点击确定';var Upload_tips=(function(){var stack=[],__parent;var add_rule=function(fn){stack.push(fn);};var run=function($parent){__parent=$parent;$.each(stack,function(){var $ret=this($parent);if($ret){$parent[typeof $ret==='string'?'html':'append']($ret).show();return false;}});};var set=function(str){__parent.empty()[typeof str==='string'?'html':'append'](str).show();};return{add_rule:add_rule,run:run,set:set,get_parent:function(){return __parent;}};})();Upload_tips.add_rule(function($parent){if(store.get('upload_plugin_update')==='true'){return;}
var upload_route=require('./upload.upload_route');if(constants.IS_APPBOX&&upload_route.type!=='webkit_plugin'){var $dom=$('<a class="ui-pos-right icon-times" href="javascript:void(0)">×</a><a href="http://im.qq.com/qq/2013/" target=_blank>您的QQ版本较低，升级后即可体验文件拖拽上传/下载！</a>');$dom.first().on('click',function(){store.set('upload_plugin_update','true');$parent.hide();});return $dom;}});Upload_tips.add_rule(function(){var gsAgent=navigator.userAgent.toLowerCase(),gbIsWin=gsAgent.indexOf("windows")>-1||gsAgent.indexOf("win32")>-1;if($.browser.safari||!gbIsWin){return;}
var upload_route=require('./upload.upload_route'),$dom=$('<span><a class="upload-ctrl-btn" href="javascript:void(0)">立即安装</a>安装控件，大幅提升上传速度</span>');if(upload_route.type==='webkit_plugin'||upload_route.type==='active_plugin'||store.get('upload_plugin_update')==='true'){return;}
$dom.find('a').on('click',function(){install_upload.start();user_log('DISK_PLUGIN_INSTALL');window.open(install_href);return false;});return $dom;});var install_upload=(function(){var _timer=null;var start=function(){if(!$.browser.msie){return check_installed();}
var $content=$('<div class="ui-confirm-cnt"><i class="icon-xbox icon-xbox-warn"></i><h4 class="ui-title">'+install_title+'</h4><div class="ui-text">重新安装请<a href="javascript:void(0)">点击此处</a></div><div class="ui-text"><input style="position:relative;top:2px;" type="checkbox"></input>&nbsp &nbsp我已经安装控件</div></div>');var dialog=new widgets.Dialog({title:'控件安装提示',content:$content,destroy_on_hide:true,buttons:[{id:'OK',text:'确定',klass:'ui-btn-ok',disabled:true,visible:true}],handlers:{OK:function(){dialog.destroy();check_installed();}}});$content.find('a').on('click',function(){window.open(install_href);user_log('DISK_PLUGIN_REINSTALL');});$content.find('input').on('click',function(){dialog.set_button_enable('OK',this.checked);});dialog.show();};var check_installed=function(){if(!$.browser.msie){var $dom=$('<span><a class="upload-ctrl-btn" href="javascript:void(0)">重新安装</a>请重启浏览器，享受控件极速上传.</span>');$dom.find('a').on('click',function(){install_upload.start();user_log('DISK_PLUGIN_INSTALL');window.open(install_href);return false;});Upload_tips.set($dom);return user_log('DISK_PLUGIN_INSTALLED');}
var $content=$('<div class="ui-confirm-cnt"><i class="icon-xbox icon-xbox-loading"></i><h4 class="ui-title"></h4><div class="ui-text">正在检测控件是否安装成功</div></div>');var dialog=new widgets.Dialog({title:'控件安装提示',content:$content,destroy_on_hide:true,buttons:[{id:'re_install',text:'重新安装',klass:'ui-btn-cancel',disabled:false,visible:true},{id:'re_check',text:'再次检测',klass:'ui-btn-cancel',disabled:false,visible:true},{id:'cancel',text:'取消',klass:'ui-btn-cancel',disabled:false,visible:true}],handlers:{re_install:function(){window.open(install_href);user_log('DISK_PLUGIN_REINSTALL');},re_check:function(){},cancel:function(){dialog.hide();clearTimeout(_timer);}}});dialog.show();_timer=setTimeout(function(){dialog.destroy();try{var a=new ActiveXObject("TXFTNActiveX.FTNUpload");succ();}catch(e){fail();}},3000);};var succ=function(){var $content=$('<div class="ui-confirm-cnt"><i class="icon-xbox icon-xbox-ok"></i><h4 class="ui-title">控件已安装成功</h4><div class="ui-text">请重启浏览器享受控件带来的愉快体验。</div></div>');var dialog=new widgets.Dialog({title:'控件安装提示',content:$content,destroy_on_hide:true,buttons:[{id:'OK',text:'完成',klass:'ui-btn-ok',disabled:false,visible:true}],handlers:{OK:function(){dialog.hide();var $dom=$('<div><a class="ui-pos-right icon-times" href="javascript:void(0)">×</a>请重启浏览器，享受控件极速上传.</div>');$dom.first().on('click',function(){$dom.hide();Upload_tips.get_parent().hide();});Upload_tips.set($dom);user_log('DISK_PLUGIN_INSTALLED');}}});dialog.show();};var fail=function(){var $content=$('<div class="ui-confirm-cnt"><i class="icon-xbox icon-xbox-warn"></i><h4 class="ui-title">系统检测到控件还没有安装成功</h4><div class="ui-text">如果已经安装成功请选择再次检测。</div></div>');var dialog=new widgets.Dialog({title:'控件安装提示',content:$content,destroy_on_hide:true,buttons:[{id:'re_install',text:'重新安装',klass:'ui-btn-cancel',disabled:false,visible:true},{id:'re_check',text:'再次检测',klass:'ui-btn-cancel',disabled:false,visible:true},{id:'cancel',text:'取消',klass:'ui-btn-cancel',disabled:false,visible:true}],handlers:{re_install:function(){window.open(install_href);user_log('DISK_PLUGIN_REINSTALL');},re_check:function(){dialog.destroy();check_installed();},cancel:function(){dialog.hide();}}});dialog.show();};return{start:start};})();var show=functional.getSingle(function($parent){Upload_tips.run($parent);return true;});var set=function(str){Upload_tips.set(str);};return{show:show,set:set,install_upload:install_upload};});define.pack("./upload.upload_validata",["common","$"],function(require,exports,module){var common=require('common'),File=common.get('./file.file_object'),$=require('$');var map={max_size:function(curr_size,max_size){if(curr_size>max_size){if(max_size)
return['文件超过'+File.get_readability_size(max_size),1000001];}},flash_max_size:function(curr_size,max_size){if(curr_size>max_size){if(max_size)
return['文件超过'+File.get_readability_size(max_size)+', 请安装控件后再上传',1000002];}},max_space:function(curr_size,space,space_totle){if(curr_size+space>space_totle){return['用户剩余空间不足',1000003];}},empty_file:function(curr_size){if(curr_size-0===0){return['暂不支持上传空文件',1000004];}}};var Validata=function(){var __map=$.extend({},map),stack={},__self=this;var add_validata=function(){var key=Array.prototype.shift.call(arguments);stack[key]=Array.prototype.slice.call(arguments);};var add_rule=function(fn_name,fn){__map[fn_name]=fn;};var run=function(){var flag=false;$.each(__map,function(key,fn){var param=stack[key];if(!param){return;}
var ret=fn.apply(__self,param);if(ret){flag=ret;return false;}});return flag;};return{add_validata:add_validata,add_rule:add_rule,run:run};};var create=function(){return Validata.call(this);};return{create:create};});define.pack("./upload.view",["lib","common","$","./upload.upload_route","./tmpl","./upload.msg","./toolbar.toolbar","./upload.event","uploadbox_css","./upload.upload_tips"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),store=lib.get('./store'),c=lib.get('./console'),functional=common.get('./util.functional'),Module=common.get('./module'),file_type_map=common.get('./file.file_type_map'),upload_route=require('./upload.upload_route'),upload_event=common.get('./global.global_event').namespace('upload'),query_user=common.get('./query_user'),File=common.get('./file.file_object'),tmpl=require('./tmpl'),msg=require('./upload.msg'),toolbar=require('./toolbar.toolbar'),event=require('./upload.event');require('uploadbox_css');var view=new Module('upload_view',{render:function(){var toolbar=require('./toolbar.toolbar');this.listenTo(toolbar,'render',function(){view.rest=$(tmpl.upload_rest()).appendTo(toolbar.get_$main_bar()).hide();view.rest_undone=view.rest.find('.upload-rest-num').hide();view.rest_undone_num=view.rest_undone.find('.rest_text');view.icon_err=view.rest.find('.icon-err');view.$dom=$(tmpl.upload_header()).appendTo(toolbar.get_$main_bar().parent()).hide();view.upload_header=view.$dom.find('.upload-header').show();view.upload_title=view.upload_header.find('.upload-title');view.close_button=view.upload_header.find('.close');view.upload_body=view.$dom.find('.upload-body');view.upload_files=view.$dom.find('.upload-files');view.install_plugin=view.$dom.find('.upload-ctrl-tips');view.upload_button=toolbar._get_$upload_button();view.upload_tips=require('./upload.upload_tips');event.init_header.call(view);});}});view.render();view.show=function(){if(view.state==='hide'){return;}
view.$dom.show();var info=view.master.__static.get_info();view.upload_header.show();view.close_button.html('收起').attr('data-action','click_close');if(info.length===0){return view.upload_title.html('正在上传');}
view.auto_height();view.upload_tips.show(view.install_plugin);view.view_upload_rest();view.show_speed.start();view.upload_title.html('正在上传第'+info.start+'/'+info.length+'个文件');};view.auto_height=function(){var info=view.master.__static.get_info(),length=Math.min(info.start,info.length);view.upload_body.height(info.length>8?432:'auto');};view.hide=function(){view.$dom.hide();view.show_speed.stop();};view.close=function(){view.state='hide';view.hide();};view.clear_all=function(){view.$dom.hide();view.upload_files.empty();view.icon_err.hide();view.auto_height();view.state='show';};view.uploading=function(){view.upload_button.addClass('uploading');};view.stop_uploading=function(){view.upload_button.removeClass('uploading');};view.get_html=function(){return{"li_class":"start","file_type":this.upload_obj.get_file_type(),'upload_state_click':'upload-pause','upload_wording':'暂停','full_name':this.upload_obj.file_name,'file_name':file_type_map.revise_file_name(this.upload_obj.file_name,2),'file_size':File.get_readability_size(this.upload_obj.file_size)};};var View_instance=function(upload_obj){this.upload_obj=upload_obj;this.state=null;this.dom=$(tmpl.upload_instance(view.get_html.call(this))).appendTo(view.upload_files).show();this.upload_msg=this.dom.find('.upload-msg');this.file_size=this.dom.find('.filesize');if(!this.upload_obj.file_size){this.file_size.hide();}
this.upload_process_parent=this.dom.find('.ui-progbar');this.upload_process=this.dom.find('.ui-progbar-val');this.upload_state=this.dom.find('.upload-state');this.upload_cancel2=this.dom.find('.upload-cancel').show();this.upload_click=this.dom.find('.upload-pause');this.upload_del=this.dom.find('.upload-del');this.upload_icon_sh=this.dom.find('.upload-icon-sh');event.init.call(this);this.upload_obj.speed.reset();this.upload_msg.attr('class','upload-msg').html('等待上传').show();this.upload_click.hide();this.file_sign_update_process=functional.throttle(this.file_sign_update_process,500);this.upload_file_update_process=functional.throttle(this.upload_file_update_process,500);};view.show_speed=(function(){var t,fn,start,stop;fn=function(){var all_speed=0,info=view.master.__static.get_info();view.master.__static.curr_upload_each(function(){var upload_speed;if(this.state==='upload_file_update_process'){upload_speed=this.speed.get_speed.call(this);if(upload_speed){this.view.upload_state.html(File.get_readability_size(upload_speed)+'/S').show();all_speed+=upload_speed||0;}}});if(all_speed){view.upload_title.html('正在上传第'+info.start+'/'+info.length+'个文件 ('+File.get_readability_size(all_speed)+'/S'+')');}};start=function(){if(t){return;}
t=setInterval(function(){fn();},1000);};stop=function(){clearInterval(t);t=null;};return{start:start,stop:stop};})();View_instance.prototype.start=function(){view.uploading();this.upload_process_parent.hide();var info=view.master.__static.get_info();if(info.length){view.upload_title.html('正在上传第'+info.start+'/'+info.length+'个文件');}
view.show();};View_instance.prototype.wait=function(){this.upload_del.css('display','inline-block');this.upload_process_parent.show();};View_instance.prototype.file_sign_update_process=function(){if(this.state!=='file_sign_update_process'){return;}
var percent=this.upload_obj.file_sign_update_process/this.upload_obj.file_size*100|0;this.upload_msg.html('扫描百分比:  '+percent+'%');};View_instance.prototype.file_sign_done=function(){this.upload_msg.attr('class','upload-msg').show();this.upload_msg.html('正在上传');};View_instance.prototype.error=function(){var __self=this;this.upload_msg.attr('class','upload-err').show();this.upload_process_parent.hide();this.upload_del.show();this.upload_click.hide();var error_code=msg.get('upload_error',this.upload_obj.code);this.upload_msg.html('上传失败: '+error_code);if(this.upload_obj.error_type!=='client'){$('<a style="margin-left:10px;text-decoration:underline" href="#">重试</a>').appendTo(this.upload_msg).on('click',function(e){e.preventDefault();__self.upload_obj.change_state('start',true);});}
view.view_upload_rest();};View_instance.prototype.upload_file_update_process=function(state){if(!this.upload_obj.processed||this.state!=='upload_file_update_process'){return;}
this.show_process_pencent();};View_instance.prototype.done=function(){var new_name=file_type_map.revise_file_name(this.upload_obj.new_name||'',1);this.upload_msg.html(new_name?'已更名为: '+new_name:'完成').show();this.upload_msg.attr('class','upload-msg');this.upload_process.hide();this.upload_process_parent.hide();this.upload_state.hide();this.upload_click.attr('class','upload-finish').attr('title','完成').show().off();this.file_size.html('('+File.get_readability_size(this.upload_obj.file_size)+'/'+File.get_readability_size(this.upload_obj.file_size)+')');this.upload_del.hide();view.view_upload_rest();};View_instance.prototype.pause=function(){this.upload_click.attr('class','upload-continue').attr('data-action','click_continuee').attr('title','继续').show();this.upload_del.css('display','inline-block');};View_instance.prototype.resume_pause=function(){this.upload_file_update_process('resume_pause');this.upload_click.attr('class','upload-continue').attr('data-action','click_resume_continuee').attr('title','继续').show();this.upload_del.css('display','inline-block');view.view_upload_rest();this.show_process_pencent();};View_instance.prototype.show_process_pencent=function(){var width=this.upload_obj.processed/this.upload_obj.file_size*100,curr_file_size;this.upload_process_parent.show();this.upload_msg.hide();this.upload_process.width(width+'%');curr_file_size=this.upload_obj.file_size*width/100;curr_file_size=Math.min(curr_file_size,this.upload_obj.file_size);this.file_size.html('('+File.get_readability_size(curr_file_size)+'/'+File.get_readability_size(this.upload_obj.file_size)+')');};View_instance.prototype.continuee=function(){this.upload_click.attr('class','upload-pause').attr('data-action','click_pause').attr('title','暂停').show();this.upload_del.hide();};View_instance.prototype.resume_continuee=function(){this.upload_click.attr('class','upload-pause').attr('data-action','click_pause').attr('title','暂停').show();this.upload_del.hide();view.show();};View_instance.prototype.clear=function(){view.auto_height();var info=view.master.__static.get_info(),curr_upload_length=view.master.__static.get_curr_cache().length||0;this.dom.off().empty().remove();view.view_upload_rest();if(info.length!==0){if(curr_upload_length>0){view.show();}
return;}
view.hide();return view.rest.hide();};View_instance.prototype.show=function(){view.state='show';view.show();};View_instance.prototype.hide=function(){view.state='hide';view.hide();};View_instance.prototype.close=function(){view.state='hide';view.hide();};view.show_done=function(done_count,error_count){var str=' ';view.close_button.html('完成').attr('data-action','click_remove');if(done_count){str+=done_count+'个文件上传成功';}
if(error_count){str+=' '+error_count+'个文件上传失败';}
view.upload_title.html(str);view.stop_uploading();};View_instance.prototype.change_state=function(){var __state=this.upload_obj.state,state=this[__state];if(!state){return;}
this.state=__state;state.call(this,__state);};View_instance.prototype.transform_state=(function(){var g={};g.file_sign_update_process=function(){this.upload_msg.attr('class','upload-time').show();this.upload_del.hide();};g.upload_file_update_process=function(){this.upload_msg.hide();this.upload_process_parent.show();if(this.upload_obj.can_pause){this.upload_click.attr('class','upload-pause').attr('data-action','click_pause').attr('title','暂停').show();this.upload_del.hide();}};return function(state){if(!g[state]){return;}
g[state].call(this,state);};})();view.view_upload_rest=function(){var info=view.master.__static.get_info(),curr_upload_length=view.master.__static.get_curr_cache().length||0,rest_undone_num;if(curr_upload_length===0){view.rest.show();view.rest_undone.hide();view.icon_err.attr('class',info.error?'icon-err':'upload_ico').show();return view.show_done(info.done,info.error);}
view.rest.show();view.icon_err.hide();view.rest_undone.show();rest_undone_num=info.length-info.start+curr_upload_length;return view.rest_undone_num.html(Math.max(rest_undone_num,0));};upload_event.on('remove_rest_icon',function(){view.rest.hide();});view.add=function(upload_obj){return new View_instance(upload_obj);};view.View_instance=View_instance;module.exports=view;});define.pack("./view_switch.ui",["lib","common","$","./tmpl","./view_switch.view_switch"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),Module=common.get('./module'),user_log=common.get('./user_log'),tmpl=require('./tmpl'),file_list,last_view,undefined;var ui=new Module('disk_view_switch_ui',{render:function($to){var view_switch=require('./view_switch.view_switch'),$el=this._$el=$(tmpl.view_switch({cur_view:view_switch.get_cur_view()}));$to.replaceWith($el);$el.on('click.view_switch_ui','[data-view]:not(.selected)',function(e){e.preventDefault();var $btn=$(this),view_name=$btn.attr('data-view');$btn.addClass('current').siblings().removeClass('current');view_switch.set_cur_view(view_name);user_log('disk_switch_list_view');});if($.browser.chrome){$el.find('i').each(function(i,tag_i){var $i=$(tag_i),org_bg=$i.css('background-image');if(org_bg){setTimeout(function(){$i.css('background-image',org_bg);},1);}});}},toggle:function(visible){this._$el.toggle(visible);}});return ui;});define.pack("./view_switch.view_switch",["lib","common","$","./tmpl","./view_switch.ui"],function(require,exports,module){var lib=require('lib'),common=require('common'),$=require('$'),collections=lib.get('./collections'),console=lib.get('./console'),text=lib.get('./text'),events=lib.get('./events'),cookie=lib.get('./cookie'),store=lib.get('./store'),constants=common.get('./constants'),Module=common.get('./module'),log_event=common.get('./global.global_event').namespace('log'),tmpl=require('./tmpl'),view_name_map_value={grid:1,azlist:3,newestlist:4},view_value_map_name=(function(){var n,map={};for(n in view_name_map_value){if(view_name_map_value.hasOwnProperty(n)){map[view_name_map_value[n]]=n;}}
return map;})(),default_view='grid',store_name='view_switch_type',cur_view=(function(){var view_value=store.get(store_name)||cookie.get(store_name);if(view_value&&view_value_map_name.hasOwnProperty(view_value)){return view_value_map_name[view_value];}else{return default_view;}})(),last_not_temp_view=cur_view,undefined;var view_switch=new Module('disk_view_switch',{ui:require('./view_switch.ui'),render:function(){this._log();},get_view_map:function(){return view_name_map_value;},temp_to_list:function(){this.set_cur_view('azlist',true);},temp_to_thumb:function(){this.set_cur_view('grid',true);},exit_temp_view:function(){this.set_cur_view(last_not_temp_view,false);},set_cur_view:function(view_name,temp){if(view_name!==cur_view&&view_name_map_value.hasOwnProperty(view_name)){cur_view=view_name;var is_grid=this.is_grid_view();if(!temp){last_not_temp_view=view_name;var value=view_name_map_value[view_name];store.set(store_name,value);this._log();}
this.trigger('switch',is_grid,this.is_list_view(),view_name);}},get_cur_view:function(){return cur_view;},is_list_view:function(){var mode=this.get_cur_view();return mode==='list'||mode==='newestlist'||mode==='azlist';},is_grid_view:function(){return this.get_cur_view()=='grid';},_log:function(){log_event.trigger('view_type_change',view_name_map_value[cur_view]);}});return view_switch;});define.pack("./tmpl",[],function(require,exports,module){var tmpl={'header':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var common=require('common'),constants=common.get('./constants');__p.push('    <div class="header-att disk-header-att">\r\n\
        <!-- 工具条s -->\r\n\
        <div id="_disk_toolbar_container" class="box_mod_maintools"></div>\r\n\
\r\n\
        <!-- 面包屑 + 视图切换 -->\r\n\
        <div class="addrbar">\r\n\
            <!-- 路径 -->\r\n\
            <div id="_disk_file_path" data-no-selection class="ui-bread"></div>\r\n\
\r\n\
            <!-- 视图切换 -->\r\n\
            <div id="_disk_view_switch" data-no-selection></div>\r\n\
\r\n\
            <!-- 小提示 -->\r\n\
            <div id="_disk_mini_tips"></div>\r\n\
            <i class="shadow"></i>\r\n\
        </div>\r\n\
\r\n\
        <!-- 列表头 -->\r\n\
        <div id="_disk_list_column_model"></div>\r\n\
    </div>');return __p.join("");},'body':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    <div id="_disk_body" class="box_mod_datalist">\r\n\
        <div id="_disk_view" class="disk-view ui-view">\r\n\
            <!-- 文件列表 -->\r\n\
        </div>\r\n\
    </div>');return __p.join("");},'file_move_box':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),$=require('$'),text=lib.get('./text'),tmpl=require('./tmpl'),root_dir=data.root_dir,len=data.files.length,first=data.files[0];__p.push('    <div class="file-mv-cnt">\r\n\
\r\n\
        <div class="_desc file-mv-desc">\r\n\
            <span class="fileimg"><i class="filetype icon-');_p(first.get_type());__p.push('"></i></span>\r\n\
            <div class="fileinfo">\r\n\
                <span class="filename">');_p(text.text(text.smart_sub(first.get_name(),17)));__p.push('</span>');if(len>1){__p.push('                    <span class="filesum">等 ');_p(len);__p.push(' 个文件</span>');}__p.push('                <span class="filesize">');_p(first.get_readability_size());__p.push('</span>\r\n\
            </div>\r\n\
        </div>\r\n\
\r\n\
        <div class="ui-line"></div>\r\n\
\r\n\
        <div class="file-mv-body">\r\n\
            <h4 class="ui-title">移动到：</h4>\r\n\
            <ul class="_tree ui-tree">');_p(tmpl.file_move_box_node({file:root_dir,par_id:root_dir.get_parent().get_id()}));__p.push('            </ul>\r\n\
        </div>\r\n\
\r\n\
    </div>');return __p.join("");},'file_move_box_node_list':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),text=lib.get('./text'),tmpl=require('./tmpl'),files=data.files,par_id=data.par_id;__p.push('    <ul class="ui-tree-sub">');$.each(files,function(i,file){_p(tmpl.file_move_box_node({file:file,par_id:par_id}));});__p.push('    </ul>');return __p.join("");},'file_move_box_node':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),text=lib.get('./text'),tmpl=require('./tmpl'),common=require('common'),click_tj=common.get('./configs.click_tj');file=data.file,par_id=data.par_id;__p.push('    <li id="_file_move_box_node_');_p(file.get_id());__p.push('" data-file-id="');_p(file.get_id());__p.push('" data-file-pid="');_p(par_id||'');__p.push('">\r\n\
        <a href="#" hidefocus="on"><i class="_expander" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_MOVE_EXPAND_DIR'));__p.push('></i>');_p(text.text(file.get_name()));__p.push('</a>\r\n\
    </li>');return __p.join("");},'rename_editor':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    <span class="fileedit" style="display:none;">\r\n\
        <input class="ui-input" type="text" value=""/>\r\n\
    </span>');return __p.join("");},'dragging_cursor':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),$=require('$'),length=data.files.length,files=data.files.slice(0,4);__p.push('    <div class="icons">');$.each(files,function(i,file){__p.push('            <i class="icon icon');_p(i);__p.push(' filetype icon-');_p(file.get_type());__p.push('"></i>');});__p.push('    </div>\r\n\
    <span class="sum">');_p(length);__p.push('</span>\r\n\
');return __p.join("");},'link_share_content':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var common=require('common'),constants=common.get('./constants');__p.push('    <div class="ui-confirm-cnt">\r\n\
        <i class="icon-xbox icon-xbox-ok"></i>\r\n\
        <h4 class="ui-title ui-normal">获取下载链接成功！</h4>\r\n\
        <div class="ui-text share-info">\r\n\
\r\n\
            <!-- 链接 -->\r\n\
            <a data-function="link" class="ui-bold" href="#" target="_blank">#</a>\r\n\
\r\n\
            <div class="ui-copys">\r\n\
                <!-- 复制 -->\r\n\
                <div data-function="copy" class="ui-copy" style="width:55px;height:18px;">复制链接</div>\r\n\
\r\n\
                <!-- 提示 -->\r\n\
                <div data-function="tip" style="display: none;" class="ui-copy-ok">\r\n\
                    <!--#link_share_copy_error-->\r\n\
                </div>\r\n\
            </div>\r\n\
        </div>\r\n\
    </div>');return __p.join("");},'link_share_copy_error':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var text=require('lib').get('./text');__p.push('    ');_p(text.text(data.msg));__p.push('<i class="ui-darr"></i><i class="ui-darr ui-darr-white"></i>');return __p.join("");},'file_list':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    <!-- 目录 -->\r\n\
    <div class="dirs-view">\r\n\
\r\n\
        <!-- 目录标题（“文件夹”） -->\r\n\
        <div id="_disk_files_dir_title" class="ui-title-bar" style="display:none;">\r\n\
            <h3 class="ui-title">文件夹</h3>\r\n\
            <div class="ui-title-line"></div>\r\n\
        </div>\r\n\
\r\n\
        <!-- 空目录时的提示 -->\r\n\
        <div id="_disk_files_empty" class="dirs-empty">该文件夹为空，您可以点击"上传"按钮或者使用微云客户端上传文件。</div>\r\n\
\r\n\
        <!-- 目录列表 -->\r\n\
        <div id="_disk_files_dir_list" class="dirs">\r\n\
            <!-- 嵌套模板 file_item -->\r\n\
        </div>\r\n\
    </div>\r\n\
\r\n\
    <!-- 文件 -->\r\n\
    <div class="files-view">\r\n\
\r\n\
        <!-- 标题（“文件”） -->\r\n\
        <div id="_disk_files_file_title" class="ui-title-bar" style="display:none;">\r\n\
            <h3 class="ui-title">文件</h3>\r\n\
            <div class="ui-title-line"></div>\r\n\
        </div>\r\n\
\r\n\
        <!-- 文件列表 -->\r\n\
        <div id="_disk_files_file_list" class="files">\r\n\
            <!-- 嵌套模板 file_item -->\r\n\
        </div>\r\n\
    </div>');return __p.join("");},'file_item':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),common=require('common'),$=require('$'),text=lib.get('./text'),constants=common.get('./constants'),click_tj=common.get('./configs.click_tj'),view_switch=require('./view_switch.view_switch'),files=data.files,only_content=data.only_content===true,show_thumb=data.show_thumb!==false,icon_map=data.icon_map,default_image=constants.RESOURCE_BASE+(view_switch.is_list_view()?'/img/img-32.png':'/img/img-70.png'),time_str_len='yyyy-MM-dd hh:mm'.length;$.each(files,function(i,file){var is_dir=file.is_dir(),is_broken=file.is_broken_file(),is_image=file.is_image(),is_removable=file.is_removable(),is_movable=file.is_movable(),is_downable=file.is_downable(),is_renamable=file.is_renamable(),is_selectable=file.is_selectable(),is_whole_click=true;if(!only_content){__p.push('\r\n\
    <div id="_disk_file_item_');_p(file.get_id());__p.push('" data-file-id="');_p(file.get_id());__p.push('"');_p(is_removable?'':'data-no-remove');__p.push(' ');_p(is_movable?'':'data-no-move');__p.push(' ');_p(is_downable?'':'data-no-down');__p.push('            ');_p(is_renamable?'':'data-no-rename');__p.push(' ');_p(is_selectable?'':'data-no-sel');__p.push(' ');_p(is_whole_click?'data-whole-click':'');__p.push('            class="ui-item');_p([is_broken?' ui-broken':'',is_removable?'':' ui-no-remove',is_movable?'':' ui-no-move',is_downable?'':' ui-no-down',is_renamable?'':' ui-no-rename',is_selectable?'':' ui-no-sel',is_whole_click?' ui-whole-click':''].join(''));__p.push('">');}
__p.push('            <span class="filemain">\r\n\
\r\n\
                <label class="filecheck"></label>\r\n\
                <!-- code by fixed ie6 bug -->\r\n\
                <span class="fileie6">\r\n\
                    <span class="fileimg" ');_p(click_tj.make_tj_str(is_dir?'FOLDER_ICON':'FILE_ICON'));__p.push('>');if(is_broken){__p.push('                            <i data-action="enter" class="filetype icon-filebroken"></i>');}else if(is_image&&show_thumb){__p.push('                            <!-- 缩略图 -->\r\n\
                            <img data-action="enter" class="default" src="');_p(default_image);__p.push('" unselectable="on"/>');}else{__p.push('                            <!-- 图标 -->\r\n\
                            <i data-action="enter" class="filetype ');_p(icon_map[file.get_icon()]||('icon-'+(file.get_type()||'file')));__p.push('"></i>');}__p.push('                    </span>\r\n\
\r\n\
                    <!-- 文件名 -->\r\n\
                    <span data-action="enter" data-name="file_name" class="filename" title="');_p(text.text(file.get_name()));__p.push('" ');_p(click_tj.make_tj_str(is_dir?'FOLDER_NAME':'FILE_NAME'));__p.push('>');_p(text.text(file.get_name()));__p.push('</span>\r\n\
                </span>\r\n\
\r\n\
                <!-- 文件功能菜单 -->\r\n\
                <span class="filemenu">');if(is_dir){__p.push('                        ');if(is_renamable){__p.push('                            <a class="menuicon icon-edit" data-function="rename" title="重命名" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('ITEM_RENAME'));__p.push('></a>');}__p.push('                        ');if(is_removable){__p.push('                            <a class="menuicon icon-del" data-function="remove" title="删除" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('ITEM_DELETE'));__p.push('></a>');}__p.push('                    ');}else{__p.push('                        ');if(!is_broken){__p.push('                            <a class="icon-download" data-function="download" title="下载" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('ITEM_DOWNLOAD'));__p.push('></a>\r\n\
                            <a class="icon-more" data-function="more" title="更多操作" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('FILE_MENU_MORE'));__p.push('></a>');}else{__p.push('                            ');if(is_removable){__p.push('                                <a class="menuicon icon-del" data-function="remove" title="删除" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('ITEM_DELETE'));__p.push('></a>');}__p.push('                        ');}__p.push('                    ');}__p.push('                </span>\r\n\
            </span>\r\n\
            <span class="filesize">');_p(file.get_readability_size());__p.push('</span>\r\n\
            <span class="filetime">');_p((file.get_modify_time()||file.get_create_time()).substr(0,time_str_len));__p.push('</span>');if(!only_content){__p.push('        </div>');}
__p.push('    ');});__p.push('');return __p.join("");},'vir_dir_file_list':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');__p.push('    <div data-view="special" data-no-selection class="app-inner" style="display: none;">');__p.push('        <div data-sub-view="list" class="feeds" style="display:none;">');__p.push('            <ul data-type="dir" style="display:none;">');__p.push('</ul>');__p.push('            <ul data-type="file" style="display:none;">');__p.push('</ul>\r\n\
        </div>');__p.push('        <div data-sub-view="thumb" class="app-inner media-inner" style="display:none;">');__p.push('            <div data-type="dir" class="dirs medias" style="display:none"></div>');__p.push('            <div data-type="file" class="files medias" style="display:none"></div>\r\n\
        </div>');__p.push('        <a data-action="more" href="#" class="load-more" style="visibility:hidden">加载更多</a>\r\n\
        <p data-action="empty-tip" style="display:none;" class="empty-text"></p>\r\n\
    </div>');__p.push('    <div data-view="classic" data-no-selection class="dirs-view" style="display: none;">');__p.push('        <div data-type="dir" class="dirs" style="display:none;"></div>');__p.push('        <div data-type="file" class="files" style="display:none;"></div>');__p.push('        <a data-action="more" href="#" class="load-more" style="visibility:hidden">加载更多</a>\r\n\
        <p data-action="empty-tip" style="display:none;" class="empty-text"></p>\r\n\
    </div>');return __p.join("");},'vir_dir_file_item':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),common=require('common'),constants=common.get('./constants'),text=lib.get('./text'),date_time=lib.get('./date_time'),view_switch=require('./view_switch.view_switch'),ui_virtual=require('./file_list.ui_virtual'),icon_map=data.icon_map,default_image=constants.RESOURCE_BASE+(view_switch.is_list_view()?'/img/img-32.png':'/img/img-70.png'),text_short_len=128,undef;for(var i=0,l=data.files.length;i<l;i++){var file=data.files[i],icon=icon_map[file.get_icon()]||'',file_name=text.text(file.get_name());switch(file.class_name){case'PlaintextNode':var short_text=ui_virtual.fix_user_text(file.get_content(),text_short_len),long_text=ui_virtual.fix_user_text(file.get_content());__p.push('<li id="_disk_vdir_item_');_p(file.get_id());__p.push('" data-file-id="');_p(file.get_id());__p.push('" class="feed-item ');_p(i%2?'':'odd');__p.push('">\r\n\
                    <span class="aside">');_p(this._date_time(file.get_create_time()));__p.push('                    </span>\r\n\
                    <div class="feed-cnt">\r\n\
                        <div class="feed-original">');__p.push('                            <div data-name="short-text" class="ui-text">');_p(short_text);__p.push('</div>');__p.push('                            <div data-name="long-text" style="display:none;" class="ui-text">');_p(long_text);__p.push('</div>');if(short_text.length!==long_text.length||short_text!==long_text){__p.push('                                <div class="feed-foot"><a data-action="text-expand" href="#">点击展开</a></div>');}__p.push('                        </div>\r\n\
                        <span class="feed-action"><a data-action="remove" class="icon-rm" href="#" title="删除">&times;</a></span>\r\n\
                    </div>\r\n\
                </li>');break;case'VoiceNode':var duration=file.get_duration(),voice_width=50,bar_width=(duration<=30)?(voice_width+(duration*5)):(voice_width+(30*5)+(duration-30)*2);__p.push('                <li id="_disk_vdir_item_');_p(file.get_id());__p.push('" data-file-id="');_p(file.get_id());__p.push('" class="feed-item ');_p(i%2?'':'odd');__p.push('">\r\n\
                    <span class="aside">');_p(this._date_time(file.get_create_time()));__p.push('                    </span>\r\n\
                    <div class="feed-cnt">\r\n\
                        <div class="feed-original">\r\n\
                            <a data-action="play-voice" hidefocus="on" href="#" style="width:');_p(bar_width);__p.push('px;" class="audio"><i></i></a>\r\n\
                            <span data-action="play-time" class="audio-len">');_p(duration);__p.push('\'\'</span>\r\n\
                            <span data-action="play-loading" class="audio-status" style="display:none;">正在载入...</span>\r\n\
                        </div>\r\n\
                        <span class="feed-action"><a data-action="remove" class="icon-rm" href="#" title="删除">&times;</a></span>\r\n\
                    </div>\r\n\
                </li>');break;case'ArticleNode':__p.push('                <li id="_disk_vdir_item_');_p(file.get_id());__p.push('" data-action="enter" data-file-id="');_p(file.get_id());__p.push('" class="feed-item ');_p(i%2?'':'odd');__p.push('">\r\n\
                    <span class="aside">');_p(this._date_time(file.get_create_time()));__p.push('                    </span>\r\n\
                    <div class="feed-cnt">\r\n\
                        <div data-action="open" class="feed-original">\r\n\
                            <div class="ui-title">');_p(text.text(file.get_title()));__p.push('</div>\r\n\
                            <div class="ui-text">');_p(text.text(file.get_desc()));__p.push('</div>\r\n\
                        </div>\r\n\
                        <span class="feed-action"><a data-action="remove" class="icon-rm" href="#" title="删除">&times;</a></span>\r\n\
                    </div>\r\n\
                </li>');break;default:var is_image=file.is_image(),is_video=file.get_type()==='mp4';__p.push('<div id="_disk_vdir_item_');_p(file.get_id());__p.push('" data-action="enter" class="ui-item" data-file-id="');_p(file.get_id());__p.push('">\r\n\
                    <span class="filemain">\r\n\
                        <label class="filecheck"></label>\r\n\
                        <!-- code by fixed ie6 bug -->\r\n\
                        <span class="fileie6">\r\n\
                            <span data-tj-value="52301" data-tj-action="btn-adtag-tj" class="fileimg"><!-- 图标 -->');if(is_image){__p.push('                                    <img src="http://imgcache.qq.com/vipstyle/nr/box/img/img-70.png" unselectable="on" style="visibility:hidden"/>');}else if(is_video){__p.push('                                    <img src="http://imgcache.qq.com/vipstyle/nr/box/web/images/wx-video-default.png" unselectable="on"/>');}else{__p.push('                                    <i class="filetype ');_p(icon);__p.push('"></i>');}__p.push('                            </span>');if(!(is_image||is_video)){__p.push('                                <span data-tj-value="52302" data-tj-action="btn-adtag-tj" title="');_p(file_name);__p.push('" class="filename" data-name="file_name">');_p(file_name);__p.push('</span>');}__p.push('                        </span>');if(!file.is_dir()){__p.push('                            <!-- 文件功能菜单 -->\r\n\
                            <span class="filemenu">\r\n\
                                <a class="icon-download" data-action="download" title="下载" href="#" hidefocus="on"></a>\r\n\
                                <a class="icon-del" data-action="remove" title="删除" href="#" hidefocus="on"></a>\r\n\
                            </span>');}__p.push('                    </span>\r\n\
                </div>');break;}}
__p.push('');return __p.join("");},'_date_time':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('  ');var lib=require('lib'),date_time=lib.get('./date_time'),time_values=date_time.readability(data);if(time_values[0]==='today'){__p.push('<span class="feed-date">');_p(time_values[1]);__p.push('</span><span class="feed-time">');_p(time_values[2]);__p.push('</span>');}
else if(time_values[0]==='yesterday'){__p.push('<span class="feed-date">');_p(time_values[1]);__p.push('</span>');}
else{__p.push('<span class="feed-day">');_p(time_values[1]);__p.push('</span><span class="feed-month">');_p(time_values[2]);__p.push('</span>');}__p.push('');return __p.join("");},'file_path':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var nodes=data.nodes,enable=data.enable!==false;__p.push('    <div class="step">\r\n\
        <table class="step-inner"><tbody><tr>');_p(tmpl.file_path_items(data));__p.push('        </tr></tbody></table>\r\n\
    </div>');return __p.join("");},'file_path_items':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),$=require('$'),text=lib.get('./text'),file_list=require('./file_list.file_list'),common=require('common'),click_tj=common.get('./configs.click_tj'),name_len=10,nodes=data.nodes,enable=data.enable!==false,disable_class='ui-bread-current';if(nodes&&nodes.length){var cur_node=file_list.get_cur_node();if(cur_node){var cur_dir_id=cur_node.get_id();$.each(nodes,function(i,node){var name=text.text(text.smart_sub(node.get_name(),name_len)),first=i<=0,leaf=i===nodes.length-1,is_cur=node.get_id()===cur_dir_id;__p.push('<td class="');_p(leaf?'current':'');__p.push(' ');_p(enable?'':'disabled');__p.push('" data-cur-node="');_p(is_cur);__p.push('" ');if(enable&&!leaf){__p.push(' data-file-id="');_p(node.get_id());__p.push('" ');}__p.push('>');if(first){__p.push('                        <a href="javascript:void(0)" hidefocus="on" class="step-text" ');_p(click_tj.make_tj_str('DISK_BREAD_WEIYUN'));__p.push('>');_p(name);__p.push('                        </a>\r\n\
                        <i class="border"></i>');}else{__p.push('                        <a href="javascript:void(0)" hidefocus="on" class="step-arr" ');_p(click_tj.make_tj_str('DISK_BREAD_DIR'));__p.push('>\r\n\
                            <span class="step-text">');_p(name);__p.push('</span>\r\n\
                        </a>');}
__p.push('</td>');});}}
__p.push('');return __p.join("");},'mini_tip':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    <div class="ui-tips"></div>');return __p.join("");},'main_toolbar':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var common=require('common'),constants=common.get('./constants'),click_tj=common.get('./configs.click_tj');__p.push('    <div id="_disk_toolbar" class="disk-toobar">\r\n\
        <div class="ui-btns toolbar-btns disk-btns clear"\r\n\
            ><a data-action="upload" data-no-selection class="ui-btn ui-btn-upload" href="#" hidefocus="on"            ');_p(click_tj.make_tj_str('TOOLBAR_UPLOAD'));__p.push('><i class="icon-upload"></i>上传</a\r\n\
            ><a data-action="download" data-no-selection class="ui-btn ui-btn-down ui-gap" href="#" hidefocus="on"     ');_p(click_tj.make_tj_str('TOOLBAR_DOWNLOAD'));__p.push('><i class="icon-down"></i>下载</a\r\n\
            ><a data-action="move_files" data-no-selection class="ui-btn ui-btn-move" href="#" hidefocus="on"          ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_MOVE'));__p.push('><i class="icon-move"></i>移动</a\r\n\
            ><a data-action="remove_files" data-no-selection class="ui-btn ui-btn-del" href="#" hidefocus="on"         ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_DELETE'));__p.push('><i class="icon-del"></i>删除</a\r\n\
            ><a data-action="create_dir" data-no-selection class="ui-btn ui-btn-mkdir ui-gap" href="#" hidefocus="on"  ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_MKDIR'));__p.push('><i class="icon-mkdir"></i>新建文件夹</a\r\n\
            ><a data-action="reload" data-no-selection class="ui-btn ui-btn-refresh ui-gap" href="#" hidefocus="on" title="刷新" ');_p(click_tj.make_tj_str('TOOLBAR_REFRESH'));__p.push('><i class="icon-refresh"></i></a\r\n\
            >');if(constants.IS_APPBOX){__p.push('<a data-action="recycle" data-no-selection class="ui-btn ui-btn-recycle" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('TOOLBAR_RECYCLE'));__p.push('><i class="icon-recycle"></i>回收站</a>');}__p.push('        </div>\r\n\
    </div>');return __p.join("");},'toolbar_manage_menu':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var common=require('common'),click_tj=common.get('./configs.click_tj');__p.push('    <div data-no-selection class="ui-popmenu toolbar-menu" style="display:none;">\r\n\
        <ul>\r\n\
            <li><a data-action="move_files" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_MOVE'));__p.push(' href="#" hidefocus="on"><i class="icon-mv"></i>移动</a></li>\r\n\
            <li><a data-action="remove_files" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_DELETE'));__p.push(' href="#" hidefocus="on"><i class="icon-rm"></i>删除</a></li>\r\n\
            <li><a data-action="create_dir" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_MKDIR'));__p.push(' href="#" hidefocus="on"><i class="icon-md"></i>新建文件夹</a></li>\r\n\
        </ul>\r\n\
    </div>');return __p.join("");},'download_toolbar':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var common=require('common'),click_tj=common.get('./configs.click_tj');__p.push('    <div data-no-selection class="box_mod_contraler">\r\n\
        <div class="for_folder"\r\n\
            ><a data-action="back" ');_p(click_tj.make_tj_str('TOOLBAR_DOWNLOAD_BACK'));__p.push(' class="btn_cancel" href="#" hidefocus="on"><span><b class="icon_cancel"></b>返回</span></a\r\n\
            ><a data-action="down_holder" class="disable" href="#" hidefocus="on"><span><b class="icon_download"></b>下载</span></a\r\n\
            ><a data-action="start_down_files" ');_p(click_tj.make_tj_str('TOOLBAR_DOWNLOAD_OK'));__p.push(' class="btn_xfdown" href="#" style="width: 118px; padding-right: 0px; display: none;" hidefocus="on"><span><b class="icon_mv"></b>下载 (<strong class="_n">-</strong>)</span></a>\r\n\
            <s style="color:#888;margin-top:7px;margin-left:5px;text-decoration: none;">请选择需要下载的文件</s>\r\n\
        </div>\r\n\
    </div>');return __p.join("");},'move_toolbar':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var common=require('common'),click_tj=common.get('./configs.click_tj');__p.push('    <div data-no-selection class="box_mod_contraler">\r\n\
        <div class="for_folder"\r\n\
            ><a data-action="back" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_MOVE_BACK'));__p.push(' class="btn_cancel" href="#" hidefocus="on"><span><b class="icon_cancel"></b>返回</span></a\r\n\
            ><a data-action="move_holder" class="disable" href="#" hidefocus="on"><span><b class="icon_mv"></b>移动</span></a\r\n\
            ><a data-action="start_move_files" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_MOVE_OK'));__p.push(' class="btn_move" href="#" style="width: 118px; padding-right: 0px; display: none;" hidefocus="on"><span><b class="icon_mv"></b>移动 (<strong class="_n">-</strong>)</span></a>\r\n\
            <s style="color:#888;margin-top:7px;margin-left:5px;text-decoration: none;">请选择需要移动的文件</s>\r\n\
        </div>\r\n\
    </div>');return __p.join("");},'remove_toolbar':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var common=require('common'),click_tj=common.get('./configs.click_tj');__p.push('    <div class="box_mod_contraler">\r\n\
        <div class="for_folder"\r\n\
            ><a data-action="back" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_DELETE_BACK'));__p.push(' class="btn_cancel" href="#" hidefocus="on"><span><b class="icon_cancel"></b>返回</span></a\r\n\
            ><a data-action="remove_holder" class="disable" href="#" hidefocus="on"><span><b class="icon_delete"></b>删除</span></a\r\n\
            ><a data-action="start_remove_files" ');_p(click_tj.make_tj_str('TOOLBAR_MANAGE_DELETE_OK'));__p.push(' class="btn_del" href="#" hidefocus="on" style="width: 118px; padding-right: 0px; display: none;" hidefocus="on"><span><b class="icon_delete"></b>删除 (<strong class="_n">-</strong>)</span></a>\r\n\
            <s style="color:#888;margin-top:7px;margin-left:5px;text-decoration: none;">请选择需要删除的文件</s>\r\n\
        </div>\r\n\
    </div>');return __p.join("");},'upload_header':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('\r\n\
            <div data-no-selection class="upload-box" style="">\r\n\
                <div class="upload-header ui-pos">\r\n\
                    <div class="upload-glance">\r\n\
                        <span class="upload-title">正在上传</span>\r\n\
                    </div>\r\n\
                    <div class="ui-pos-right">\r\n\
                        <a href="javascript:void(0)" class="close" data-action="close">收起</a>\r\n\
                   </div>\r\n\
                </div>\r\n\
                <div class="upload-ctrl-tips ui-pos" style="display:none"></div>\r\n\
                <div class="upload-body">\r\n\
                    <ul class="upload-files">\r\n\
                    </ul>\r\n\
                </div>\r\n\
            </div>');return __p.join("");},'upload_instance':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('\r\n\
      <li class="');_p(data.li_class);__p.push('">\r\n\
            <span class=\'file-ico ico-');_p(data.file_type);__p.push('\'></span>\r\n\
            <span class=\'upload-menu\'>\r\n\
                <span class="');_p(data.upload_state_click);__p.push('" title=\'');_p(data.upload_wording);__p.push('\' style="display:inline-block;"></span>\r\n\
                <span class="upload-del" data-action="click_cancel" title=\'取消\' style="display:none"></span>\r\n\
            </span>\r\n\
            <div class=\'fileinfo\'>\r\n\
                <div class=\'filedesc\'>\r\n\
                    <span class=\'filename\' title=\'');_p(data.full_name);__p.push('\'>');_p(data.file_name);__p.push('</span>\r\n\
                    <span class=\'filesize\'>(');_p(data.file_size);__p.push(')</span>\r\n\
                </div>\r\n\
                <div class=\'upload-info\'>\r\n\
                    <div class=\'ui-progbar ui-progbar-sh\'>\r\n\
                        <div class=\'ui-progbar-bg\'></div>\r\n\
                        <div class=\'ui-progbar-val-bg\'>\r\n\
                            <div class=\'ui-progbar-val\' style=\'width:0%;\'></div>\r\n\
                        </div>\r\n\
                     </div>\r\n\
                    <span class=\'upload-state loading-sh\'></span>\r\n\
                    <span class="upload-icon-sh"><span class="upload-icon loading"></span>上传中</span>\r\n\
                    <span class=\'upload-desc\'>\r\n\
                        <span class=\'upload-msg\'></span>\r\n\
                    </span>\r\n\
                </div>\r\n\
            </div>\r\n\
        </li>\r\n\
');return __p.join("");},'upload_rest':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    <div class="upload-rest">\r\n\
            <span class="upload-rest-num">\r\n\
                <strong class="rest_text"></strong>\r\n\
            </span>\r\n\
            <i class="icon-err" style="display:none"></i>\r\n\
    </div>');return __p.join("");},'view_switch':function(data){var __p=[],_p=function(s){__p.push(s)};__p.push('    ');var lib=require('lib'),$=require('$'),common=require('common'),click_tj=common.get('./configs.click_tj');cur_view=data.cur_view;__p.push('    <div class="viewmode" id="modechange">\r\n\
        <a data-view="newestlist" title="按时间排序" class="viewmode-item ');_p('newestlist'===cur_view?'current':'');__p.push('" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('SWITCH_NEWESTLIST_MODE'));__p.push('><i class="icon-date"></i><span>时间</span></a>\r\n\
        <a data-view="azlist" title="按A-Z顺序排序" class="viewmode-item ');_p('azlist'===cur_view?'current':'');__p.push('" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('SWITCH_AZLIST_MODE'));__p.push('><i class="icon-az"></i><span>列表</span></a>\r\n\
        <a data-view="grid" title="显示缩略图" class="viewmode-item ');_p('grid'===cur_view?'current':'');__p.push('" href="#" hidefocus="on" ');_p(click_tj.make_tj_str('SWITCH_NEWTHUMB_MODE'));__p.push('><i class="icon-thumb"></i><span>缩略图</span></a>\r\n\
    </div>');return __p.join("");}};return tmpl;});/*  |xGv00|380fd62589949b2390153d92df4aa847 */